<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Keqiçš„åšå®¢</title><link>https://keqiye.github.io/zh-cn/</link><description>Recent content on Keqiçš„åšå®¢</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><managingEditor>plloningye@gmail.com (Keqi Ye)</managingEditor><webMaster>plloningye@gmail.com (Keqi Ye)</webMaster><copyright>Example Person</copyright><lastBuildDate>Fri, 15 Aug 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://keqiye.github.io/zh-cn/index.xml" rel="self" type="application/rss+xml"/><item><title>åŸºäºç¨ å¯†å­˜å‚¨çš„å¹¶è¡Œæ ‘æ„å»ºå®ç°æ–¹æ¡ˆ</title><link>https://keqiye.github.io/zh-cn/posts/dense-tree-build/</link><pubDate>Fri, 15 Aug 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/dense-tree-build/</guid><description>&lt;h1 id="åŸºäºç¨ å¯†å­˜å‚¨çš„å¹¶è¡Œæ ‘æ„å»ºå®ç°æ–¹æ¡ˆ">åŸºäºç¨ å¯†å­˜å‚¨çš„å¹¶è¡Œæ ‘æ„å»ºå®ç°æ–¹æ¡ˆ
&lt;/h1>&lt;h2 id="å¼•è¨€">å¼•è¨€
&lt;/h2>&lt;p>åœ¨ç©ºé—´åˆ’åˆ†ä¸é‚»åŸŸæœç´¢ç­‰ç®—æ³•ä¸­ï¼Œæ ‘å½¢æ•°æ®ç»“æ„ï¼ˆå¦‚å…«å‰æ ‘ã€å››å‰æ ‘ã€Barnes-Hut æ ‘ï¼‰æ˜¯é«˜æ•ˆçš„åŠ é€Ÿæ‰‹æ®µã€‚&lt;br>
æ„å»ºè¿™ç±»æ ‘ç»“æ„æ—¶ï¼Œ&lt;strong>å­˜å‚¨æ–¹å¼&lt;/strong>æ˜¯å½±å“æ€§èƒ½ä¸å†…å­˜æ•ˆç‡çš„å…³é”®å› ç´ ä¹‹ä¸€ã€‚&lt;br>
å¸¸è§çš„å­˜å‚¨æ–¹å¼æœ‰ä¸¤ç§ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>ç¨€ç–å­˜å‚¨ï¼ˆSparse Storageï¼‰&lt;/strong>ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹é¢„ç•™è¾ƒå¤§ç´¢å¼•ç©ºé—´ï¼ŒæŒ‰éœ€å¡«å……ï¼Œæ˜“å®ç°ï¼Œä½†ä¼šæµªè´¹å†…å­˜ã€‚&lt;/li>
&lt;li>&lt;strong>ç¨ å¯†å­˜å‚¨ï¼ˆDense Storageï¼‰&lt;/strong>ï¼šèŠ‚ç‚¹å­˜å‚¨åœ¨è¿ç»­æ•°ç»„ä¸­ï¼ŒæŒ‰ç…§æ„å»ºé¡ºåºç´§å¯†æ’åˆ—ï¼ŒèŠ‚çœå†…å­˜ï¼Œä½†éœ€è¦é¢å¤–çš„ç®¡ç†é€»è¾‘ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä½ ä¹‹å‰çš„å®ç°é‡‡ç”¨äº†ç¨€ç–å­˜å‚¨ï¼Œåœ¨é«˜ç²’å­æ•°æ—¶å†…å­˜å ç”¨æ˜æ˜¾å¢åŠ ã€‚&lt;br>
æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•åŸºäºç¨ å¯†å­˜å‚¨å®ç°é«˜æ•ˆçš„æ ‘æ„å»ºï¼Œå¹¶ç»™å‡º CUDA å¹¶è¡Œç‰ˆæœ¬çš„å®ç°æ€è·¯ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="ç¨ å¯†å­˜å‚¨çš„åŸºæœ¬æ€æƒ³">ç¨ å¯†å­˜å‚¨çš„åŸºæœ¬æ€æƒ³
&lt;/h2>&lt;p>ç¨ å¯†å­˜å‚¨çš„ç›®æ ‡æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>èŠ‚ç‚¹æ•°ç»„ç´§å‡‘å­˜æ”¾ï¼Œä¸ç•™å¤§å—æœªä½¿ç”¨ç©ºé—´&lt;/li>
&lt;li>èŠ‚ç‚¹ç´¢å¼•ç›´æ¥æ˜ å°„åˆ°æ•°ç»„ä¸‹æ ‡&lt;/li>
&lt;li>åœ¨æ’å…¥æ–°èŠ‚ç‚¹æ—¶ï¼Œé€šè¿‡ä¸€ä¸ªå…¨å±€ &lt;strong>maxNodeIndex&lt;/strong> é€’å‡åˆ†é…æ–°ä½ç½®&lt;/li>
&lt;/ul>
&lt;p>è¿™ç§æ–¹æ³•ç±»ä¼¼â€œå€’ç€åˆ†é…â€èŠ‚ç‚¹ç©ºé—´ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">[ç²’å­0] [ç²’å­1] ... [ç²’å­N-1] [å†…éƒ¨èŠ‚ç‚¹M] [å†…éƒ¨èŠ‚ç‚¹M-1] ...
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>0 ~ numParticles-1&lt;/strong> åŒºé—´å­˜æ”¾å¶å­èŠ‚ç‚¹ï¼ˆç²’å­ï¼‰&lt;/li>
&lt;li>&lt;strong>numParticles ~ maxNodeIndex-1&lt;/strong> åŒºé—´å­˜æ”¾å†…éƒ¨èŠ‚ç‚¹&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="æ•°æ®ç»“æ„è®¾è®¡">æ•°æ®ç»“æ„è®¾è®¡
&lt;/h2>&lt;p>åœ¨ç¨ å¯†å­˜å‚¨ä¸­ï¼Œæ ¸å¿ƒæ•°æ®ç»“æ„é€šå¸¸åŒ…æ‹¬ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// ç²’å­æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Particles&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// åæ ‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// è´¨é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ax&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">ay&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">az&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// åŠ é€Ÿåº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">depth&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// æ ‘æ·±åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// æ ‘èŠ‚ç‚¹ä¿¡æ¯
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="k">struct&lt;/span> &lt;span class="nc">Tree&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">volatile&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// èŠ‚ç‚¹ä¸­å¿ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">volatile&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">m&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// èŠ‚ç‚¹åŠå¾„ï¼ˆæˆ–è´¨é‡ç­‰ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">childList&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// å­˜å‚¨å­èŠ‚ç‚¹ç´¢å¼•
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="n">maxNodeIndex&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// å½“å‰å¯åˆ†é…çš„æœ€å¤§ç´¢å¼•ï¼ˆé€’å‡ï¼‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="p">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;strong>å…³é”®ç‚¹&lt;/strong>ï¼š&lt;code>childList&lt;/code> æ˜¯ä¸€ç»´æ•°ç»„ï¼Œé€šè¿‡ &lt;code>childListIndex(nodeIndex, childSlot)&lt;/code> æ˜ å°„åˆ°èŠ‚ç‚¹çš„ç¬¬å‡ ä¸ªå­èŠ‚ç‚¹ä½ç½®ã€‚è¿™æ ·å­˜å‚¨æ–¹å¼å¤©ç„¶ç´§å‡‘ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="æ„å»ºæµç¨‹è¯¦è§£">æ„å»ºæµç¨‹è¯¦è§£
&lt;/h2>&lt;p>ç¨ å¯†å­˜å‚¨çš„æ„å»ºé€»è¾‘å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>åˆå§‹åŒ–æ ¹èŠ‚ç‚¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>æ ¹èŠ‚ç‚¹ç´¢å¼•ä¸º &lt;code>numNodes-1&lt;/code>ï¼ˆæ•°ç»„æœ«å°¾ï¼‰&lt;/li>
&lt;li>ä¿å­˜ä¸­å¿ƒåæ ‡å’ŒåŠå¾„&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>éå†ç²’å­&lt;/strong>ï¼ˆå¹¶è¡Œï¼‰&lt;/p>
&lt;ul>
&lt;li>æ¯ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªç²’å­ï¼Œæ­¥é•¿ä¸º &lt;code>blockDim.x * gridDim.x&lt;/code>&lt;/li>
&lt;li>ç¼“å­˜ç²’å­åæ ‡ï¼ŒåŠ é€Ÿæ¯”è¾ƒ&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ä¸‹è¡ŒæŸ¥æ‰¾æ’å…¥ä½ç½®&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œåˆ¤æ–­ç²’å­å±äºå“ªä¸ªå­è±¡é™ï¼ˆå…«å‰æ ‘ä¸­ 0~7ï¼‰&lt;/li>
&lt;li>å¦‚æœå­èŠ‚ç‚¹æ˜¯å†…éƒ¨èŠ‚ç‚¹ï¼Œç»§ç»­ä¸‹è¡Œ&lt;/li>
&lt;li>å¦‚æœå­èŠ‚ç‚¹æ˜¯ç©ºçš„ï¼Œç›´æ¥æ’å…¥ç²’å­&lt;/li>
&lt;li>å¦‚æœå­èŠ‚ç‚¹æ˜¯å¦ä¸€ä¸ªç²’å­ï¼Œåˆ›å»ºæ–°çš„å†…éƒ¨èŠ‚ç‚¹&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>åˆ›å»ºæ–°å†…éƒ¨èŠ‚ç‚¹&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>ä½¿ç”¨ &lt;code>atomicSub&lt;/code> ä» &lt;code>maxNodeIndex&lt;/code> åˆ†é…æ–°çš„èŠ‚ç‚¹ç´¢å¼•&lt;/li>
&lt;li>è®¡ç®—æ–°èŠ‚ç‚¹çš„ä¸­å¿ƒå’ŒåŠå¾„&lt;/li>
&lt;li>å°†å·²æœ‰ç²’å­ä¸æ–°ç²’å­åˆ†åˆ«æ’å…¥åˆ°ä¸åŒçš„å­æ§½ä¸­&lt;/li>
&lt;li>å¦‚æœä¸¤è€…ä»è½åœ¨åŒä¸€ä¸ªæ§½å†…ï¼Œç»§ç»­ç»†åˆ†&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>è§£é”ä¸åŒæ­¥&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>é€šè¿‡ &lt;code>atomicCAS&lt;/code> å®ç°æ’å…¥ä½ç½®çš„åŸå­é”å®š&lt;/li>
&lt;li>ä½¿ç”¨ &lt;code>__threadfence()&lt;/code> ç¡®ä¿å†…å­˜å¯è§æ€§&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;hr>
&lt;h2 id="æ ¸å¿ƒä»£ç ç‰‡æ®µ">æ ¸å¿ƒä»£ç ç‰‡æ®µ
&lt;/h2>&lt;p>ä¸‹é¢æ˜¯ç®€åŒ–ç‰ˆçš„ç¨ å¯†å­˜å‚¨èŠ‚ç‚¹åˆ†é…é€»è¾‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">child&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">atomicCAS&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">lockedIndex&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">child&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">LOCKED&lt;/span>&lt;span class="p">))&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">child&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">EMPTY&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">lockedIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">particleIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆ†é…æ–°èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">newNodeIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">atomicSub&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">maxNodeIndex&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¾ç½®æ–°èŠ‚ç‚¹ä¸­å¿ƒä¸åŠå¾„
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">px&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">currentX&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">py&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">currentY&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dy&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pz&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">currentZ&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dz&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">pm&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">r&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="mf">0.5&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// åˆå§‹åŒ–å­èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">numChildren&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">childListIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">EMPTY&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å°†æ—§ç²’å­å’Œæ–°ç²’å­åˆ†åˆ«æ”¾å…¥ä¸åŒæ§½
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">childListIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">oldChildSlot&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">oldParticle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">childListIndex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">newChildSlot&lt;/span>&lt;span class="p">)]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newParticle&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__threadfence&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">childList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">lockedIndex&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">newNodeIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;hr>
&lt;h2 id="å¹¶å‘ä¸åŒæ­¥">å¹¶å‘ä¸åŒæ­¥
&lt;/h2>&lt;p>ç”±äºå¤šçº¿ç¨‹åŒæ—¶æ„å»ºæ ‘ï¼Œå¿…é¡»ä¿è¯ä»¥ä¸‹ä¸¤ç‚¹ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>åŸå­æ“ä½œ&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>atomicCAS&lt;/code>ï¼ˆCompare And Swapï¼‰é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶æ’å…¥åŒä¸€ä½ç½®&lt;/li>
&lt;li>&lt;code>atomicSub&lt;/code> åˆ†é…æ–°èŠ‚ç‚¹ç´¢å¼•&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å†…å­˜åŒæ­¥&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>&lt;code>__threadfence()&lt;/code> ç¡®ä¿å…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°å·²æ›´æ–°çš„èŠ‚ç‚¹æ•°æ®&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>&lt;strong>æ³¨æ„&lt;/strong>ï¼šç¨ å¯†å­˜å‚¨çš„èŠ‚ç‚¹æ•°ç»„åœ¨åˆ†é…æ—¶æ˜¯å€’ç€ä½¿ç”¨çš„ï¼Œæ‰€ä»¥ä¸ä¼šå’Œç²’å­ç´¢å¼•å†²çªã€‚&lt;/p>
&lt;hr>
&lt;h2 id="æ€§èƒ½åˆ†æä¸ä¼˜åŒ–å»ºè®®">æ€§èƒ½åˆ†æä¸ä¼˜åŒ–å»ºè®®
&lt;/h2>&lt;p>&lt;strong>ä¼˜ç‚¹&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>å†…å­˜å ç”¨å¤§å¹…å‡å°‘ï¼ˆåªå­˜å®é™…å­˜åœ¨çš„èŠ‚ç‚¹ï¼‰&lt;/li>
&lt;li>ç´¢å¼•ç´§å‡‘ï¼Œç¼“å­˜å‘½ä¸­ç‡é«˜&lt;/li>
&lt;li>éå†æ•ˆç‡æå‡&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç¼ºç‚¹&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>èŠ‚ç‚¹åˆ†é…ä¾èµ– &lt;code>atomicSub&lt;/code>ï¼Œåœ¨æé«˜å¹¶å‘ä¸‹å¯èƒ½æˆä¸ºç“¶é¢ˆ&lt;/li>
&lt;li>å®ç°å¤æ‚åº¦é«˜äºç¨€ç–å­˜å‚¨&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ä¼˜åŒ–æ–¹å‘&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>æ‰¹é‡åˆ†é…èŠ‚ç‚¹ç´¢å¼•ï¼Œå‡å°‘ &lt;code>atomicSub&lt;/code> æ¬¡æ•°&lt;/li>
&lt;li>åˆå¹¶é”ä¸èŠ‚ç‚¹å†™å…¥æ­¥éª¤ï¼Œå‡å°‘åŸå­æ“ä½œå†²çª&lt;/li>
&lt;li>åœ¨å…±äº«å†…å­˜ä¸­ç¼“å­˜éƒ¨åˆ†å­èŠ‚ç‚¹&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h2 id="æ€»ç»“ä¸åº”ç”¨åœºæ™¯">æ€»ç»“ä¸åº”ç”¨åœºæ™¯
&lt;/h2>&lt;p>ç¨ å¯†å­˜å‚¨ç‰¹åˆ«é€‚åˆï¼š&lt;/p>
&lt;ul>
&lt;li>ç²’å­æ•°é‡å¤§ã€ç©ºé—´åˆ†å¸ƒå‡åŒ€çš„æ¨¡æ‹Ÿï¼ˆå¦‚ SPHã€N-bodyï¼‰&lt;/li>
&lt;li>å¯¹å†…å­˜å ç”¨æ•æ„Ÿçš„ GPU åº”ç”¨&lt;/li>
&lt;li>éœ€è¦é¢‘ç¹é‡å»ºæ ‘ç»“æ„çš„å®æ—¶è®¡ç®—&lt;/li>
&lt;/ul>
&lt;p>ä¸ç¨€ç–å­˜å‚¨ç›¸æ¯”ï¼Œç¨ å¯†å­˜å‚¨åœ¨ GPU ç¯å¢ƒä¸‹é€šå¸¸èƒ½è·å¾—æ›´é«˜çš„æ€§èƒ½ä¸æ›´ä½çš„å†…å­˜æ¶ˆè€—ï¼Œå°¤å…¶æ˜¯åœ¨èŠ‚ç‚¹æ•°é‡æ¥è¿‘ç²’å­æ•°é‡æ—¶ä¼˜åŠ¿æ˜æ˜¾ã€‚&lt;/p>
&lt;hr>
&lt;p>&lt;strong>å‚è€ƒå®ç°&lt;/strong>ï¼šæœ¬æ–‡çš„æ„å»ºæ€è·¯æºè‡ª CUDA å¹¶è¡Œ Barnes-Hut æ ‘æ„å»ºçš„å¸¸è§æ¨¡å¼ï¼Œå¹¶ç»“åˆäº†ä½ çš„åŸå§‹ä»£ç è¿›è¡Œç¨ å¯†åŒ–å¤„ç†ã€‚&lt;/p></description></item><item><title>SPH æ ¸å‡½æ•°</title><link>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph2/</link><pubDate>Sun, 25 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph2/</guid><description>&lt;p>åœ¨ SPH æ–¹æ³•ä¸­ï¼Œ**æ ¸å‡½æ•°ï¼ˆKernel Functionï¼‰**æ˜¯æ ¸å¿ƒç»„æˆéƒ¨åˆ†ä¹‹ä¸€ï¼Œç”¨äºè¿›è¡Œç‰©ç†é‡çš„å¹³æ»‘é€¼è¿‘ã€‚æ¢å¥è¯è¯´ï¼ŒSPHæ ¸å¿ƒåŠŸèƒ½å°±æ˜¯å°†åå¾®åˆ†æ–¹ç¨‹é€šè¿‡æ ¸å‡½æ•°è¿‘ä¼¼
è½¬æ¢ä¸ºå¸¸å¾®åˆ†æ–¹ç¨‹ï¼Œéšåä½¿ç”¨æ—¶é—´ç§¯åˆ†è§£å†³ã€‚&lt;/p>
&lt;h1 id="æ•°å­¦å®šä¹‰ä¸-sph-æ ¸æ’å€¼">æ•°å­¦å®šä¹‰ä¸ SPH æ ¸æ’å€¼
&lt;/h1>&lt;p>æ ¹æ®ç‹„æ‹‰å…‹å‡½æ•° \( \delta \) çš„å®šä¹‰ï¼Œä»»æ„å‡½æ•° \( f(\mathbf{r}) \) å¯è¡¨ç¤ºä¸ºï¼š&lt;/p>
$$
f(\mathbf{r}) = \int f(\mathbf{r}') \, \delta(\mathbf{r} - \mathbf{r}') \, d\mathbf{r}'
$$
&lt;p>å½“ \( f(\mathbf{r}) \) åœ¨ç§¯åˆ†åŒºåŸŸå†…è¿ç»­æ—¶ï¼Œè¯¥è¡¨è¾¾å¼ä¸¥æ ¼æˆç«‹ã€‚&lt;/p>
&lt;hr>
&lt;h2 id="sph-ä¸­çš„å¹³æ»‘é€¼è¿‘">SPH ä¸­çš„å¹³æ»‘é€¼è¿‘
&lt;/h2>&lt;p>åœ¨æ— ç½‘æ ¼æ–¹æ³• SPHï¼ˆSmoothed Particle Hydrodynamicsï¼‰ä¸­ï¼Œæˆ‘ä»¬ç”¨å…·æœ‰ç´§æ”¯æ’‘çš„æ ¸å‡½æ•° \( W(\mathbf{r} - \mathbf{r}', h) \) æ›¿ä»£ç‹„æ‹‰å…‹å‡½æ•°ï¼Œå…¶ä¸­ \( h \) ä¸ºå¹³æ»‘é•¿åº¦ï¼ˆæ”¯æŒåŠå¾„ï¼‰ï¼Œå¾—åˆ°å‡½æ•°çš„å¹³æ»‘é€¼è¿‘ï¼š&lt;/p>
$$
f(\mathbf{r}) = \int f(\mathbf{r}') \, W(\mathbf{r} - \mathbf{r}', h) \, d\mathbf{r}'
$$
&lt;p>
æ ¸å‡½æ•° \( W(\mathbf{r} - \mathbf{r}', h) \) ä¸€èˆ¬ä¼šå…·æœ‰å¦‚ä¸‹ç‰¹ç‚¹&lt;/p>
&lt;h3 id="1-æ­£åˆ™åŒ–æ¡ä»¶å½’ä¸€æ€§">1. æ­£åˆ™åŒ–æ¡ä»¶ï¼ˆå½’ä¸€æ€§ï¼‰
&lt;/h3>&lt;p>æ ¸å‡½æ•°åœ¨æ•´ä¸ªç©ºé—´ä¸Šçš„ç§¯åˆ†åº”ä¸º 1ï¼Œä»¥ä¿è¯ç‰©ç†é‡å®ˆæ’ï¼š&lt;/p>
$$
\int W(\mathbf{r} - \mathbf{r}', h) \, d\mathbf{r}' = 1
$$
&lt;p>è¿™å¯¹åº”äºç‹„æ‹‰å…‹å‡½æ•°çš„å½’ä¸€åŒ–æ€§è´¨ï¼š&lt;/p>
$$
\int \delta(\mathbf{r} - \mathbf{r}') \, d\mathbf{r}' = 1
$$
&lt;hr>
&lt;h3 id="2-æ”¶æ•›æ€§delta-å‡½æ•°æé™">2. æ”¶æ•›æ€§ï¼ˆDelta å‡½æ•°æé™ï¼‰
&lt;/h3>&lt;p>å½“å¹³æ»‘é•¿åº¦ \( h \to 0 \) æ—¶ï¼Œæ ¸å‡½æ•°åº”è¶‹è¿‘äºç‹„æ‹‰å…‹å‡½æ•°ï¼š&lt;/p>
$$
\lim_{h \to 0} W(\mathbf{r} - \mathbf{r}', h) = \delta(\mathbf{r} - \mathbf{r}')
$$
&lt;p>è¿™è¡¨ç¤ºæ ¸å‡½æ•°çš„é€¼è¿‘åœ¨ç†è®ºä¸Šæ˜¯æ”¶æ•›çš„ï¼Œä¸”æ ¸æ’å€¼åœ¨æ— é™åˆ†è¾¨ç‡ä¸‹æ˜¯ç²¾ç¡®çš„ã€‚&lt;/p>
&lt;hr>
&lt;h3 id="3-ç´§æ”¯æ€§æœ‰é™æ”¯æŒåŸŸ">3. ç´§æ”¯æ€§ï¼ˆæœ‰é™æ”¯æŒåŸŸï¼‰
&lt;/h3>&lt;p>æ ¸å‡½æ•°åœ¨è·ç¦»è¶…è¿‡æŸä¸ªèŒƒå›´ \( kh \) ååº”ä¸ºé›¶ï¼š&lt;/p>
$$
W(\mathbf{r} - \mathbf{r}', h) = 0 \quad \text{å½“} \quad |\mathbf{r} - \mathbf{r}'| > kh
$$
&lt;p>å…¶ä¸­å¸¸æ•° \( k \) ä¸€èˆ¬ä¸º 2 æˆ– 3ï¼Œå–å†³äºæ ¸å‡½æ•°çš„ç±»å‹ã€‚è¿™ä¸€æ€§è´¨ä½¿å¾—æ¯ä¸ªç²’å­çš„å½±å“èŒƒå›´æ˜¯æœ‰é™çš„ï¼Œä¾¿äºé«˜æ•ˆå®ç°é‚»åŸŸæœç´¢å’Œå¹¶è¡Œè®¡ç®—ã€‚&lt;/p>
&lt;hr>
&lt;p>å°†ç§¯åˆ†åŒºåŸŸç¦»æ•£åŒ–ä¸ºç²’å­ç³»ç»Ÿï¼Œä»¤ä½“ç§¯å…ƒ \( d\mathbf{r}' \approx V_j = \frac{m_j}{\rho_j} \)ï¼Œå¾—ï¼š&lt;/p>
$$
f(\mathbf{r}_i) = \sum_j f(\mathbf{r}_j) \frac{m_j}{\rho_j} \, W(\mathbf{r}_i - \mathbf{r}_j, h)
$$
&lt;p>è¿™å°±æ˜¯ SPH çš„&lt;strong>æ ¸æ’å€¼å…¬å¼&lt;/strong>ã€‚å…¶æœ¬è´¨æ˜¯åˆ©ç”¨æ ¸å‡½æ•°åœ¨æ”¯æŒåŸŸå†…å¯¹é‚»è¿‘ç²’å­çš„ç‰©ç†é‡è¿›è¡ŒåŠ æƒå¹³å‡ï¼Œé€¼è¿‘è¿ç»­åœºã€‚&lt;/p>
&lt;p>å¯¹æ•£åº¦ç®—å­è¿›è¡Œç²’å­è¿‘ä¼¼å¯å¾—ï¼š&lt;/p>
$$
\langle \nabla \cdot f(x_i) \rangle = -\sum_{j=1}^{N} \frac{m_j}{\rho_j} f(x_j) \cdot \nabla W_{ij}, \tag{1}
$$
&lt;p>å…¶ä¸­æ ¸å‡½æ•°æ¢¯åº¦ä¸ºï¼š&lt;/p>
$$
\nabla_i W_{ij} = \frac{x_i - x_j}{r_{ij}} \frac{\partial W_{ij}}{\partial r_{ij}} = \frac{x_{ij}}{r_{ij}} \frac{\partial W_{ij}}{\partial r_{ij}}. \tag{2}
$$
&lt;p>æ³¨æ„ï¼Œæ ¸å‡½æ•° $W_{ij} = W(\mathbf{r_i} - \mathbf{r_j}, h)$ æ˜¯å…³äº $\mathbf{r_j}$ çš„å‡½æ•°ï¼Œå› æ­¤å¼(1)ä¸­å¤šäº†ä¸€ä¸ªè´Ÿå·ã€‚&lt;/p>
&lt;h2 id="å¸¸è§æ ¸å‡½æ•°åŠå…¶å¯¼æ•°">å¸¸è§æ ¸å‡½æ•°åŠå…¶å¯¼æ•°
&lt;/h2>&lt;p>SPH ä¸­å¸¸ç”¨çš„æ ¸å‡½æ•°åŒ…æ‹¬ä»¥ä¸‹å‡ ç±»ï¼š&lt;/p>
&lt;h3 id="ä¸‰æ¬¡æ ·æ¡æ ¸å‡½æ•°-cubic-spline-kernel">ä¸‰æ¬¡æ ·æ¡æ ¸å‡½æ•° (Cubic Spline Kernel)
&lt;/h3>&lt;p>æ ¸å‡½æ•°å®šä¹‰ï¼š&lt;/p>
$$
\begin{align*}
W(R,h) = \alpha_d \times
\begin{cases}
\frac{2}{3} - R^2 + \frac{1}{2}R^3, &amp; 0 \leq R &lt; 1; \\
\frac{1}{6}(2-R)^3, &amp; 1 \leq R &lt; 2; \\
0, &amp; R \geq 2.
\end{cases}
\end{align*}
$$
&lt;p>å…¶ä¸­ $R = \frac{r}{h}$ï¼Œ$r$ æ˜¯ç²’å­é—´è·ç¦»ï¼Œ$h$ æ˜¯å…‰æ»‘é•¿åº¦ï¼Œ$\alpha_d$ æ˜¯ç»´åº¦å½’ä¸€åŒ–å¸¸æ•°ï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸€ç»´ï¼š$\alpha_d = \frac{1}{h}$&lt;/li>
&lt;li>äºŒç»´ï¼š$\alpha_d = \frac{15}{7\pi h^2}$&lt;/li>
&lt;li>ä¸‰ç»´ï¼š$\alpha_d = \frac{3}{2\pi h^3}$&lt;/li>
&lt;/ul>
&lt;p>æ ¸å‡½æ•°å¯¼æ•°ï¼š&lt;/p>
$$
\frac{dW}{dR} = \alpha_d \times
\begin{cases}
-2R + \frac{3}{2}R^2, &amp; 0 \leq R &lt; 1; \\
-\frac{1}{2}(2-R)^2, &amp; 1 \leq R &lt; 2; \\
0, &amp; R \geq 2.
\end{cases}
$$</description></item><item><title>SPH ç®€ä»‹</title><link>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph1/</link><pubDate>Sun, 25 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph1/</guid><description>&lt;p>åœ¨æœ¬ç³»åˆ—åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ç³»ç»Ÿä»‹ç»å…‰æ»‘ç²’å­æµä½“åŠ¨åŠ›å­¦ï¼ˆSmoothed Particle Hydrodynamics, ç®€ç§° SPHï¼‰æ–¹æ³•ã€‚&lt;br>
SPH æ˜¯ä¸€ç§æ— ç½‘æ ¼æ‹‰æ ¼æœ—æ—¥æ–¹æ³•ï¼Œå¹¿æ³›ç”¨äºæ¨¡æ‹Ÿè¿ç»­ä»‹è´¨å¦‚æµä½“ã€å›ºä½“ã€å¤©ä½“ç‰©ç†ç­‰é—®é¢˜ã€‚&lt;/p>
&lt;p>æˆ‘ä»¬å°†ä»åŸºæœ¬åŸç†å‡ºå‘ï¼Œé€æ­¥è®²è§£é‚»åŸŸæœç´¢ã€æ ¸å‡½æ•°ã€çŠ¶æ€æ–¹ç¨‹ã€ç²˜æ€§é¡¹ã€æ—¶é—´ç§¯åˆ†å™¨ç­‰å†…å®¹ï¼Œå¹¶ç»“åˆ CUDA å¹¶è¡ŒåŠ é€Ÿå®ç°ã€‚&lt;/p>
&lt;p>æœ¬ç¯‡ä¸ºç³»åˆ—å¯¼è¯»ï¼Œåç»­å°†æŒç»­æ›´æ–°ã€‚&lt;/p></description></item><item><title>SPH çŠ¶æ€æ–¹ç¨‹</title><link>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph3/</link><pubDate>Sun, 25 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/sphseries/blog-post-sph3/</guid><description>&lt;p>åœ¨ SPH æ–¹æ³•ä¸­ï¼ŒçŠ¶æ€æ–¹ç¨‹ï¼ˆEquation of State, EOSï¼‰ç”¨äºå°†ç²’å­çš„å¯†åº¦ä¸å‹å¼ºå»ºç«‹è”ç³»ï¼Œè¿›è€Œè®¡ç®—ä½œç”¨äºç²’å­é—´çš„åŠ›ã€‚&lt;/p>
&lt;p>æœ€å¸¸ç”¨çš„çŠ¶æ€æ–¹ç¨‹æ˜¯ Tait æ–¹ç¨‹ï¼Œå…¶å½¢å¼ä¸ºï¼š&lt;/p>
$$
P = B\left[\left(\frac{\rho}{\rho_0}\right)^\gamma - 1\right]
$$
&lt;p>å…¶ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>\( \rho \) ä¸ºå½“å‰å¯†åº¦ï¼Œ&lt;/li>
&lt;li>\( \rho_0 \) ä¸ºå‚è€ƒå¯†åº¦ï¼Œ&lt;/li>
&lt;li>\( \gamma \) ä¸ºå¤šé¡¹å¼æŒ‡æ•°ï¼ˆé€šå¸¸ä¸º 7ï¼‰ï¼Œ&lt;/li>
&lt;li>\( B \) ä¸ºå¸¸æ•°ï¼Œå†³å®šå‹ç¼©æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>åˆç†é€‰å– EOS å‚æ•°å¯¹äºæ¨¡æ‹Ÿç»“æœçš„ç¨³å®šæ€§å’Œå‡†ç¡®æ€§è‡³å…³é‡è¦ã€‚&lt;/p></description></item><item><title>7 Step Optimization of Parallel Reduction with CUDA</title><link>https://keqiye.github.io/zh-cn/posts/parallel-reduction-with-cuda/blog-parallel-reduction-with-cuda/</link><pubDate>Thu, 22 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/parallel-reduction-with-cuda/blog-parallel-reduction-with-cuda/</guid><description>&lt;h2 id="å†™åœ¨å‰é¢">å†™åœ¨å‰é¢
&lt;/h2>&lt;blockquote>
&lt;p>ğŸ“š &lt;strong>ç‰ˆæƒå£°æ˜ | Copyright Notice&lt;/strong>&lt;/p>
&lt;p>æœ¬æ–‡å†…å®¹å‚è€ƒå¹¶éƒ¨åˆ†ç¿»è¯‘è‡ªä»¥ä¸‹ä¸¤ç¯‡èµ„æ–™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://developer.download.nvidia.com/assets/cuda/files/reduction.pdf" target="_blank" rel="noopener"
>NVIDIA å®˜æ–¹ PPTï¼ˆreduction.pdfï¼‰&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://medium.com/@rimikadhara/7-step-optimization-of-parallel-reduction-with-cuda-33a3b2feafd8" target="_blank" rel="noopener"
>Medium åšå®¢ï¼š7 Step Optimization of Parallel Reduction with CUDA&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>ä¸Šè¿°èµ„æ–™ç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰ã€‚æœ¬æ–‡æ—¨åœ¨å­¦ä¹ å’ŒæŠ€æœ¯ä¼ æ’­ï¼Œä»…ä¾›ä¸ªäººå’Œå­¦æœ¯ä½¿ç”¨ã€‚å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»åˆ é™¤ã€‚&lt;/p>
&lt;p>This article is a study and partial translation based on the works above. All rights belong to the original authors. The content is shared for learning and research purposes only. Please contact for removal if there is any infringement.&lt;/p>
&lt;/blockquote>
&lt;p>âš ï¸ &lt;strong>è‹¥ä¸Šè¿°é“¾æ¥å¤±æ•ˆ&lt;/strong>ï¼Œè¯»è€…å¯ä»¥åœ¨ Google ä¸­ä½¿ç”¨å…³é”®è¯æŸ¥æ‰¾ï¼š&lt;br>
&lt;code>7 Step Optimization of Parallel Reduction with CUDA&lt;/code>&lt;/p>
&lt;p>æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä¼˜åŒ– CUDA ä¸­çš„å¹¶è¡Œè§„çº¦ç®—æ³• (Parallel Reduction)ï¼Œå¹¶é€šè¿‡ä¸ƒä¸ªæ­¥éª¤é€æ­¥æå‡æ€§èƒ½ã€‚å°½ç®¡ä¸Šè¿°é“¾æ¥ä¸­ä½œè€…å·²ç»è¯´æ˜çš„ååˆ†æ¸…æ¥šã€‚æˆ‘è¿™é‡Œè¿˜æ˜¯ä¼šä½¿ç”¨ä¸­æ–‡å†èµ°ä¸€è¾¹æµç¨‹ï¼Œä¸€æ¥ä¸ºä¸­æ–‡äº’è”ç½‘æä¾›å‚è€ƒèµ„æ–™ï¼ŒäºŒæ¥ä¸ºæˆ‘è‡ªå·±å­¦ä¹ ã€‚&lt;/p>
&lt;p>CUDAå¹¶è¡Œä»£ç ä¸ä¸²è¡Œä»£ç çš„æ•´ä½“è®¾è®¡æ€è·¯ç›¸å·®å¾ˆå¤§ï¼Œè™½ç„¶æ˜¯æŒ‰ç…§çº¿ç¨‹æ¥ç¼–å†™ï¼Œä½†æ˜¯è¦ä»Blockå±‚é¢å»æ€è€ƒå’Œè®¾è®¡ã€‚&lt;/p>
&lt;h2 id="ä»€ä¹ˆæ˜¯-parallel-reduction-ç®—æ³•">ä»€ä¹ˆæ˜¯ Parallel Reduction ç®—æ³•ï¼Ÿ
&lt;/h2>&lt;p>è®©æˆ‘ä»¬é¦–å…ˆäº†è§£ä¸€ä¸‹ Parallel Reduction ç®—æ³•çš„åŸºæœ¬æ¦‚å¿µã€‚å®ƒæ˜¯ä¸€ç§ &lt;strong>æ•°æ®å¹¶è¡ŒåŸè¯­&lt;/strong>ï¼Œåœ¨ CUDA ä¸­å®ç°ç›¸å¯¹ç›´æ¥ã€‚ç®€å•æ¥è¯´ï¼ŒParallel Reduction çš„ç›®æ ‡æ˜¯é€šè¿‡ GPU çš„çº¿ç¨‹å±‚çº§ç»“æ„å¹¶è¡Œåœ°å¯¹å‘é‡ã€çŸ©é˜µæˆ–å¼ é‡è¿›è¡Œå½’çº¦æ“ä½œã€‚&lt;/p>
&lt;p>è¿™ç§å½’çº¦æ˜¯é€šè¿‡å¦‚ &lt;code>sum()&lt;/code>ã€&lt;code>min()&lt;/code>ã€&lt;code>max()&lt;/code> æˆ– &lt;code>avg()&lt;/code> ç­‰æ“ä½œæ¥å®ç°çš„ï¼Œç”¨äºå¯¹æ•°æ®è¿›è¡Œèšåˆä¸ç®€åŒ–ã€‚äº‹å®ä¸Šï¼Œå¯¹ä¸€ä¸ªæ•°ç»„æ±‚ä¸Šè¿°æ“ä½œæ˜¯ååˆ†ç®€å•çš„ï¼Œå¦‚æœæƒ³å®ç° CUDA å¹¶è¡Œï¼Œæ ¸å¿ƒéš¾åº¦åœ¨äºè®¿å­˜è®¾è®¡ã€‚è‹¥å¤„ç†ä¸å½“ï¼Œå³ä½¿æ˜¯è¿™äº›â€œçœ‹ä¼¼ç®€å•â€çš„è®¡ç®—ä¹Ÿå¯èƒ½å˜å¾—è€—æ—¶ã€‚&lt;/p>
&lt;p>é«˜æ•ˆå®ç° Parallel Reduction çš„ä¸€ä¸ªåŸå› æ˜¯å®ƒä»¬éå¸¸é€šç”¨ï¼Œå¹¶åœ¨è®¸å¤šåº”ç”¨ä¸­èµ·ç€å…³é”®ä½œç”¨ã€‚æˆ‘ä¸»è¦ä½¿ç”¨SPHç ”ç©¶å°è¡Œæ˜Ÿæ’å‡»ï¼Œæ¯ä¸€æ­¥SPHæ±‚è§£è¿‡ç¨‹ä¸­ï¼Œéƒ½éœ€è¦è¿›è¡ŒåŒ…å›´ç›’è®¡ç®—ï¼Œå¯¹åº”ç€ &lt;code>min()&lt;/code>ã€&lt;code>max()&lt;/code> æ“ä½œã€‚&lt;/p>
&lt;h3 id="æ ‘å½¢å½’çº¦æ¨¡å‹tree-based-reduction">æ ‘å½¢å½’çº¦æ¨¡å‹ï¼ˆTree-based Reductionï¼‰
&lt;/h3>&lt;p>å¹¶è¡Œå½’çº¦å¯ä»¥è¢«ç±»æ¯”ä¸ºä¸€ç§â€œæ ‘çŠ¶å½’çº¦â€ï¼ˆtree-based reductionï¼‰è¿‡ç¨‹ï¼šæ•°æ®åœ¨å„çº¿ç¨‹å—ï¼ˆthread blockï¼‰ä¹‹é—´é€å±‚å½’çº¦ã€‚&lt;/p>
&lt;p>ä½†è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªå…³é”®é—®é¢˜ï¼š&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>æˆ‘ä»¬å¦‚ä½•åœ¨ä¸åŒçº¿ç¨‹å—ä¹‹é—´ä¼ é€’ä¸­é—´ç»“æœï¼Ÿ&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>æœ€ç›´æ¥çš„æƒ³æ³•æ˜¯ä½¿ç”¨â€œå…¨å±€åŒæ­¥ï¼ˆglobal synchronizationï¼‰â€ â€”â€” å…ˆè®©æ¯ä¸ªçº¿ç¨‹å—å®Œæˆä¸€éƒ¨åˆ†è®¡ç®—ï¼Œç„¶åè¿›è¡Œå…¨å±€åŒæ­¥å¹¶ç»§ç»­é€’å½’å¤„ç†ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼ŒCUDA &lt;strong>å¹¶ä¸æ”¯æŒå…¨å±€åŒæ­¥&lt;/strong>ï¼Œå› ä¸ºè¿™åœ¨ç¡¬ä»¶ä¸Šå¼€é”€æå¤§ï¼Œè¿˜å¯èƒ½å¯¼è‡´æ­»é”ï¼Œåªèƒ½ä½¿ç”¨å°‘é‡çº¿ç¨‹å—ï¼Œé™åˆ¶æ€§èƒ½æå‡ã€‚&lt;/p>
&lt;p>ğŸ“Œ &lt;strong>æ›´å®ç”¨çš„æ–¹æ¡ˆæ˜¯ï¼šKernel åˆ†è§£ï¼ˆKernel Decompositionï¼‰&lt;/strong>&lt;/p>
&lt;h3 id="kernel-åˆ†è§£kernel-decomposition">Kernel åˆ†è§£ï¼ˆKernel Decompositionï¼‰
&lt;/h3>&lt;p>ä¸ºäº†æ›´é«˜æ•ˆåœ°ä¼ é€’çº¿ç¨‹å—é—´çš„ä¸­é—´ç»“æœï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå¤§çš„ kernel æ‹†åˆ†ä¸ºå¤šä¸ªå° kernelã€‚è¿™ç§åšæ³•è¢«ç§°ä¸º &lt;strong>Kernel åˆ†è§£&lt;/strong>ã€‚&lt;/p>
&lt;p>&lt;img src="https://keqiye.github.io/images/tree-reduction.png"
loading="lazy"
alt="Tree-based Reduction"
>&lt;/p>
&lt;p>Kernel åˆ†è§£çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>å‡å°‘ç¡¬ä»¶ä¸è½¯ä»¶å¼€é”€&lt;/li>
&lt;li>æé«˜èµ„æºåˆ©ç”¨ç‡&lt;/li>
&lt;li>é¿å…çº¿ç¨‹å—é—´åŒæ­¥&lt;/li>
&lt;li>æå‡æ•´ä½“æ‰§è¡Œæ•ˆç‡&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="æ³¨æ„">æ³¨æ„ï¼
&lt;/h3>&lt;p>æœ¬æ–‡é‡ç‚¹è®²è§£è§„çº¦ï¼ˆreductionï¼‰çš„åŸºæœ¬æ€æƒ³ï¼Œè€Œéå®Œæ•´çš„æœ€ç»ˆå®ç°ã€‚å› æ­¤ï¼Œæ¯ä¸ª kernel çš„æ‰§è¡Œç»“æœå¹¶ä¸æ˜¯ä¸€ä¸ªå…¨å±€å•ä¸€å€¼ï¼Œè€Œæ˜¯ &lt;strong>æ¯ä¸ª block å†…éƒ¨çš„è§„çº¦ç»“æœ&lt;/strong>ã€‚&lt;/p>
&lt;p>å…·ä½“æ¥è¯´ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¯ä¸ª block è´Ÿè´£å¤„ç†è‹¥å¹²ä¸ªçº¿ç¨‹çš„(&lt;code>blockDim&lt;/code>)æ•°æ®ï¼Œå¹¶åœ¨ block å†…å®Œæˆä¸€æ¬¡å±€éƒ¨è§„çº¦ï¼›&lt;/li>
&lt;li>æ¯ä¸ª block çš„ç»“æœä¼šè¢«å†™å…¥è¾“å‡ºæ•°ç»„çš„ &lt;code>blockIdx.x&lt;/code> ä½ç½®ï¼›&lt;/li>
&lt;li>å› æ­¤ï¼Œæœ€ç»ˆè¾“å‡ºæ•°ç»„çš„é•¿åº¦ç­‰äº &lt;code>gridDim.x&lt;/code>ï¼ˆå³ block æ•°é‡ï¼‰ï¼Œè€Œä¸æ˜¯å•ä¸ªå…ƒç´ ã€‚&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="æ€§èƒ½è¡¡é‡æŒ‡æ ‡our-metrics">æ€§èƒ½è¡¡é‡æŒ‡æ ‡ï¼ˆOur Metricsï¼‰
&lt;/h3>&lt;p>æˆ‘ä»¬è¡¡é‡å¹¶è¡Œå½’çº¦ç®—æ³•æ€§èƒ½çš„ä¸¤ä¸ªå…³é”®æŒ‡æ ‡æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ—¶é—´ï¼ˆTimeï¼‰&lt;/strong>&lt;/li>
&lt;li>&lt;strong>å¸¦å®½ï¼ˆBandwidthï¼‰&lt;/strong>&lt;/li>
&lt;/ul>
&lt;p>è¿™ä¸¤ä¸ªæŒ‡æ ‡åæ˜ äº† GPU æ˜¯å¦è¾¾åˆ°äº†å³°å€¼æ€§èƒ½ã€‚æˆ‘ä»¬å¸Œæœ›åœ¨ä»¥ä¸‹ä¸¤æ–¹é¢è¿›è¡Œä¼˜åŒ–ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æé«˜æ•°æ®è¯»å†™æ•ˆç‡&lt;/strong>&lt;/li>
&lt;li>&lt;strong>åŠ å¿«è®¡ç®—é€Ÿåº¦ã€æå‡çº¿ç¨‹åˆ©ç”¨ç‡&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>ä¸€æ®µç†æƒ³çš„ GPU ç¨‹åºï¼Œä¸ä»…è¿è¡Œå¿«é€Ÿï¼Œè¿˜èƒ½ä½¿å¤§å¤šæ•°çº¿ç¨‹éƒ½åœ¨å·¥ä½œã€‚&lt;/p>
&lt;h2 id="reduce-0äº¤é”™å¯»å€æ³•interleaved-addressing">REDUCE-0ï¼šäº¤é”™å¯»å€æ³•ï¼ˆInterleaved Addressingï¼‰
&lt;/h2>&lt;h3 id="æ€è·¯ä»‹ç»">æ€è·¯ä»‹ç»
&lt;/h3>&lt;p>æœ€æœ´ç´ çš„ä¸€ç§å¹¶è¡Œå½’çº¦æ–¹æ³•æ˜¯é‡‡ç”¨â€œäº¤é”™å¯»å€ï¼ˆInterleaved Addressingï¼‰â€ï¼Œä½œä¸ºæˆ‘ä»¬ä¼˜åŒ–è¿‡ç¨‹çš„åŸºç¡€ç‰ˆæœ¬ã€‚åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼š&lt;/p>
&lt;ul>
&lt;li>æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸€ç»„å…ƒç´ ï¼›&lt;/li>
&lt;li>æ¯è½®å½’çº¦æ—¶ï¼Œçº¿ç¨‹å°†å…¶å½“å‰å€¼ä¸ä¸€æ®µè·ç¦»å†…çš„å¦ä¸€ä¸ªå…ƒç´ å€¼ç›¸åŠ ï¼›&lt;/li>
&lt;li>æ¯è½®æ­¥é•¿åŠ å€ï¼Œç›´åˆ°æœ€ç»ˆå¾—å‡ºè¯¥ block çš„å½’çº¦ç»“æœã€‚&lt;/li>
&lt;/ul>
&lt;p>ğŸ“˜ ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ª 1024 å…ƒç´ æ•°ç»„ï¼Œä½¿ç”¨ 256 çº¿ç¨‹å—ï¼Œæ¯ä¸ªçº¿ç¨‹å¤„ç†å››ä¸ªé—´éš”ä¸º 256 çš„æ•°æ®ç‚¹ã€‚&lt;/p>
&lt;p>è¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿ï¼š&lt;/p>
&lt;ul>
&lt;li>å„çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œè´Ÿè½½å‡è¡¡ï¼›&lt;/li>
&lt;li>çº¿ç¨‹é—´åŒæ­¥æ›´ç®€å•ï¼›&lt;/li>
&lt;li>ä¾¿äº GPU é«˜æ•ˆæ‰§è¡Œã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="cuda-ä»£ç å®ç°">CUDA ä»£ç å®ç°
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="o">//&lt;/span> &lt;span class="n">REDUCTION&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="err">â€“&lt;/span> &lt;span class="n">Interleaved&lt;/span> &lt;span class="n">Addressing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__global__&lt;/span> &lt;span class="n">void&lt;/span> &lt;span class="n">reduce0&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">g_in_data&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">g_out_data&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">extern&lt;/span> &lt;span class="n">__shared__&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">sdata&lt;/span>&lt;span class="p">[];&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">stored&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">the&lt;/span> &lt;span class="n">shared&lt;/span> &lt;span class="n">memory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="n">Each&lt;/span> &lt;span class="n">thread&lt;/span> &lt;span class="n">loading&lt;/span> &lt;span class="n">one&lt;/span> &lt;span class="n">element&lt;/span> &lt;span class="n">from&lt;/span> &lt;span class="n">global&lt;/span> &lt;span class="n">onto&lt;/span> &lt;span class="n">shared&lt;/span> &lt;span class="n">memory&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">unsigned&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">tid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">//&lt;/span>&lt;span class="n">tidè¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨æ‰€åœ¨&lt;/span> &lt;span class="n">block&lt;/span> &lt;span class="err">ä¸­çš„å±€éƒ¨ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">unsigned&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">iè¡¨ç¤ºå½“å‰çº¿ç¨‹åœ¨æ•´ä¸ª&lt;/span> &lt;span class="n">grid&lt;/span> &lt;span class="err">ä¸­çš„å…¨å±€çº¿ç¨‹ç¼–å·&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sdata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">g_in_data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__syncthreads&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="n">Reduction&lt;/span> &lt;span class="n">method&lt;/span> &lt;span class="o">--&lt;/span> &lt;span class="n">occurs&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">shared&lt;/span> &lt;span class="n">memory&lt;/span> &lt;span class="n">because&lt;/span> &lt;span class="n">that&lt;/span>&lt;span class="s1">&amp;#39;s where sdata is stored&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">unsigned&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">s&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">sdata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">sdata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">s&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">__syncthreads&lt;/span>&lt;span class="p">();&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">){&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">g_out_data&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sdata&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="è¯¥æ–¹æ³•å­˜åœ¨çš„é—®é¢˜">è¯¥æ–¹æ³•å­˜åœ¨çš„é—®é¢˜
&lt;/h3>&lt;p>è™½ç„¶è¿™ç§æ–¹æ³•æ˜¯å¹¶è¡Œç¼–ç¨‹çš„è‰¯å¥½åŸºç¡€ï¼Œä½†å®ƒä»å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚è®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æ€§èƒ½æŒ‡æ ‡ï¼Œåˆ†æä»£ç åœ¨è®¡ç®—å’Œå†…å­˜æ–¹é¢å¯èƒ½å­˜åœ¨çš„ä½æ•ˆä¹‹å¤„ã€‚&lt;/p>
&lt;p>&lt;strong>è®¡ç®—æ–¹é¢ï¼š&lt;/strong> ä¸€ä¸ªä¸»è¦çš„è®¡ç®—ä½æ•ˆæ˜¯ &lt;code>%&lt;/code> æ“ä½œç¬¦çš„ä½¿ç”¨ã€‚ç”±äº &lt;code>%&lt;/code> æ¶‰åŠé™¤æ³•æ“ä½œï¼Œè€Œé™¤æ³•åœ¨åº•å±‚æ˜¯éå¸¸æ…¢çš„æ“ä½œï¼Œè¿™ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§é‡çº¿ç¨‹é¢‘ç¹æ‰§è¡Œè¯¥æ“ä½œçš„å†…æ ¸ä¸­ã€‚æ­¤å¤–ï¼Œäº¤é”™å¯»å€æ¨¡å¼å¯¼è‡´äº†ä¸¥é‡çš„ warp å‘æ•£ï¼ˆdivergenceï¼‰ï¼Œå› ä¸ºåŒä¸€ä¸ª warp ä¸­çš„çº¿ç¨‹éœ€è¦æ‰§è¡Œä¸åŒçš„åˆ†æ”¯è·¯å¾„ï¼ˆåŸºäºå½“å‰çš„ &lt;code>if&lt;/code> æ¡ä»¶ï¼‰ã€‚è¿™ç§è·¯å¾„å‘æ•£å¯¼è‡´ warp éœ€è¦ç­‰å¾…è¾ƒæ…¢çš„çº¿ç¨‹å®Œæˆï¼Œé€ æˆé˜»å¡ï¼Œä»è€Œä¸¥é‡é™ä½æ€§èƒ½ã€‚å…·ä½“è€Œè¨€ï¼Œä»£ç å—ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"> for(unsigned int s = 1; s &amp;lt; blockDim.x; s *= 2){
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (tid % (2 * s) == 0) {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sdata[tid] += sdata[tid + s];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __syncthreads();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç¬¬ä¸€ä¸ªforï¼Œæ¿€æ´»çš„çº¿ç¨‹ä¸º0ï¼Œ2ï¼Œ4&amp;hellip;ï¼›ç¬¬äºŒæ¬¡æ‰§è¡Œforå¾ªç¯ï¼Œæ¿€æ´»çš„çº¿ç¨‹ä¸º0ï¼Œ4ï¼Œ8&amp;hellip; æ˜¾ç„¶ï¼Œæ¯ä¸ªforå¾ªç¯ä¸­åªæœ‰æœ‰50%ï¼Œ25%ã€‚ã€‚ã€‚çš„çº¿ç¨‹å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œè¿™æ˜¾ç„¶æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°äº†ã€‚æˆ‘ä»¬å¸Œæœ›å°½å¯èƒ½å¤šçš„çº¿ç¨‹éƒ½å¤„äºå·¥ä½œçŠ¶æ€ï¼Œè‡³å°‘åœ¨åŒä¸€ä¸ªwarpä¸­æ˜¯å¦‚æ­¤ã€‚&lt;/p>
&lt;p>&lt;strong>å†…å­˜æ–¹é¢ï¼š&lt;/strong> ç”±äº warp å‘æ•£ï¼Œè¯¥æ–¹æ³•çš„å†…å­˜è®¿é—®æ¨¡å¼ä¸ä½³ã€‚æ¯ä¸ªçº¿ç¨‹è®¿é—®çš„æ•°æ®å…ƒç´ åˆ†å¸ƒåœ¨æ•´ä¸ªæ•°ç»„ä¸­ï¼Œå¯¼è‡´å†…å­˜è®¿é—®åˆ†æ•£è€Œéåˆå¹¶è®¿é—®ï¼ˆcoalescedï¼‰ï¼Œä»è€Œé€ æˆå¸¦å®½åˆ©ç”¨ç‡ä½ä¸‹å’Œè¾ƒé«˜çš„å†…å­˜å»¶è¿Ÿã€‚è¿™ç§åˆ†æ•£è®¿é—®ä¼šå¼•èµ·å¤šæ¬¡ç¼“æ…¢çš„å†…å­˜äº‹åŠ¡ï¼Œè€Œéä¸€æ¬¡å¿«é€Ÿäº‹åŠ¡ï¼Œæœªèƒ½å……åˆ†åˆ©ç”¨ GPU çš„å†…å­˜å¸¦å®½èƒ½åŠ›ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘ä»¬ä¼šåœ¨åç»­çš„ä¼˜åŒ–ä¸­å¼€å§‹è§£å†³ã€‚å…·ä½“æ¥è¯´
è½®æ¬¡ 5: s = 16
if (tid % 32 == 0): åœ¨Warp 0 (çº¿ç¨‹0-31)ä¸­ï¼Œåªæœ‰çº¿ç¨‹0åœ¨å·¥ä½œã€‚
å®ƒè¯»å– sdata[16]ã€‚
è®¿å­˜åˆ†æ: æ•´ä¸ªWarpä¸ºäº†æ»¡è¶³çº¿ç¨‹0è¿™ä¸€ä¸ªè¯»å–è¯·æ±‚ï¼Œå‘èµ·äº†ä¸€æ¬¡å†…å­˜äº‹åŠ¡ã€‚ä½†è¿™æ¬¡äº‹åŠ¡ä¸­ï¼Œåªæœ‰1/32çš„æ•°æ®è¢«åˆ©ç”¨äº†ã€‚31/32çš„å†…å­˜å¸¦å®½è¢«æµªè´¹äº†ï¼&lt;/p>
&lt;p>é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆå…³æ³¨è®¡ç®—ç›¸å…³çš„é—®é¢˜ï¼Œå¹¶è¿›è¡Œä¸‹ä¸€æ­¥ä¼˜åŒ–ã€‚&lt;/p>
&lt;h2 id="reduce-1äº¤é”™å¯»å€æ³•-20interleaved-addressing-20">REDUCE-1ï¼šäº¤é”™å¯»å€æ³• 2.0ï¼ˆInterleaved Addressing 2.0ï¼‰
&lt;/h2>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">// REDUCTION 1 â€“ Interleaved Addressing 2.0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">__global__ void reduce1(int *g_in_data, int *g_out_data){
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> extern __shared__ int sdata[]; // å‚¨å­˜åœ¨å…±äº«å†…å­˜ä¸­
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ¯ä¸ªçº¿ç¨‹ä»å…¨å±€å†…å­˜åŠ è½½ä¸€ä¸ªå…ƒç´ åˆ°å…±äº«å†…å­˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> unsigned int tid = threadIdx.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> unsigned int i = blockIdx.x * blockDim.x + threadIdx.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sdata[tid] = g_in_data[i];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __syncthreads();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // å½’çº¦æ“ä½œ -- åœ¨å…±äº«å†…å­˜ä¸­è¿›è¡Œ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> for(unsigned int s = 1; s &amp;lt; blockDim.x; s *= 2){
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ³¨æ„æ­¥é•¿ s *= 2ï¼šè¿™å¯¼è‡´äº†äº¤é”™å¯»å€
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int index = 2 * s * tid; // ç°åœ¨æˆ‘ä»¬ä¸å†éœ€è¦ if æ¡ä»¶å¸¦æ¥çš„åˆ†åŒ–åˆ†æ”¯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®ä¿ä¸ä¼šè¶Šç•Œè®¿é—®
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (index &amp;lt; blockDim.x)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sdata[index] += sdata[index + s]; // s ç”¨æ¥è¡¨ç¤ºå°†è¢«åˆå¹¶çš„åç§»é‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __syncthreads();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // çº¿ç¨‹0å°†æœ€ç»ˆç»“æœå†™å›å…¨å±€å†…å­˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (tid == 0){
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> g_out_data[blockIdx.x] = sdata[0];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>åŸºäºæ ‘ç»“æ„çš„ SPH ç²’å­é¢†åŸŸæœç´¢</title><link>https://keqiye.github.io/zh-cn/posts/cudatreecode/blog-post-treecode/</link><pubDate>Mon, 12 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/cudatreecode/blog-post-treecode/</guid><description>&lt;h1 id="æ ‘ç»“æ„åŸºäºæ ¹æ®-burtscher-å’Œ-pingali-çš„ç ”ç©¶">æ ‘ç»“æ„ï¼ˆåŸºäºæ ¹æ® Burtscher å’Œ Pingali çš„ç ”ç©¶ï¼‰
&lt;/h1>&lt;p>æœ¬æ–‡å°†ä»‹ç»å¹¿æ³›ç”¨äº SPH ä»£ç å’Œ N ä½“æ¨¡æ‹Ÿä¸­çš„æ ‘ç»“æ„ï¼ˆTree Structureï¼‰ã€‚è¿™ç§æ•°æ®ç»“æ„ä¸»è¦åº”ç”¨äºä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&lt;/p>
&lt;h3 id="1-ç²’å­é¢†åŸŸæœç´¢neighbor-search">1. ç²’å­é¢†åŸŸæœç´¢ï¼ˆNeighbor Searchï¼‰
&lt;/h3>&lt;p>åœ¨ SPHï¼ˆå…‰æ»‘ç²’å­æµä½“åŠ›å­¦ï¼‰æ¨¡æ‹Ÿä¸­ï¼Œæ¯ä¸ªç²’å­éœ€è¦åœ¨æ ¸å°ºåº¦ \( h \) èŒƒå›´å†…æŸ¥æ‰¾é‚»å±…ç²’å­ï¼Œä»¥ä¾¿è®¡ç®—å¯†åº¦ã€å‹å¼ºæ¢¯åº¦ã€ç²˜æ€§ç­‰ç‰©ç†é‡ã€‚æ ‘ç»“æ„èƒ½å¤ŸåŠ é€Ÿé‚»åŸŸæœç´¢ï¼Œå°¤å…¶é€‚ç”¨äºç²’å­åˆ†å¸ƒé«˜åº¦éå‡åŒ€çš„æƒ…å½¢ã€‚&lt;/p>
&lt;h3 id="2-è‡ªå¼•åŠ›è®¡ç®—self-gravity-computation">2. è‡ªå¼•åŠ›è®¡ç®—ï¼ˆSelf-Gravity Computationï¼‰
&lt;/h3>&lt;p>åœ¨å¼•åŠ›ä¸»å¯¼çš„ç²’å­ç³»ç»Ÿï¼ˆå¦‚æ˜Ÿç³»æ¨¡æ‹Ÿã€æ˜Ÿä½“ç¢°æ’ï¼‰ä¸­ï¼Œç²’å­é—´å­˜åœ¨ä¸‡æœ‰å¼•åŠ›ä½œç”¨ã€‚ç›´æ¥è®¡ç®—æ‰€æœ‰ç²’å­å¯¹çš„å¼•åŠ›å¼€é”€ä¸º \( \mathcal{O}(N^2) \)ï¼Œä¸å¯æ¥å—ã€‚åŸºäºæ ‘çš„è¿‘ä¼¼æ–¹æ³•ï¼ˆå¦‚ Barnes-Hut ç®—æ³•ï¼‰å¯å°†è®¡ç®—å¤æ‚åº¦é™è‡³ \( \mathcal{O}(N \log N) \)ï¼ŒåŒæ—¶ä¿æŒè¾ƒé«˜ç²¾åº¦ã€‚&lt;/p>
&lt;hr>
&lt;p>æ¥ä¸‹æ¥çš„ç« èŠ‚å°†åˆ†åˆ«ä»‹ç»æ ‘ç»“æ„åœ¨ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ä¸­çš„æ„å»ºæ–¹æ³•ã€æœç´¢ç­–ç•¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p>
&lt;p>å…³äºä¼ ç»Ÿçš„ &lt;strong>é“¾è¡¨æ³•ï¼ˆLinked-Listï¼‰&lt;/strong> ç²’å­é¢†åŸŸæœç´¢ï¼Œè¯·å‚è€ƒæˆ‘å¦ä¸€ç¯‡åšæ–‡ï¼š ğŸ‘‰ &lt;a class="link" href="https://keqiye.github.io/posts/SPH_neighbor_search/" >ä½¿ç”¨é“¾è¡¨è¿›è¡Œ SPH é‚»åŸŸæœç´¢&lt;/a>&lt;/p>
&lt;h1 id="å®ç°æ­¥éª¤">å®ç°æ­¥éª¤
&lt;/h1>&lt;p>æ ¹æ®ç›¸å…³æ–‡çŒ®ï¼Œæ¯æ¬¡æ‰§è¡Œè‡ªå¼•åŠ›è®¡ç®—æˆ–ç²’å­é‚»åŸŸæœç´¢æ—¶ï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>ç¡®å®šç²’å­ç©ºé—´èŒƒå›´&lt;/strong>&lt;br>
ç»Ÿè®¡æ‰€æœ‰ç²’å­çš„ç©ºé—´è¾¹ç•Œï¼Œè·å– \( x_{\min}, x_{\max}, y_{\min}, y_{\max}, z_{\min}, z_{\max} \)ï¼Œç”¨äºåˆå§‹åŒ–æ ‘ç»“æ„çš„æ ¹èŠ‚ç‚¹æˆ–ç©ºé—´åˆ’åˆ†èŒƒå›´ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ„å»ºæ ‘ç»“æ„&lt;/strong>&lt;br>
å°†ç²’å­é€’å½’åˆ’åˆ†åˆ°ç©ºé—´æ ‘èŠ‚ç‚¹ä¸­ï¼Œå¸¸ç”¨çš„æ•°æ®ç»“æ„åŒ…æ‹¬å…«å‰æ ‘ï¼ˆOctreeï¼‰æˆ– KD æ ‘ã€‚æ¯ä¸ªå¶å­èŠ‚ç‚¹åŒ…å«è‹¥å¹²ç²’å­æˆ–è¾¾åˆ°æœ€å°åˆ’åˆ†æ¡ä»¶ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç²’å­ç©ºé—´æ’åº&lt;/strong>&lt;br>
å¯¹ç²’å­è¿›è¡Œ Morton ç¼–ç ï¼ˆZ-order curveï¼‰æˆ– Hilbert æ›²çº¿ç¼–ç ï¼Œå¹¶æŒ‰ç…§ç©ºé—´ä½ç½®æ’åºï¼Œä¾¿äºç¼“å­˜ä¸€è‡´æ€§å’Œåç»­å¹¶è¡Œå¤„ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ ‘éå†è®¡ç®—&lt;/strong>&lt;br>
éå†æ ‘ç»“æ„ï¼š&lt;/p>
&lt;ul>
&lt;li>è‹¥æ‰§è¡Œ &lt;strong>è‡ªå¼•åŠ›è®¡ç®—&lt;/strong>ï¼Œä½¿ç”¨ Barnes-Hut è¿‘ä¼¼è§„åˆ™åˆ¤æ–­æ˜¯å¦èšåˆèŠ‚ç‚¹è´¨é‡ï¼›&lt;/li>
&lt;li>è‹¥æ‰§è¡Œ &lt;strong>é‚»åŸŸæœç´¢&lt;/strong>ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­åˆ¤æ–­ä¸æŸ¥è¯¢ç²’å­çš„è·ç¦»æ˜¯å¦å°äºæ ¸å°ºåº¦ \( h \)ï¼Œä»è€Œç­›é€‰å¯èƒ½é‚»å±…ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="ç¡®å®šç²’å­ç©ºé—´èŒƒå›´">ç¡®å®šç²’å­ç©ºé—´èŒƒå›´
&lt;/h2>&lt;p>ç›´æ¥ä½¿ç”¨è§„çº¦ç®—æ³•æ±‚æœ€å¤§æœ€å°å€¼&lt;/p>
&lt;h2 id="æ„å»ºæ ‘ç»“æ„">æ„å»ºæ ‘ç»“æ„
&lt;/h2>&lt;p>ç”±äº GPU ä¸Šæ— æ³•é«˜æ•ˆå®ç°æŒ‡é’ˆå¼é“¾è¡¨ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°ç»„æ¥æ¨¡æ‹Ÿæ ‘çš„é“¾æ¥å…³ç³»ï¼ˆä¾‹å¦‚å­èŠ‚ç‚¹æŒ‡é’ˆï¼‰ã€‚å‡è®¾æœ‰ä¸€ä¸ªæ•´å‹æ•°ç»„ &lt;code>child&lt;/code>ï¼Œå…¶é•¿åº¦è¿œå¤§äºç²’å­æ€»æ•° &lt;code>numParticles&lt;/code>ï¼Œå¹¶åˆå§‹åŒ–ä¸º &lt;code>-1&lt;/code>ï¼Œè¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹å°šæœªä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="åŒºåˆ†å¶å­èŠ‚ç‚¹ä¸æ ¹èŠ‚ç‚¹">åŒºåˆ†å¶å­èŠ‚ç‚¹ä¸æ ¹èŠ‚ç‚¹
&lt;/h3>&lt;p>åœ¨æ ‘ç»“æ„ä¸­ï¼Œå¦‚ä½•åŒºåˆ†æ•´å‹æ•°ç»„ &lt;code>child&lt;/code> çš„æŸä¸€ä¸ªä½ç½®å­˜å‚¨çš„æ˜¯ &lt;strong>å¶å­èŠ‚ç‚¹ï¼ˆç²’å­ï¼‰&lt;/strong> è¿˜æ˜¯ &lt;strong>æ ¹èŠ‚ç‚¹&lt;/strong> æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚&lt;/p>
&lt;h4 id="æ ‡è¯†æ–¹æ³•">æ ‡è¯†æ–¹æ³•ï¼š
&lt;/h4>&lt;ul>
&lt;li>&lt;strong>&lt;code>-1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®ä¸ºç©ºï¼Œæœªè¢«å ç”¨ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>-2&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®å·²è¢«é”å®šï¼Œå½“å‰çº¿ç¨‹æ­£åœ¨ä½¿ç”¨è¯¥ä½ç½®ï¼ˆé€šå¸¸ç”¨äºè¿›è¡ŒåŸå­æ“ä½œï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>-3&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸€å®šä¼šæœ‰å­æ ‘ï¼ˆå¯èƒ½æ˜¯å­èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯ç²’å­ï¼Œç²’å­çš„å­èŠ‚ç‚¹ä¸€å®šä¸ºç©ºï¼š-1ï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>0&lt;/code> åˆ° &lt;code>numParticles - 1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤º &lt;strong>ç²’å­&lt;/strong>ï¼Œæ¯ä¸ªä½ç½®å¯¹åº”ä¸€ä¸ªç²’å­ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ˜¾ç„¶ï¼Œå¦‚æœç¬¬ &lt;code>i&lt;/code> ä¸ªä½ç½®è¢«é”å®šï¼Œé‚£ä¹ˆï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ &lt;strong>ä¸‰ç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>8*i+1+0&lt;/code> åˆ° &lt;code>7&lt;/code>ï¼ˆå³ä¸€ä¸ªå…«å²”æ ‘åŠå…¶å­æ ‘ç­‰ï¼‰éƒ½è¢«é”å®šï¼›&lt;/li>
&lt;li>åœ¨ &lt;strong>äºŒç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>4*i+1+0&lt;/code> åˆ° &lt;code>3&lt;/code>ï¼ˆå³ä¸€ä¸ªå››å²”æ ‘åŠå…¶å­æ ‘ç­‰ï¼‰éƒ½è¢«é”å®šï¼›&lt;/li>
&lt;li>åœ¨ &lt;strong>ä¸€ç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>i&lt;/code> åŠå…¶ç›¸é‚»éƒ¨åˆ†ä¹Ÿä¼šè¢«é”å®šã€‚&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„ï¼Œä»»æ„ç´¢å¼•&lt;code>i&lt;/code>çš„å­èŠ‚ç‚¹è®¡ç®—æ–¹æ³•ä¸ºï¼š&lt;code>8*i+1+0&lt;/code>ï¼Œä¸ä¼ ç»Ÿçš„å…«å‰æ ‘è®¡ç®—æ–¹æ³•ä¸åŒï¼Œè¿™æ˜¯å› ä¸ºæˆ‘çš„ä»£ç ä¸­ï¼Œ0èŠ‚ç‚¹ä¿å­˜çš„æ˜¯æœ€å¤§çš„æ ¹èŠ‚ç‚¹ä¿¡æ¯ã€‚&lt;/p>
&lt;p>&amp;ndash; è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªä½ç½®è¢«é”å®šï¼Œ&lt;strong>å…¶ä»–çº¿ç¨‹å°†æ— æ³•è®¿é—®è¯¥ä½ç½®çš„å­æ ‘æˆ–å…¶å­æ ‘çš„å­æ ‘&lt;/strong>ï¼Œç¡®ä¿äº†å¹¶è¡Œè®¡ç®—ä¸­èŠ‚ç‚¹åŠå…¶ç›¸å…³å­èŠ‚ç‚¹çš„å®‰å…¨ã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨åŸå­æ“ä½œåŒæ­¥çº¿ç¨‹">ä½¿ç”¨åŸå­æ“ä½œåŒæ­¥çº¿ç¨‹
&lt;/h3>&lt;p>å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°å°è¯•è®¿é—®åŒä¸€ä¸ªå­èŠ‚ç‚¹æ§½ä½æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ CUDA æä¾›çš„åŸå­æ“ä½œ &lt;code>atomicCAS&lt;/code>ï¼ˆCompare And Swapï¼‰æ¥è¿›è¡Œçº¿ç¨‹é—´åŒæ­¥ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯åŸå­æ“ä½œçš„ä»£ç ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">int re = atomicCAS(&amp;amp;child[p], -1, -2); // å°è¯•å ç”¨ child[p]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æ“ä½œçš„å«ä¹‰æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>è‹¥ &lt;code>child[p] == -1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥æ§½ä½å°šæœªè¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹æˆåŠŸå°†å…¶åŸå­åœ°è®¾ç½®ä¸º &lt;code>-2&lt;/code>ï¼Œè¡¨ç¤ºâ€œé”å®šä¸­â€æˆ–â€œå‡†å¤‡æ’å…¥â€ï¼›&lt;/li>
&lt;li>&lt;strong>è‹¥ &lt;code>child[p] != -1&lt;/code>&lt;/strong>ï¼šè¯´æ˜è¯¥æ§½ä½å·²è¢«å…¶ä»–çº¿ç¨‹å ç”¨æˆ–å·²è¢«æ’å…¥ï¼Œå½“å‰çº¿ç¨‹éœ€é€€å‡ºæˆ–é‡è¯•ï¼›&lt;/li>
&lt;li>&lt;strong>è¿”å›å€¼ &lt;code>re&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºæ“ä½œå‰çš„æ—§å€¼ã€‚å¦‚æœ &lt;code>re == -1&lt;/code>ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸé”å®šäº†è¯¥èŠ‚ç‚¹ã€‚å¦‚æœ &lt;code>re != -1&lt;/code> ï¼Œåˆ™ &lt;code>atomicCAS&lt;/code> å‡½æ•°å‘ç°æ¯”è¾ƒä¸æˆç«‹ï¼Œç›´æ¥è¿”å›äº†æ—§å€¼ï¼Œä¹Ÿä¸ä¼šæ›¿æ¢&lt;code>-2&lt;/code>è€Œæ‰“ä¹±&lt;code>child&lt;/code>æ•°ç»„å†…å®¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>å†™åˆ°è¿™é‡Œï¼Œæ ‘ç»“æ„æ•°ç»„&lt;code>child&lt;/code>çš„æ„å»ºå°±å¾ˆå®¹æ˜“äº†ã€‚ä¸‹é¢æ˜¯ä¼ªä»£ç &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#define childListIndex(nodeIdx, childNum) ((nodeIdx) * TREETYPE + 1 + (childNum))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define EMPTY -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define LOCKED -2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define TRUE 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define FALSE 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define NODE -3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//RealType4 æ˜¯ float4 æˆ– double4 çš„åˆ«åï¼Œæˆ‘è¿™æ ·å†™æ˜¯ä¸ºäº†åŒºåˆ†å•åŒç²¾åº¦è®¡ç®—ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œæ¶ˆè´¹çº§æ˜¾å¡çš„åŒç²¾åº¦è®¡ç®—èƒ½åŠ›æ¯”è¾ƒå·®ã€‚ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//ç²’å­çš„wåˆ†é‡å­˜æ”¾äº†è´¨é‡ï¼ŒèŠ‚ç‚¹çš„wåˆ†é‡å­˜æ”¾äº†èŠ‚ç‚¹åŠå¾„ï¼ˆæ­£æ–¹ä½“çš„è¾¹é•¿çš„ä¸€åŠï¼‰ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//ç›®å‰è¿˜æ²¡æœ‰æ·»åŠ èŠ‚ç‚¹è´¨å¿ƒçš„è®¡ç®—é€»è¾‘ï¼Œåç»­ä¼šåŠ ï¼Œç”¨äºè®¡ç®—ç²’å­çš„å¼•åŠ›ï¼Œå‚è€ƒï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//A hierarchical O(N log N) force-calculation algorithm æœ¬æ–‡å‘è¡¨åœ¨natureä¸Šï¼Œé¡¶ç¤¼è†œæ‹œ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">__global__ void buildTreeKernel(SPHState *deviceP, treeData *tree)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä¸ºé¿å…æ··æ·†ï¼Œæ˜ç¡®åŒºåˆ†ç²’å­å’ŒèŠ‚ç‚¹çš„ä½ç½®æ•°ç»„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 *particlePositions = deviceP-&amp;gt;positions;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volatile RealType4 *nodePositions = tree-&amp;gt;positions;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 *nodeRoot = tree-&amp;gt;nodeRoot;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volatile int *childList = tree-&amp;gt;childList;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childListLength = tree-&amp;gt;childListLength;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int numParticles = tree-&amp;gt;numParticles;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int inc = blockDim.x * gridDim.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int i = threadIdx.x + blockIdx.x * blockDim.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int k;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childIndex, child;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int lockedIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType x, y, z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootRadius = nodeRoot-&amp;gt;w;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootX = nodeRoot-&amp;gt;x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootY = nodeRoot-&amp;gt;y;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootZ = nodeRoot-&amp;gt;z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ·»åŠ è·Ÿè¸ªå½“å‰èŠ‚ç‚¹ä½ç½®çš„å˜é‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType currentX, currentY, currentZ, currentR;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int depth = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int isNewParticle = TRUE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int currentNodeIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bool isInsert;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (i &amp;lt; numParticles)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = false;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (!isInsert)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 pos = particlePositions[i];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x = pos.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> y = pos.y;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> z = pos.z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // å¼€å§‹äºæ ¹èŠ‚ç‚¹ï¼ˆç´¢å¼•0ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX = rootX;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY = rootY;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ = rootZ;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR = rootRadius;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // è·Ÿéšè·¯å¾„åˆ°å¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = childListIndex(currentNodeIndex, childIndex);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR *= 0.5;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX += ((childIndex &amp;amp; 1) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY += ((childIndex &amp;amp; 2) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ += ((childIndex &amp;amp; 4) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> child = childList[currentNodeIndex];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth++;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //ä¸‹é¢è¿™ä¸ªwhileå¾ªç¯æ˜¯ä¸ºäº†å¯»æ‰¾å¶å­èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (child == NODE)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šåœ¨æ–°èŠ‚ç‚¹ä¸­çš„å­èŠ‚ç‚¹ç´¢å¼•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // è·Ÿéšè·¯å¾„åˆ°å¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = childListIndex(currentNodeIndex, childIndex);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR *= 0.5;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX += ((childIndex &amp;amp; 1) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY += ((childIndex &amp;amp; 2) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ += ((childIndex &amp;amp; 4) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> child = childList[currentNodeIndex];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth++;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ’å…¥ç²’å­åˆ°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //ä¸‰ç§æƒ…å†µï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //1.å½“å‰å¶å­èŠ‚ç‚¹è¢«å ç”¨ï¼Œé‚£ä¹ˆé‡è¯•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //2.å½“å‰å¶å­èŠ‚ç‚¹ä¸ºç©ºï¼Œè¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œç›´æ¥æ’å…¥å³å¯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //3.å½“å‰å¶å­èŠ‚ç‚¹è¢«ç²’å­å ç”¨ï¼Œæœ¬çº¿ç¨‹è¯»å–oldèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯¹ä»–ä»¬ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œç»†åˆ†ï¼Œç›´åˆ°ä»–ä»¬è¢«åˆ†å±åˆ°ä¸åŒçš„è±¡é™
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child != LOCKED)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lockedIndex = currentNodeIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child == atomicCAS((int *)&amp;amp;childList[lockedIndex], child, LOCKED))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child == EMPTY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç›´æ¥æ’å…¥ç²’å­
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[lockedIndex] = i;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //æ­¤å¤„å¤„ç†ä¸¤ä¸ªèŠ‚ç‚¹ç»†åˆ†çš„æƒ…å½¢
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //è¿™ä¸ªå¾ªç¯å°è¯•ç»†åˆ†ï¼Œç›´åˆ°ä»–ä»¬ä¿©è¢«åˆ†å¼€åˆ°ä¸åŒçš„è±¡é™
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> do
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šå·²å­˜åœ¨ç²’å­åœ¨æ–°èŠ‚ç‚¹ä¸­çš„ä½ç½®
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childNewIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šå½“å‰ç²’å­åœ¨æ–°èŠ‚ç‚¹ä¸­çš„ä½ç½®
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int currentNewIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (childNewIndex != currentNewIndex)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä¸¤ä¸ªç²’å­åœ¨ä¸åŒå­èŠ‚ç‚¹ï¼Œå¯ä»¥æ’å…¥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[childListIndex(currentNodeIndex, childNewIndex)] = child;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[childListIndex(currentNodeIndex, currentNewIndex)] = i;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break; // é€€å‡ºå¾ªç¯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä»åœ¨åŒä¸€å­èŠ‚ç‚¹ï¼Œéœ€è¦ç»§ç»­ç»†åˆ†
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ³¨æ„æ¯æ¬¡ç»†åˆ†éƒ½ä¼šåˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œéœ€è¦ä¿å­˜èŠ‚ç‚¹çš„åŒ…å›´ç›’ä¿¡æ¯ ç”¨äºé¢†åŸŸæœç´¢
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // // å†™å…¥æ–°èŠ‚ç‚¹çš„ä¸­å¿ƒå’ŒåŠå¾„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].x = currentX;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].y = currentY;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].z = currentZ;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].w = currentR;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[currentNodeIndex] = NODE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // å†…å­˜åŒæ­¥ï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥çœ‹åˆ°æœ‰æ–°çš„èŠ‚ç‚¹è¢«å†™å…¥äº†
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __threadfence();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } while (true);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®ä¿æ‰€æœ‰å­æ ‘çš„å†™å…¥å®Œæˆ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __threadfence();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //é‡Šæ”¾é”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[lockedIndex] = NODE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> i += inc;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="å½“å‰å®ç°çš„å±€é™æ€§">å½“å‰å®ç°çš„å±€é™æ€§
&lt;/h2>&lt;p>è™½ç„¶ç¨€ç–æ ‘åœ¨æ•°æ®ç»“æ„ä¸Šç›´è§‚ä¸”çµæ´»ï¼Œä½†åœ¨å¹¶è¡Œæ„å»ºå’Œ GPU åŠ é€Ÿåœºæ™¯ä¸‹ï¼Œå®ƒä»ç„¶å­˜åœ¨ä¸€äº›æ˜æ˜¾çš„å±€é™ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>èŠ‚ç‚¹è®¿é—®ä¸è¿ç»­&lt;/strong>ï¼šç¨€ç–æ ‘çš„èŠ‚ç‚¹åœ¨å†…å­˜ä¸­é€šå¸¸åˆ†æ•£å­˜æ”¾ï¼Œå¯¼è‡´ GPU åœ¨å¹¶è¡Œè®¿é—®æ—¶é¢‘ç¹å‡ºç°éè¿ç»­å†…å­˜è¯»å–ï¼Œå½±å“å¸¦å®½åˆ©ç”¨ç‡ã€‚&lt;/li>
&lt;li>&lt;strong>æ˜¾å­˜éœ€æ±‚é«˜&lt;/strong>ï¼šç”±äºç¨€ç–æ ‘å­˜å‚¨æ–¹å¼ä¸è¿ç»­ï¼ŒGPU åœ¨æ„å»ºå’ŒæŸ¥è¯¢è¿‡ç¨‹ä¸­éœ€è¦é¢å¤–çš„æ˜¾å­˜æ¥ç®¡ç†æŒ‡é’ˆå’ŒèŠ‚ç‚¹ç»“æ„ï¼Œè¿™ä½¿å¾—åœ¨å¤§è§„æ¨¡æ•°æ®ä¸‹æ˜¾å­˜å‹åŠ›å¤§ï¼Œå¾ˆå®¹æ˜“è¶…è¿‡æ˜¾å­˜é™åˆ¶ã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æå‡ºäº† &lt;strong>ç¨ å¯†å­˜å‚¨çš„å¹¶è¡Œæ ‘æ„å»ºæ–¹æ¡ˆ&lt;/strong>ã€‚è¯¥æ–¹æ¡ˆå°†æ ‘èŠ‚ç‚¹è¿ç»­å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¹¶ç»“åˆä¼˜åŒ–çš„å¹¶è¡Œç®—æ³•ï¼Œä½¿ GPU èƒ½å¤Ÿé«˜æ•ˆåœ°è®¿é—®æ•°æ®ï¼Œä»è€Œæ˜¾è‘—æå‡æ„å»ºé€Ÿåº¦å’ŒæŸ¥è¯¢æ€§èƒ½ã€‚åŒæ—¶ï¼Œç¨ å¯†å­˜å‚¨æ–¹æ¡ˆèƒ½å¤Ÿæ›´åˆç†åœ°åˆ©ç”¨æ˜¾å­˜ï¼Œé™ä½æ˜¾å­˜å ç”¨ï¼Œæé«˜å¤„ç†å¤§è§„æ¨¡æ•°æ®çš„èƒ½åŠ›ã€‚&lt;/p>
&lt;p>æ›´å¤šå…³äºå®ç°ç»†èŠ‚å’Œæ€§èƒ½ä¼˜åŒ–çš„æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒï¼š&lt;a class="link" href="../dense-tree-build/" >åŸºäºç¨ å¯†å­˜å‚¨çš„å¹¶è¡Œæ ‘æ„å»º&lt;/a>ã€‚&lt;/p>
&lt;p>[1] Burtscher, Martin, and Keshav Pingali. &amp;ldquo;An efficient CUDA implementation of the tree-based barnes hut n-body algorithm.&amp;rdquo; &lt;em>GPU computing Gems Emerald edition&lt;/em>. Morgan Kaufmann, 2011. 75-92.&lt;/p></description></item><item><title>Hugoå¤šè¯­è¨€åšå®¢æ­å»ºä¸ç»´æŠ¤æŒ‡å—</title><link>https://keqiye.github.io/zh-cn/posts/blog-post-1/</link><pubDate>Fri, 09 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/blog-post-1/</guid><description>&lt;!-- git push source main -->
&lt;h1 id="åšå®¢æ­å»ºå’Œç®¡ç†æµç¨‹">åšå®¢æ­å»ºå’Œç®¡ç†æµç¨‹
&lt;/h1>&lt;p>æœ¬æŒ‡å—è¯¦ç»†è®°å½•äº†å¦‚ä½•åœ¨ GitHub Pages ä¸Šæ’°å†™ã€ä¸Šä¼ ã€åˆ é™¤ä¸­è‹±æ–‡åšå®¢çš„æ­¥éª¤ï¼Œä»¥åŠç›¸å…³ Git å‘½ä»¤ã€‚&lt;/p>
&lt;h2 id="1-åšå®¢å†…å®¹æ’°å†™åŒ…æ‹¬ä¸­è‹±æ–‡">1. åšå®¢å†…å®¹æ’°å†™ï¼ˆåŒ…æ‹¬ä¸­è‹±æ–‡ï¼‰
&lt;/h2>&lt;h3 id="1-åˆ›å»ºæˆ–ä¿®æ”¹åšå®¢æ–‡ç« ">(1) åˆ›å»ºæˆ–ä¿®æ”¹åšå®¢æ–‡ç« 
&lt;/h3>&lt;ol>
&lt;li>
&lt;p>&lt;strong>å®šä½åˆ° Hugo åšå®¢å†…å®¹ç›®å½•&lt;/strong>ï¼š
åšå®¢å†…å®¹å­˜å‚¨åœ¨ &lt;code>content/posts/&lt;/code> ç›®å½•ä¸‹ã€‚æ¯ç¯‡æ–‡ç« åº”åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œæ”¯æŒå¤šè¯­è¨€ç‰ˆæœ¬ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>åˆ›å»ºæ–°æ–‡ç« &lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>è‹±æ–‡æ–‡ç« ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">hugo new posts/my-new-post/index.en.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>ä¸­æ–‡æ–‡ç« ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">hugo new posts/my-new-post/index.zh-cn.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;p>my-new-postå³ä¸ºæ–°æ–‡ç« çš„æ ‡é¢˜ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç¼–è¾‘æ–‡ç« &lt;/strong>ï¼š
ä½¿ç”¨ä½ å–œæ¬¢çš„æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€ &lt;code>index.en.md&lt;/code> æˆ– &lt;code>index.zh-cn.md&lt;/code> æ–‡ä»¶ï¼Œè¿›è¡Œåšå®¢æ’°å†™ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ·»åŠ æ–‡ç« çš„ Front Matter&lt;/strong>ï¼š
åœ¨æ–‡ç« é¡¶éƒ¨æ·»åŠ å¿…è¦å­—æ®µï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;My New Post&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">date&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="ld">2025-05-09T12:00:00&lt;/span>&lt;span class="m">+08&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">00&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">draft&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">language&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">en&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ol>
&lt;h3 id="2-æœ¬åœ°æŸ¥çœ‹å’Œé¢„è§ˆåšå®¢">(2) æœ¬åœ°æŸ¥çœ‹å’Œé¢„è§ˆåšå®¢ï¼š
&lt;/h3>&lt;ul>
&lt;li>å¯åŠ¨æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">hugo server -D
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>åœ¨æµè§ˆå™¨ä¸­è®¿é—® &lt;a class="link" href="http://localhost:1313" target="_blank" rel="noopener"
>http://localhost:1313&lt;/a> æŸ¥çœ‹é¢„è§ˆæ•ˆæœã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="2-æäº¤å’Œä¸Šä¼ åšå®¢åˆ°-github">2. æäº¤å’Œä¸Šä¼ åšå®¢åˆ° GitHub
&lt;/h2>&lt;h3 id="1-ç¡®ä¿æ‰€æœ‰æ–‡ä»¶è¢«-git-è·Ÿè¸ª">(1) ç¡®ä¿æ‰€æœ‰æ–‡ä»¶è¢« Git è·Ÿè¸ªï¼š
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git add .
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-æäº¤æ›´æ”¹">(2) æäº¤æ›´æ”¹ï¼š
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git commit -m &lt;span class="s2">&amp;#34;Add new blog post or update&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="3-æ¨é€åˆ°-github-ä»“åº“">(3) æ¨é€åˆ° GitHub ä»“åº“ï¼š
&lt;/h3>&lt;ul>
&lt;li>å¦‚æœªé…ç½®è¿œç¨‹ä»“åº“ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git remote add origin https://github.com/KeqiYe/myblog.git
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>æ¨é€ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git push origin main
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul>
&lt;h2 id="3-åˆ é™¤åšå®¢æ–‡ç« -111">3. åˆ é™¤åšå®¢æ–‡ç«  111
&lt;/h2>&lt;h3 id="1-åˆ é™¤æ–‡ç« ç›®å½•">(1) åˆ é™¤æ–‡ç« ç›®å½•ï¼š
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git rm -r content/posts/my-old-post
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="2-æäº¤åˆ é™¤æ“ä½œ">(2) æäº¤åˆ é™¤æ“ä½œï¼š
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git commit -m &lt;span class="s2">&amp;#34;Remove old blog post&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="4-æŸ¥çœ‹å’Œè°ƒè¯•éƒ¨ç½²ç»“æœ">4. æŸ¥çœ‹å’Œè°ƒè¯•éƒ¨ç½²ç»“æœ
&lt;/h2>&lt;ul>
&lt;li>è‹±æ–‡åšå®¢åœ°å€ï¼š&lt;a class="link" href="https://keqiye.github.io/en/" target="_blank" rel="noopener"
>https://keqiye.github.io/en/&lt;/a>&lt;/li>
&lt;li>ä¸­æ–‡åšå®¢åœ°å€ï¼š&lt;a class="link" href="https://keqiye.github.io/zh-cn/" target="_blank" rel="noopener"
>https://keqiye.github.io/zh-cn/&lt;/a>&lt;/li>
&lt;/ul>
&lt;h2 id="5-å¸¸è§é—®é¢˜è§£å†³">5. å¸¸è§é—®é¢˜è§£å†³
&lt;/h2>&lt;ul>
&lt;li>
&lt;p>&lt;strong>æ–‡ç« ä¸æ˜¾ç¤º&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>æ£€æŸ¥ Front Matter çš„ &lt;code>language&lt;/code> å­—æ®µã€‚&lt;/li>
&lt;li>ç¡®è®¤ GitHub Actions å·²æˆåŠŸæ„å»ºéƒ¨ç½²ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>é“¾æ¥é”™è¯¯&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>ç¡®è®¤ &lt;code>baseURL&lt;/code> é…ç½®æ­£ç¡®ï¼š&lt;code>https://keqiye.github.io/&lt;/code>&lt;/li>
&lt;li>æ£€æŸ¥éƒ¨ç½²åˆ†æ”¯å’Œ GitHub Pages è®¾ç½®ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="6-å…¶ä»–å¸¸ç”¨-git-å‘½ä»¤">6. å…¶ä»–å¸¸ç”¨ Git å‘½ä»¤
&lt;/h2>&lt;ul>
&lt;li>æŸ¥çœ‹çŠ¶æ€ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git status
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>æŸ¥çœ‹å†å²ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git log
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>æ’¤é”€å·²æ·»åŠ æ–‡ä»¶ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git restore --staged &amp;lt;file&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>æ’¤é”€æœªæäº¤ä¿®æ”¹ï¼š
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">git restore &amp;lt;file&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;/ul></description></item><item><title>SPH ç²’å­é¢†åŸŸæœç´¢</title><link>https://keqiye.github.io/zh-cn/posts/blog-post-2/</link><pubDate>Fri, 09 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/blog-post-2/</guid><description>&lt;h1 id="sph-ç²’å­é¢†åŸŸæœç´¢">SPH ç²’å­é¢†åŸŸæœç´¢
&lt;/h1>&lt;h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°
&lt;/h2>&lt;p>åœ¨å…‰æ»‘ç²’å­æµä½“åŠ¨åŠ›å­¦ï¼ˆSmoothed Particle Hydrodynamicsï¼Œç®€ç§° SPHï¼‰æ–¹æ³•ä¸­ï¼Œâ€œé‚»å±…æœç´¢â€ï¼ˆNeighbor Searchï¼‰æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„è®¡ç®—ä»»åŠ¡ã€‚å®ƒç›´æ¥å½±å“åˆ°æ¨¡æ‹Ÿçš„æ•ˆç‡ä¸ç²¾åº¦ï¼Œå°¤å…¶åœ¨æ¶‰åŠä¸Šç™¾ä¸‡ç²’å­çš„ä¸‰ç»´é—®é¢˜ä¸­ï¼Œè®¡ç®—ç“¶é¢ˆå¾€å¾€å‡ºç°åœ¨å¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾æ¯ä¸ªç²’å­å‘¨å›´çš„é‚»å±…ä¸Šã€‚&lt;/p>
&lt;p>ç”±äº SPH æ˜¯ä¸€ç§æ— ç½‘æ ¼æ–¹æ³•ï¼Œå¤©ç„¶é€‚åˆå¤„ç†è‡ªç”±è¡¨é¢ã€å¤§å˜å½¢å’Œæ–­è£‚ç­‰å¤æ‚ç‰©ç†ç°è±¡ï¼Œå› æ­¤è¢«å¹¿æ³›åº”ç”¨äºå¤©ä½“ç‰©ç†ã€æµä½“åŠ›å­¦ã€å›ºä½“åŠ›å­¦ç­‰é¢†åŸŸã€‚æˆ‘ä¸»è¦ä»äº‹å°è¡Œæ˜Ÿæ’å‡»é—®é¢˜çš„æ•°å€¼æ¨¡æ‹Ÿç ”ç©¶ï¼Œå¹¶å¼€å‘äº†ä¸€å¥—é’ˆå¯¹è¯¥é—®é¢˜çš„ SPH ä»£ç ã€‚è™½ç„¶ä¸åŒé¢†åŸŸåœ¨å®ç°ç»†èŠ‚ä¸Šå­˜åœ¨å·®å¼‚ï¼Œä½†â€œé‚»å±…æœç´¢â€ä½œä¸ºæ ¸å¿ƒæ¨¡å—ï¼Œå…¶æ•°å­¦æ¨¡å‹ç›¸å¯¹ç®€å•ï¼Œå´å‡ ä¹åœ¨æ‰€æœ‰ SPH å®ç°ä¸­éƒ½ä¸å¯æˆ–ç¼ºã€‚&lt;/p>
&lt;p>æœ¬æ–‡æ—¨åœ¨ç³»ç»Ÿä»‹ç» SPH ä¸­é‚»å±…æœç´¢çš„å¸¸è§ç®—æ³•ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œä»¥åŠåœ¨ CUDA ç­‰å¹¶è¡Œè®¡ç®—å¹³å°ä¸Šçš„å®ç°ï¼Œä½œä¸ºæˆ‘ä¸ªäººå­¦ä¹ ä¸ç ”ç©¶çš„è®°å½•ï¼ŒåŒæ—¶å¸Œæœ›å¯¹åŒé¢†åŸŸçš„ç ”ç©¶è€…æä¾›å‚è€ƒã€‚&lt;/p>
&lt;p>é¦–å…ˆç»™å‡º SPH ç²’å­é‚»å±…æœç´¢çš„æŠ½è±¡æ•°å­¦é—®é¢˜ï¼šè®¾åœ¨ä¸‰ç»´ç©ºé—´ä¸­å­˜åœ¨ \( N \) ä¸ªç²’å­ï¼Œæ¯ä¸ªç²’å­çš„ä½ç½®å·²çŸ¥ï¼Œè®°ä¸º \( \mathbf{x}_i \)ï¼Œæ¯ä¸ªç²’å­æœ‰ä¸€ä¸ªæ ¸é•¿åº¦ï¼ˆsmoothing lengthï¼‰\( h_i \)ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ¯ä¸ªç²’å­ \( i \) çš„é‚»å±…ç²’å­é›†åˆ \( j \)ï¼Œä½¿å¾—æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š&lt;/p>
\[
\|\mathbf{x}_i - \mathbf{x}_j\| &lt; f(h_i, h_j)
\]
&lt;p>å…¶ä¸­ï¼Œå‡½æ•° \( f(h_i, h_j) \) ç”¨äºå®šä¹‰ç²’å­é—´çš„äº¤äº’è·ç¦»ï¼Œå…¶å¸¸è§å®šä¹‰åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>\( f(h_i, h_j) = \eta \cdot \frac{1}{2}(h_i + h_j) \)&lt;/li>
&lt;li>\( f(h_i, h_j) = \eta \cdot \min(h_i, h_j) \)&lt;/li>
&lt;li>\( f(h_i, h_j) = \eta \cdot \max(h_i, h_j) \)&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œï¼Œ\( \eta \) æ˜¯ä¸€ä¸ªæ— é‡çº²ç³»æ•°ï¼Œç§°ä¸º&lt;strong>æ ¸æ”¯æŒåŠå¾„å› å­ï¼ˆkernel support radius factorï¼‰&lt;/strong>ï¼Œé€šå¸¸å–å€¼åœ¨ \( [1.2, 2.5] \) ä¹‹é—´ï¼Œç”¨äºæ§åˆ¶ç²’å­çš„å½±å“èŒƒå›´ï¼ˆæœ¬æ–‡å–2ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨é‚»å±…æœç´¢ä¸­ï¼Œå¸¸è§çš„æ–¹æ³•åŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æš´åŠ›æœç´¢ï¼ˆBrute Forceï¼‰&lt;/strong>ï¼šç®€å•å¯é ï¼Œä½†æ—¶é—´å¤æ‚åº¦é«˜ï¼ˆ$O(N^2)$ï¼‰ï¼Œåœ¨å¤§è§„æ¨¡é—®é¢˜ä¸­æ•ˆç‡ä½ä¸‹ï¼›&lt;/li>
&lt;li>&lt;strong>é“¾è¡¨æœç´¢ï¼ˆLinked-Cell/Grid-basedï¼‰&lt;/strong>ï¼šé€šè¿‡ç©ºé—´åˆ’åˆ†æ˜¾è‘—å‡å°‘æœç´¢ç²’å­æ•°ï¼Œæ˜¯å®é™…ä¸­å¸¸ç”¨çš„é«˜æ•ˆæ–¹æ³•ï¼›&lt;/li>
&lt;li>&lt;strong>æ ‘æœç´¢ï¼ˆå¦‚ Octree æˆ– KD-treeï¼‰&lt;/strong>ï¼šé€‚åˆä¸å‡åŒ€ç²’å­åˆ†å¸ƒï¼Œå°¤å…¶é€‚ç”¨äºå¤©ä½“ç‰©ç†æ¨¡æ‹Ÿä¸­çš„è‡ªé€‚åº”ç²¾åº¦é—®é¢˜ï¼Œè‰¯å¥½çš„æ ‘ä»£ç å…·æœ‰éå¸¸é«˜çš„é²æ£’æ€§ã€‚å¦‚æœè¦è€ƒè™‘è‡ªå¼•åŠ›ï¼Œé‚£ä¹ˆæ ‘æœç´¢æ˜¯æ•ˆç‡å’Œç²¾åº¦éƒ½ä¸é”™çš„é€‰æ‹©ã€‚&lt;/li>
&lt;/ol>
&lt;p>æœ¬æ–‡å°†ä»¥æš´åŠ›æœç´¢ä½œä¸ºç»“æœåŸºçº¿ï¼Œé‡ç‚¹ä»‹ç»å¦‚ä½•é«˜æ•ˆå®ç°é“¾è¡¨æœç´¢å’Œæ ‘æœç´¢ï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬åœ¨å®é™… SPH æ¨¡æ‹Ÿä¸­çš„æ€§èƒ½è¡¨ç°ã€‚&lt;/p>
&lt;h2 id="1-é“¾è¡¨æœç´¢linked-cellgrid-based">1. é“¾è¡¨æœç´¢ï¼ˆLinked-Cell/Grid-basedï¼‰
&lt;/h2>&lt;p>åœ¨å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå³æ‰€æœ‰ç²’å­çš„\( h_i \)éƒ½ç›¸ç­‰ï¼Œåº”ç”¨é“¾è¡¨æœç´¢æ³•éå¸¸æœ‰æ•ˆã€‚Monaghan å’Œ Gingold(1983)æå‡ºï¼Œå¯ä»¥é€šè¿‡å¯¹ç²’å­çš„ç©ºé—´åŒºåŸŸåˆ’åˆ†ç½‘æ ¼ï¼Œè®°å½•æ¯ä¸ªç½‘æ ¼å†…çš„ç²’å­ç¼–å·ã€‚è¿™æ ·åœ¨æœç´¢ç²’å­çš„é‚»å±…æ—¶ï¼Œåªéœ€è¦éå†å½“å‰ç²’å­ç½‘æ ¼çš„é‚»å±…ç½‘æ ¼å†…çš„ç²’å­å³å¯ã€‚æ­¤æ–¹æ³•åœ¨ä¼ ç»ŸSPHä»£ç ä¸­ä½¿ç”¨éå¸¸å¤šï¼Œå¦‚Monaghan(1985)ï¼ŒRhoades(1992)ï¼ŒSimpson(1995)ç­‰ã€‚&lt;/p>
&lt;p>åœ¨å®ç°é“¾è¡¨ç®—æ³•æ—¶ï¼Œè¦åœ¨é—®é¢˜åŸŸä¸Šé“ºè®¾ä¸€ä¸´æ—¶ç½‘æ ¼ã€‚ç½‘æ ¼å•å…ƒçš„ç©ºé—´å¤§å°åº”é€‰å–ä¸æ”¯æŒåŸŸçš„ç©ºé—´å¤§å°ä¸€è‡´ã€‚è‹¥å…‰æ»‘å‡½æ•°æ”¯æŒåŸŸçš„è®¡é‡å°ºåº¦ä¸º \( \eta h \)ï¼Œåˆ™ç½‘æ ¼å•å…ƒçš„å°ºåº¦ä¹Ÿå¿…é¡»è®¾ç½®ä¸º \( \eta h \)ã€‚é‚£ä¹ˆï¼Œå¯¹äºç»™å®šçš„ç²’å­iï¼Œå…¶ç›¸é‚»ç²’å­åªèƒ½åœ¨åŒä¸€ç½‘æ ¼å•å…ƒå†…ï¼Œæˆ–è€…åœ¨ç´§å¯†ç›¸é‚»çš„å•å…ƒå†…ã€‚æ‰€ä»¥ï¼Œå½“ \( \eta = 2 \) æ—¶ï¼Œåœ¨ä¸€ç»´ã€äºŒç»´å’Œä¸‰ç»´ç©ºé—´é‡Œçš„æœç´¢èŒƒå›´åˆ†åˆ«æ˜¯åœ¨ 3,9,27 ä¸ªå•å…ƒå†…ã€‚é“¾è¡¨æœç´¢æ³•å°†æ¯ä¸ªç²’å­éƒ½åˆ†å¸ƒåœ¨ç½‘æ ¼å•å…ƒå†…ï¼Œå¹¶é€šè¿‡ç®€å•çš„å­˜å‚¨è§„åˆ™å°†æ¯ä¸ªç½‘æ ¼å†…çš„æ‰€æœ‰ç²’å­è¿æ¥èµ·æ¥ã€‚è‹¥æ¯ä¸ªå•å…ƒå†…çš„å¹³å‡ç²’å­æ•°é‡è¶³å¤Ÿå°ï¼Œåˆ™é“¾è¡¨æœç´¢æ³•çš„å¤æ‚åº¦é˜¶æ•°ä¸º \( O(N) \)ã€‚&lt;/p>
&lt;p>é“¾è¡¨æœç´¢æ³•å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå½“å…‰æ»‘é•¿åº¦å¯å˜æ—¶ï¼Œå°¤å…¶æ˜¯æ¨¡æ‹Ÿåˆ†è¾¨ç‡å˜åŒ–çš„é—®é¢˜æ—¶ï¼Œç½‘æ ¼ç©ºé—´å°±ä¸èƒ½é€‚åº”æ¯ä¸€ä¸ªç²’å­ï¼Œæ­¤æ—¶è‹¥å†åº”ç”¨é“¾è¡¨æœç´¢æ³•ï¼Œåˆ™æœç´¢æ•ˆç‡ä¼šå¾ˆä½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æ–¹æ³•åœ¨CUDAä¸Šå®ç°æ—¶ï¼Œéœ€è¦å¯¹æ˜¾å­˜åˆ†é…è¿›è¡Œå°å¿ƒå¤„ç†ï¼Œä¸ç„¶å¾ˆå®¹æ˜“å ç”¨è¶…å¤§æ˜¾å­˜ï¼ˆä¸»è¦åœ¨å­˜å‚¨ç½‘æ ¼ç²’å­ç¼–å·æ—¶ï¼‰ã€‚ä¸‹é¢é¦–å…ˆå°±å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„æƒ…å†µä¸‹è¿›è¡Œä»£ç è¯´æ˜ã€‚&lt;/p>
&lt;h3 id="å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„é“¾è¡¨æœç´¢">å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„é“¾è¡¨æœç´¢
&lt;/h3>&lt;p>æˆ‘ä»¬å…ˆæ¥çœ‹é“¾è¡¨æœç´¢ç®—æ³•çš„åŸºç¡€ç‰ˆæœ¬ã€‚å®ç°è¯¥ç®—æ³•éœ€è¦ä¸¤ä¸ªæ­¥éª¤ï¼š&lt;/p>
&lt;ol>
&lt;li>è®°å½•æ¯ä¸ªç½‘æ ¼å•å…ƒä¸­åŒ…å«å“ªäº›ç²’å­ï¼Œå¹¶è®°å½•æ¯ä¸ªç²’å­æ‰€å±çš„å•å…ƒï¼›&lt;/li>
&lt;li>éå†æ‰€æœ‰ç²’å­ï¼Œå¯¹æ¯ä¸ªç²’å­çš„å•å…ƒåŠå…¶é‚»æ¥å•å…ƒè¿›è¡Œæ‰«æï¼ŒæŸ¥æ‰¾å¯èƒ½çš„é‚»å±…ç²’å­ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæœ¬æ–‡åªå±•ç¤ºæ ¸å‡½æ•°çš„ç¼–å†™ï¼Œä¸”ä¸åœ¨æ¯æ¬¡è°ƒç”¨ä¸­åå¤ç”³è¯·æˆ–é‡Šæ”¾å†…å­˜ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ ¸å‡½æ•°è¾ƒä¸ºç®€å•ï¼Œå…¶ç”¨äºæ„å»ºç²’å­ä¸ç½‘æ ¼å•å…ƒä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚&lt;/p>
&lt;h4 id="æ ¸å‡½æ•°å£°æ˜ä¸ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—">æ ¸å‡½æ•°å£°æ˜ä¸ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—
&lt;/h4>&lt;p>ä¸‹é¢æ˜¯ç”¨äºå»ºç«‹ç²’å­ä¸ç½‘æ ¼å•å…ƒä¹‹é—´æ˜ å°„å…³ç³»çš„ CUDA æ ¸å‡½æ•° &lt;code>particleLoop&lt;/code>ï¼Œä»¥åŠé…å¥—çš„ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—å‡½æ•° &lt;code>particleGridIndex&lt;/code>ã€‚æœ¬ç‰ˆæœ¬å‡è®¾æ‰€æœ‰ç²’å­çš„æ ¸é•¿åº¦ $h$ æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè®°ä¸º &lt;code>h[0]&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define DIM 3 // ç©ºé—´ç»´åº¦ï¼šå¯è®¾ä¸º 1, 2 æˆ– 3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define MAX_PARTICLES_PER_GRID 200 // æ¯ä¸ªç½‘æ ¼å•å…ƒæœ€å¤šå¯å®¹çº³çš„ç²’å­æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define eta 2 // æ ¸é•¿åº¦æ¯”ä¾‹å› å­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">//&lt;/span> &lt;span class="n">CUDA&lt;/span> &lt;span class="err">æ ¸å‡½æ•°ï¼šæ„å»ºæ¯ä¸ªç²’å­æ‰€å±ç½‘æ ¼ï¼Œä»¥åŠæ¯ä¸ªç½‘æ ¼ä¸­çš„ç²’å­åˆ—è¡¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__global__&lt;/span> &lt;span class="n">void&lt;/span> &lt;span class="n">particleLoop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">åæ ‡ï¼Œé•¿åº¦ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">æ–¹å‘æœ€å°åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">æ–¹å‘ç½‘æ ¼æ•°&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">ceil&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">maxx&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">Î·&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="err">åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 2 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="err">åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­çš„æ ¸é•¿åº¦ï¼ˆæ­¤ç‰ˆæœ¬ä¸ºå¸¸é‡ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼ä¸­ç²’å­ç´¢å¼•åˆ—è¡¨ï¼Œå¤§å°ä¸º&lt;/span> &lt;span class="n">numGrids&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="err">æ— é¡»åˆå§‹åŒ–&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ä¸ºé¿å…æ•°æ®ç«äº‰ï¼Œä½¿ç”¨ä¸€ä¸ª&lt;/span>&lt;span class="n">gridWritingPointeræ¥è®°å½•å†™å…¥ä½ç½®&lt;/span>&lt;span class="err">ï¼Œé•¿åº¦ä¸º&lt;/span>&lt;span class="n">numGrids&lt;/span>&lt;span class="err">ï¼Œéœ€è¦åˆå§‹åŒ–ä¸º&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">particleGridList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­æ‰€å±ç½‘æ ¼ç´¢å¼•ï¼Œé•¿åº¦ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­æ€»æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numGrids&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼æ€»æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">tid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è®¡ç®—ç²’å­åœ¨ç½‘æ ¼ä¸­çš„ç´¢å¼•åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">Î·&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è·å–ç²’å­æ‰€åœ¨ç½‘æ ¼çš„çº¿æ€§ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">gridIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM == 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#elif DIM == 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else // DIM == 3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">particleGridList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è·å–å½“å‰ç½‘æ ¼çš„&lt;/span>&lt;span class="n">gridWritingPointerä½ç½®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">writingPointer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">atomicAdd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">gridIndex&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">atomicAddè¿”å›å†™å…¥ä½ç½®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">gridIndex&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">writingPointer&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ä¸Šè¿°å‡½æ•°æ—¶è¦æ³¨æ„ï¼Œå½“ç½‘æ ¼ä¸ªæ•°å¾ˆå¤šæ—¶ï¼Œå®¹æ˜“è¶…è¿‡intçš„è¡¨è¾¾èŒƒå›´ã€‚æ­¤å¤–ï¼Œå‰ç½®æ¡ä»¶æ˜¯éœ€è¦çŸ¥é“æœ€å°å’Œæœ€å¤§çš„ç²’å­åæ ‡ï¼Œé•¿æ•°ç»„æ±‚æœ€å¤§æœ€å°å€¼å¯ä»¥ä½¿ç”¨scanç®—æ³•ï¼Œä»¥åæœ‰ç©ºä¹Ÿä¼šä»‹ç»æ­¤ç±»ç®—æ³•ã€‚&lt;/p>
&lt;p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å»ºç«‹äº†ç©ºé—´ç²’å­ä¸ç½‘æ ¼ä¹‹é—´çš„è”ç³»ï¼Œç°åœ¨å¯ä»¥éå†ç²’å­ï¼Œè·å–ä»–ä»¬çš„é‚»å±…ç²’å­ã€‚æˆ‘ç›®å‰æƒ³åˆ°ä¸¤ç§éå†æ–¹æ³•ï¼Œ1. æŒ‰ç²’å­é¡ºåºéå†ï¼ˆä¸‹é¢ç§°A1ï¼‰ 2. æŒ‰ç½‘æ ¼é¡ºåºéå†ï¼ˆä¸‹é¢ç§°A1ï¼‰ã€‚&lt;/p>
&lt;h4 id="æœç´¢">æœç´¢
&lt;/h4>&lt;h5 id="æŒ‰ç²’å­é¡ºåºéå†a1">æŒ‰ç²’å­é¡ºåºéå†(A1)
&lt;/h5>&lt;p>é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªéå†æ–¹æ³•ï¼šæŒ‰ç²’å­é¡ºåºéå†(A1)ã€‚äº‹å®ä¸Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define MAX_NEIGHBORS 200 // æ¯ä¸ªç²’å­æœ€å¤šçš„é‚»å±…æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__global__&lt;/span> &lt;span class="n">void&lt;/span> &lt;span class="n">neighborSearchByParticles&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼ä¸­ç²’å­ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç½‘æ ¼ä¸­çš„ç²’å­æ•°é‡ï¼ˆå·²ç”±&lt;/span>&lt;span class="n">atomicAddæ›´æ–°&lt;/span>&lt;span class="err">ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">particleGridList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­æ‰€åœ¨ç½‘æ ¼ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">neighborList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">è¾“å‡ºï¼šæ¯ä¸ªç²’å­çš„é‚»å±…åˆ—è¡¨ï¼Œå¤§å°ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">neighborCount&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">è¾“å‡ºï¼šæ¯ä¸ªç²’å­çš„é‚»å±…æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">tid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">xi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">yi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">zi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">hi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">hi2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hi&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">hi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">particleGridList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è®¡ç®—è¯¥ç²’å­æ‰€åœ¨ç½‘æ ¼çš„åæ ‡ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">gridIndex&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">éå†è¯¥ç²’å­æ‰€åœ¨ç½‘æ ¼åŠå…¶å‘¨å›´&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="n">x3x3&lt;/span> &lt;span class="err">ç½‘æ ¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nix&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dy&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dy&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">niy&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dz&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">niz&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">ç›¸é‚»ç½‘æ ¼ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">neighborGrid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">npg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">neighborGrid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">npg&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">neighborGrid&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">tid&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">xi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">yi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">zi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dist2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dx&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dy&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dy&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dz&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dz&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">dist2&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">hi2&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighborList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighborCount&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>äº‹å®ä¸Šï¼Œ&lt;code>particleGridList&lt;/code> æ•°ç»„æ˜¯ä¸“é—¨ä¸º &lt;strong>A1 æ–¹æ¡ˆ&lt;/strong> è®¾è®¡çš„ï¼›è€Œè‹¥é‡‡ç”¨ &lt;strong>A2 æ–¹æ¡ˆ&lt;/strong>ï¼Œåˆ™æ— éœ€è¯¥æ•°ç»„ã€‚&lt;/p>
&lt;p>A1 çš„ç¼ºç‚¹åœ¨äºï¼šå½“ç²’å­åœ¨æ•°ç»„ä¸­å‘ˆéšæœºæ’å¸ƒæ—¶ï¼Œçº¿ç¨‹æŸï¼ˆwarpï¼‰ä¹‹é—´å¯¹ç²’å­å±æ€§å’Œç½‘æ ¼æ•°æ®çš„è®¿é—®ä¹Ÿå°†æ˜¯éšæœºçš„ã€‚åœ¨ CUDA ç¼–ç¨‹ä¸­ï¼Œè®¿å­˜æ¨¡å¼å¯¹æ€§èƒ½å½±å“æå¤§ï¼Œå› æ­¤å¯ä»¥é¢„æœŸ A1 çš„æ•ˆç‡ä¸ä¼šéå¸¸ç†æƒ³ã€‚&lt;/p>
&lt;p>åœ¨ä¸€ä¸ªå¤±çœ çš„æ·±å¤œï¼Œæˆ‘æ€è€ƒäº†ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å¦‚ä½•ä¼˜åŒ– A1 çš„è®¿å­˜æ¨¡å¼ï¼Ÿ&lt;/strong>&lt;/li>
&lt;li>&lt;strong>å½“ç²’å­çš„æ ¸å°ºåº¦ \( h \) ç›¸å·®æ‚¬æ®Šï¼ˆä¾‹å¦‚åœ¨æ¨¡æ‹Ÿæœˆçƒé­å—å°è¡Œæ˜Ÿæ’å‡»æ—¶ï¼Œ\(h_{min} â‰ˆ 1\)ï¼Œ\(h_{max} â‰ˆ 500\)ï¼‰ï¼Œå¦‚ä½•åœ¨é“¾è¡¨ç»“æ„ä¸­é«˜æ•ˆæ”¯æŒå¦‚æ­¤å¤§çš„è·¨åº¦ï¼Ÿ&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>å…³äºè¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘å„è‡ªæœ‰ä¸€äº›è®¾æƒ³å’Œåˆæ­¥å®ç°ï¼Œæ¥ä¸‹æ¥å°†é€ä¸€ä»‹ç»ï¼Œå¹¶è¿›è¡Œæµ‹è¯•å’Œåˆ†æã€‚&lt;/p>
&lt;hr>
&lt;h4 id="a2æŒ‰ç½‘æ ¼é¡ºåºéå†ç²’å­">A2ï¼šæŒ‰ç½‘æ ¼é¡ºåºéå†ç²’å­
&lt;/h4>&lt;p>ï¼ˆæ­¤å¤„è¡¥å…… A2 çš„å®ç°ç®€ä»‹å’Œæ€§èƒ½ç‰¹ç‚¹ã€‚ï¼‰
æ›´å¤šå…³äºæ ‘æœç´¢çš„å†…å®¹å¯ä»¥å‚è§[æ ‘æœç´¢]æ›´å¤šå…³äºæ ‘æœç´¢çš„å†…å®¹å¯ä»¥å‚è§&lt;a class="link" href="https://keqiye.github.io/posts/SPH_neighbor_search/tree_search/" >æ ‘æœç´¢&lt;/a>.&lt;/p>
&lt;h3 id="ç¼ºé™·">ç¼ºé™·
&lt;/h3>&lt;p>ç½‘æ ¼æœç´¢æˆ‘ä¸ªäººæ„Ÿè§‰æ•ˆç‡æ˜¯æ¯”æ ‘æœç´¢å¥½çš„ï¼Œå°¤å…¶æ˜¯å½“ç²’å­çš„å…‰æ»‘é•¿åº¦éƒ½ä¸€è‡´æˆ–è€…å·®ä¸å¤šçš„æ—¶å€™ã€‚ç¼ºç‚¹åœ¨äºï¼Œå¦‚æœç²’å­åœ¨ç©ºé—´ä¸­åˆ†æ•£çš„éå¸¸å¹¿æ³›ï¼Œæ¯”å¦‚æ’å‡»å¼•èµ·çš„dustå–·å‘ã€‚è¿™ä¼šå¯¼è‡´ç½‘æ ¼æ•°é‡æ¿€å¢ï¼Œæ˜¾å­˜å¾ˆå¿«å°±ä¼šç”¨å…‰ï¼Œå¯¼è‡´è®¡ç®—å¤±è´¥ã€‚å› æ­¤ç½‘æ ¼æœç´¢è¿˜æ˜¯é€‚åˆæ¨¡æ‹Ÿç©ºé—´åˆ†å¸ƒç¨³å®šçš„é—®é¢˜ï¼Œæ¯”å¦‚æºƒåã€‚&lt;/p></description></item><item><title>åŸºäºè‡ªé€‚åº”æ­¥é•¿ Runge-Kutta æ–¹æ³•çš„ SPH è®¡ç®—æµç¨‹</title><link>https://keqiye.github.io/zh-cn/posts/sph-adaptive-rk/</link><pubDate>Thu, 23 May 2024 10:30:00 +0800</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/sph-adaptive-rk/</guid><description>&lt;h2 id="1-å¼•è¨€">1. å¼•è¨€
&lt;/h2>&lt;p>åœ¨æµä½“åŠ¨åŠ›å­¦çš„æ•°å€¼æ¨¡æ‹Ÿä¸­ï¼Œå…‰æ»‘ç²’å­æµä½“åŠ¨åŠ›å­¦ï¼ˆSmoothed Particle Hydrodynamics, SPHï¼‰æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨çš„æ— ç½‘æ ¼æ‹‰æ ¼æœ—æ—¥æ–¹æ³•ã€‚SPHæ–¹æ³•çš„æ ¸å¿ƒä¹‹ä¸€æ˜¯å¯¹æ§åˆ¶æ–¹ç¨‹ç»„è¿›è¡Œæ—¶é—´ç§¯åˆ†ï¼Œä»¥æ›´æ–°æ¯ä¸ªç²’å­çš„ç‰©ç†çŠ¶æ€ã€‚&lt;/p>
&lt;p>ä¼ ç»Ÿçš„æ—¶é—´ç§¯åˆ†æ–¹æ¡ˆï¼ˆå¦‚ç®€å•çš„æ¬§æ‹‰æ³•æˆ–å›ºå®šæ­¥é•¿çš„é¾™æ ¼-åº“å¡”æ³•ï¼‰è™½ç„¶å®ç°ç®€å•ï¼Œä½†åœ¨å¤„ç†å¤æ‚åŠ¨æ€è¿‡ç¨‹æ—¶é¢ä¸´æŒ‘æˆ˜ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>æ­¥é•¿è¿‡å¤§&lt;/strong>å¯èƒ½å¯¼è‡´æ•°å€¼ä¸ç¨³å®šï¼Œæ¨¡æ‹Ÿå‘æ•£ã€‚&lt;/li>
&lt;li>&lt;strong>æ­¥é•¿è¿‡å°&lt;/strong>åˆ™ä¼šæå¤§åœ°å¢åŠ è®¡ç®—æˆæœ¬ï¼Œå°¤å…¶æ˜¯åœ¨æ¨¡æ‹Ÿè¿‡ç¨‹ç›¸å¯¹å¹³ç¨³çš„é˜¶æ®µã€‚&lt;/li>
&lt;/ul>
&lt;p>ä¸ºäº†åœ¨ä¿è¯è®¡ç®—ç²¾åº¦çš„åŒæ—¶æé«˜æ•ˆç‡ï¼Œ&lt;strong>è‡ªé€‚åº”æ­¥é•¿ï¼ˆAdaptive Time-Steppingï¼‰&lt;/strong> çš„ç§¯åˆ†æ–¹æ³•åº”è¿è€Œç”Ÿã€‚æœ¬æ–‡å°†è¯¦ç»†ä»‹ç»å¦‚ä½•å°†è‡ªé€‚åº”æ­¥é•¿çš„ Runge-Kutta (RK) æ–¹æ³•åº”ç”¨äº SPH çš„è®¡ç®—æµç¨‹ä¸­ã€‚&lt;/p>
&lt;h2 id="2-sph-æ ¸å¿ƒæ–¹ç¨‹">2. SPH æ ¸å¿ƒæ–¹ç¨‹
&lt;/h2>&lt;p>åœ¨ SPH ä¸­ï¼Œæµä½“è¢«ç¦»æ•£ä¸ºä¸€ç³»åˆ—æºå¸¦ç‰©ç†å±æ€§ï¼ˆè´¨é‡ã€å¯†åº¦ã€é€Ÿåº¦ç­‰ï¼‰çš„ç²’å­ã€‚å…¶çŠ¶æ€æ¼”åŒ–ç”±ä¸€ç»„å¸¸å¾®åˆ†æ–¹ç¨‹ï¼ˆODEï¼‰æè¿°ï¼Œä¸»è¦åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>è¿ç»­æ€§æ–¹ç¨‹ï¼ˆå¯†åº¦æ¼”åŒ–ï¼‰&lt;/strong>:
&lt;/p>
$$
\frac{d\rho_i}{dt} = \sum_j m_j (\mathbf{v}_i - \mathbf{v}_j) \cdot \nabla_i W_{ij}
$$
&lt;/li>
&lt;li>
&lt;p>&lt;strong>åŠ¨é‡æ–¹ç¨‹ï¼ˆé€Ÿåº¦æ¼”åŒ–ï¼‰&lt;/strong>:
&lt;/p>
$$
\frac{d\mathbf{v}_i}{dt} = -\sum_j m_j \left( \frac{p_i}{\rho_i^2} + \frac{p_j}{\rho_j^2} + \Pi_{ij} \right) \nabla_i W_{ij} + \mathbf{g}
$$
&lt;/li>
&lt;/ul>
&lt;p>å…¶ä¸­ï¼Œ&lt;code>i&lt;/code> å’Œ &lt;code>j&lt;/code> æ˜¯ç²’å­ç´¢å¼•ï¼Œ&lt;code>m&lt;/code> æ˜¯è´¨é‡ï¼Œ&lt;code>Ï&lt;/code> æ˜¯å¯†åº¦ï¼Œ&lt;code>p&lt;/code> æ˜¯å‹åŠ›ï¼Œ&lt;code>v&lt;/code> æ˜¯é€Ÿåº¦ï¼Œ&lt;code>Î &lt;/code> æ˜¯äººå·¥ç²˜æ€§é¡¹ï¼Œ&lt;code>g&lt;/code> æ˜¯å¤–åŠ›ï¼ˆå¦‚é‡åŠ›ï¼‰ï¼Œ&lt;code>W&lt;/code> æ˜¯æ ¸å‡½æ•°ã€‚&lt;/p>
&lt;h2 id="3-è‡ªé€‚åº”æ­¥é•¿-runge-kutta-æ–¹æ³•">3. è‡ªé€‚åº”æ­¥é•¿ Runge-Kutta æ–¹æ³•
&lt;/h2>&lt;p>è‡ªé€‚åº”æ­¥é•¿çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨æ¯ä¸ªç§¯åˆ†æ­¥ä¸­ï¼Œé€šè¿‡æ¯”è¾ƒä¸¤ç§ä¸åŒç²¾åº¦çš„è®¡ç®—ç»“æœæ¥ä¼°è®¡å±€éƒ¨æˆªæ–­è¯¯å·®ï¼ˆLocal Truncation Errorï¼‰ã€‚æ ¹æ®è¯¯å·®çš„å¤§å°ï¼ŒåŠ¨æ€åœ°è°ƒæ•´ä¸‹ä¸€æ­¥çš„æ—¶é—´æ­¥é•¿ &lt;code>Î”t&lt;/code>ã€‚&lt;/p>
&lt;p>ä¸€ä¸ªç»å…¸çš„ä¾‹å­æ˜¯ &lt;strong>RK45&lt;/strong>ï¼ˆæˆ–ç§° Dormand-Princeã€Cash-Karp æ–¹æ³•ï¼‰ï¼Œå®ƒåœ¨ä¸€ä¸ªæ­¥é•¿å†…åŒæ—¶è®¡ç®—å‡ºä¸€ä¸ªå››é˜¶ç²¾åº¦å’Œä¸€ä¸ªäº”é˜¶ç²¾åº¦çš„è§£ã€‚&lt;/p>
&lt;p>&lt;strong>åŸºæœ¬é€»è¾‘å¦‚ä¸‹&lt;/strong>:&lt;/p>
&lt;ol>
&lt;li>ç”¨ä¸€ä¸ª &lt;code>Î”t&lt;/code> è®¡ç®—å‡ºå››é˜¶è§£ &lt;code>yâ‚„&lt;/code> å’Œäº”é˜¶è§£ &lt;code>yâ‚…&lt;/code>ã€‚&lt;/li>
&lt;li>è®¡ç®—è¯¯å·® &lt;code>Îµ = ||yâ‚… - yâ‚„||&lt;/code>ã€‚&lt;/li>
&lt;li>å°†è¯¯å·® &lt;code>Îµ&lt;/code> ä¸é¢„è®¾çš„å®¹å¿åº¦ &lt;code>tol&lt;/code> æ¯”è¾ƒã€‚
&lt;ul>
&lt;li>å¦‚æœ &lt;code>Îµ &amp;lt;= tol&lt;/code>ï¼šæ¥å—æœ¬æ¬¡è®¡ç®—ç»“æœï¼ˆé€šå¸¸ä½¿ç”¨æ›´é«˜é˜¶çš„ &lt;code>yâ‚…&lt;/code> ä½œä¸ºæœ€ç»ˆç»“æœï¼‰ï¼Œå¹¶å¯ä»¥é€‚å½“å¢å¤§å¤§ä¸‹ä¸€è½®çš„æ­¥é•¿ &lt;code>Î”t&lt;/code>ã€‚&lt;/li>
&lt;li>å¦‚æœ &lt;code>Îµ &amp;gt; tol&lt;/code>ï¼šæ‹’ç»æœ¬æ¬¡è®¡ç®—ï¼Œå‡å°æ­¥é•¿ &lt;code>Î”t&lt;/code>ï¼Œå¹¶ç”¨æ–°çš„å°æ­¥é•¿é‡æ–°è®¡ç®—å½“å‰æ­¥ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æ­¥é•¿è°ƒæ•´çš„å¸¸ç”¨å…¬å¼ä¸ºï¼š
&lt;/p>
$$
\Delta t_{\text{new}} = \Delta t_{\text{old}} \times \text{safe} \times \left( \frac{\text{tol}}{\epsilon} \right)^{p}
$$
&lt;p>
å…¶ä¸­ &lt;code>safe&lt;/code> æ˜¯ä¸€ä¸ªå®‰å…¨å› å­ï¼ˆå¦‚0.9ï¼‰ï¼Œ&lt;code>p&lt;/code> æ˜¯ä¸€ä¸ªä¸æ–¹æ³•é˜¶æ•°ç›¸å…³çš„æŒ‡æ•°ã€‚&lt;/p>
&lt;h2 id="3-è‡ªé€‚åº”æ­¥é•¿-runge-kutta-æ–¹æ³•-rk45">3. è‡ªé€‚åº”æ­¥é•¿ Runge-Kutta æ–¹æ³• (RK45)
&lt;/h2>&lt;p>ä¸ºäº†åœ¨ SPH æ¨¡æ‹Ÿä¸­å®ç°æ•ˆç‡ä¸ç²¾åº¦çš„å¹³è¡¡ï¼Œæˆ‘ä»¬ä¸èƒ½ç®€å•åœ°ä¾èµ–å›ºå®šæ­¥é•¿ç§¯åˆ†ã€‚è‡ªé€‚åº”æ­¥é•¿ï¼ˆAdaptive Time-Steppingï¼‰æ–¹æ³•ï¼Œç‰¹åˆ«æ˜¯åŸºäº Runge-Kutta-Fehlberg çš„ &lt;strong>RK45&lt;/strong> ç®—æ³•ï¼Œæä¾›äº†ä¸€ç§ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒåœ¨æ¯ä¸ªæ—¶é—´æ­¥å†…ï¼Œé€šè¿‡å·§å¦™åœ°è®¡ç®—ä¸¤æ¬¡ï¼ˆä¸€æ¬¡å››é˜¶ç²¾åº¦ï¼Œä¸€æ¬¡äº”é˜¶ç²¾åº¦ï¼‰ï¼Œæ¥ä¼°è®¡å¹¶æ§åˆ¶å±€éƒ¨æˆªæ–­è¯¯å·®ã€‚&lt;/p>
&lt;h3 id="31-rk45-çš„æ ¸å¿ƒæ€æƒ³">3.1 RK45 çš„æ ¸å¿ƒæ€æƒ³
&lt;/h3>&lt;p>RK45 çš„ç²¾é«“åœ¨äºâ€œç”¨ä¸€æ¬¡è®¡ç®—ï¼Œå¾—ä¸¤ä¸ªç»“æœâ€ã€‚é€šè¿‡ç²¾å¿ƒé€‰æ‹©çš„ä¸€ç»„ç³»æ•°ï¼ˆå¦‚ Dormand-Prince æˆ– Cash-Karp ç³»æ•°ï¼‰ï¼Œå®ƒå¯ä»¥ç”¨6æ¬¡å‡½æ•°æ±‚å€¼ï¼ˆè®¡ç®—&lt;code>k1&lt;/code>åˆ°&lt;code>k6&lt;/code>ï¼‰åŒæ—¶å¾—åˆ°ä¸€ä¸ªå››é˜¶ç²¾åº¦çš„è§£ &lt;code>y_{n+1}^{(4)}&lt;/code> å’Œä¸€ä¸ªäº”é˜¶ç²¾åº¦çš„è§£ &lt;code>y_{n+1}^{(5)}&lt;/code>ã€‚&lt;/p>
&lt;p>RK45 çš„ç²¾é«“åœ¨äºâ€œç”¨ä¸€æ¬¡è®¡ç®—ï¼Œå¾—ä¸¤ç§ä¸åŒé˜¶æ•°çš„è§£â€ã€‚è¿™ä¾èµ–äºä¸€ç»„ç²¾å¿ƒè®¾è®¡çš„ç³»æ•°ï¼Œå…¶ä¸­æœ€è‘—åå’Œå¹¿æ³›ä½¿ç”¨çš„æ˜¯ &lt;strong>Dormand-Prince 5(4) å¯¹&lt;/strong>ï¼Œè¿™ä¹Ÿæ˜¯ MATLAB &lt;code>ode45&lt;/code> çš„é»˜è®¤é€‰æ‹©ã€‚&lt;/p>
&lt;p>è¿™ä¸ªæ–¹æ³•éœ€è¦è¿›è¡Œ &lt;strong>7 æ¬¡&lt;/strong>å‡½æ•°æ±‚å€¼ï¼ˆè®¡ç®— &lt;code>k_1&lt;/code> åˆ° &lt;code>k_7&lt;/code>ï¼‰ï¼Œç„¶åç”¨è¿™äº› &lt;code>k&lt;/code> çš„çº¿æ€§ç»„åˆæ¥æ„é€ è§£ã€‚&lt;/p>
&lt;p>&lt;strong>1. è®¡ç®—ä¸­é—´æ–œç‡ (k_i):&lt;/strong>
&lt;/p>
$$
\begin{aligned}
k_1 &amp;= f(t_n, y_n) \\
k_2 &amp;= f(t_n + c_2 h, y_n + h(a_{21}k_1)) \\
k_3 &amp;= f(t_n + c_3 h, y_n + h(a_{31}k_1 + a_{32}k_2)) \\
&amp;\vdots \\
k_7 &amp;= f(t_n + c_7 h, y_n + h(a_{71}k_1 + \dots + a_{76}k_6))
\end{aligned}
$$
&lt;p>&lt;strong>2. æ„é€ è§£ï¼š&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>äº”é˜¶è§£ (æ›´é«˜ç²¾åº¦ï¼Œç”¨äºæ›´æ–°çŠ¶æ€):&lt;/strong>
&lt;/p>
$$
y_{n+1}^{(5)} = y_n + h \left( b_1 k_1 + b_2 k_2 + b_3 k_3 + b_4 k_4 + b_5 k_5 + b_6 k_6 + b_7 k_7 \right)
$$
&lt;p>
åœ¨ Dormand-Prince æ–¹æ³•ä¸­ï¼Œä¸ºäº†æ•ˆç‡ï¼Œ&lt;code>b_7&lt;/code> è¢«è®¾è®¡ä¸º 0ï¼Œæ‰€ä»¥ &lt;code>k_7&lt;/code> å®é™…ä¸Šä¸å‚ä¸ &lt;code>y_{n+1}^{(5)}&lt;/code> çš„è®¡ç®—ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å››é˜¶åµŒå…¥è§£ (æ›´ä½ç²¾åº¦ï¼Œä»…ç”¨äºè¯¯å·®ä¼°è®¡):&lt;/strong>
&lt;/p>
$$
y_{n+1}^{(4)} = y_n + h \left( b_1^* k_1 + b_2^* k_2 + b_3^* k_3 + b_4^* k_4 + b_5^* k_5 + b_6^* k_6 + b_7^* k_7 \right)
$$
&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>3. è®¡ç®—è¯¯å·®ä¼°è®¡:&lt;/strong>&lt;/p>
&lt;p>å±€éƒ¨æˆªæ–­è¯¯å·® &lt;code>E_{n+1}&lt;/code> å¯ä»¥é€šè¿‡ä¸¤ä¸ªè§£çš„å·®æ¥é«˜æ•ˆè®¡ç®—ï¼š
&lt;/p>
$$
E_{n+1} \approx \left\| y_{n+1}^{(5)} - y_{n+1}^{(4)} \right\| = h \left\| \sum_{i=1}^{7} (b_i - b_i^*) k_i \right\| = h \left\| \sum_{i=1}^{7} e_i k_i \right\|
$$
&lt;p>
å…¶ä¸­ &lt;code>e_i = b_i - b_i^*&lt;/code> æ„æˆäº†è¯¯å·®ç³»æ•°å‘é‡ã€‚&lt;/p>
&lt;h3 id="dormand-prince-54-ç³»æ•°è¡¨">Dormand-Prince 5(4) ç³»æ•°è¡¨
&lt;/h3>&lt;p>ä¸‹é¢æ˜¯å®Œæ•´çš„ç³»æ•°ï¼Œé€šå¸¸ä»¥ &lt;strong>Butcher è¡¨&lt;/strong> çš„å½¢å¼å±•ç°ï¼š&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>c&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;th>a&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;th>&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>0&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1/5&lt;/td>
&lt;td>&lt;/td>
&lt;td>1/5&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>3/10&lt;/td>
&lt;td>&lt;/td>
&lt;td>3/40&lt;/td>
&lt;td>9/40&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>4/5&lt;/td>
&lt;td>&lt;/td>
&lt;td>44/45&lt;/td>
&lt;td>-56/15&lt;/td>
&lt;td>32/9&lt;/td>
&lt;td>&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>8/9&lt;/td>
&lt;td>&lt;/td>
&lt;td>19372/6561&lt;/td>
&lt;td>-25360/2187&lt;/td>
&lt;td>64448/6561&lt;/td>
&lt;td>-212/729&lt;/td>
&lt;td>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>&lt;/td>
&lt;td>9017/3168&lt;/td>
&lt;td>-355/33&lt;/td>
&lt;td>46732/5247&lt;/td>
&lt;td>49/176&lt;/td>
&lt;td>-5103/18656&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>1&lt;/td>
&lt;td>&lt;/td>
&lt;td>35/384&lt;/td>
&lt;td>0&lt;/td>
&lt;td>500/1113&lt;/td>
&lt;td>125/192&lt;/td>
&lt;td>-2187/6784&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>&lt;strong>æƒé‡ç³»æ•° &lt;code>b&lt;/code> å’Œ &lt;code>b*&lt;/code>:&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>&lt;code>b&lt;/code> (äº”é˜¶ç²¾åº¦):&lt;/strong>
&lt;code>[ 35/384, 0, 500/1113, 125/192, -2187/6784, 11/84, 0 ]&lt;/code>&lt;/p>
&lt;p>&lt;em>æ‚¨ä¼šå‘ç°ï¼Œè¿™ä¸ª &lt;code>b&lt;/code> å‘é‡å’Œ &lt;code>a&lt;/code> çŸ©é˜µçš„æœ€åä¸€è¡Œæ˜¯ä¸€æ ·çš„ï¼Œè¿™è¢«ç§°ä¸º FSAL (First Same As Last) ç‰¹æ€§ã€‚è¿™æ„å‘³ç€è®¡ç®— &lt;code>k_7&lt;/code> çš„å€¼ &lt;code>f(t_{n+1}, y_{n+1}^{(5)})&lt;/code> æ­£å¥½å¯ä»¥ä½œä¸ºä¸‹ä¸€ä¸ªç§¯åˆ†æ­¥çš„ &lt;code>k_1&lt;/code>ï¼Œä»è€Œæ¯æ­¥èŠ‚çœä¸€æ¬¡å‡½æ•°æ±‚å€¼ã€‚&lt;/em>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>b*&lt;/code> (å››é˜¶ç²¾åº¦):&lt;/strong>
&lt;code>[ 5179/57600, 0, 7571/16695, 393/640, -92097/339200, 187/2100, 1/40 ]&lt;/code>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>&lt;code>e&lt;/code> (è¯¯å·®ç³»æ•° &lt;code>b - b*&lt;/code>):&lt;/strong>
&lt;code>[ 71/57600, 0, -71/16695, 71/1920, -17253/339200, 22/525, -1/40 ]&lt;/code>&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>åœ¨å®é™…ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ç›´æ¥ä½¿ç”¨ &lt;code>e&lt;/code> å‘é‡æ¥è®¡ç®—è¯¯å·®ï¼Œè¿™æ ·æ›´ç›´æ¥é«˜æ•ˆã€‚&lt;/p>
&lt;p>è¿™ä¸¤ä¸ªè§£ä¹‹é—´çš„å·®å¼‚ï¼Œå°±ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå¯¹å±€éƒ¨æˆªæ–­è¯¯å·® &lt;code>E_{n+1}&lt;/code> çš„å¯é ä¼°è®¡ï¼š
&lt;/p>
$$
E_{n+1} \approx \left\| y_{n+1}^{(5)} - y_{n+1}^{(4)} \right\| = h \left\| \sum_{i=1}^{6} (b_i - b_i^*) k_i \right\|
$$
&lt;h3 id="32-è¯¯å·®æ§åˆ¶æ¨¡ä»¿-matlab-ode45-çš„ç­–ç•¥">3.2 è¯¯å·®æ§åˆ¶ï¼šæ¨¡ä»¿ MATLAB &lt;code>ode45&lt;/code> çš„ç­–ç•¥
&lt;/h3>&lt;p>ä»…ä»…å¾—åˆ°è¯¯å·®ä¼°è®¡æ˜¯ä¸å¤Ÿçš„ï¼Œå…³é”®åœ¨äºå¦‚ä½•åˆ©ç”¨å®ƒæ¥åˆ¤æ–­å½“å‰æ­¥é•¿ &lt;code>h&lt;/code> æ˜¯å¦â€œå¥½â€ã€‚ä¸€ä¸ªä¼˜ç§€çš„è¯¯å·®æ§åˆ¶ç­–ç•¥ä¸åº”è¯¥åªçœ‹ç»å¯¹è¯¯å·®ï¼Œè€Œåº”è¯¥åƒ MATLAB çš„ &lt;code>ode45&lt;/code> å‡½æ•°ä¸€æ ·ï¼ŒåŒæ—¶è€ƒè™‘&lt;strong>ç›¸å¯¹è¯¯å·® (Relative Tolerance, &lt;code>RelTol&lt;/code>)&lt;/strong> å’Œ&lt;strong>ç»å¯¹è¯¯å·® (Absolute Tolerance, &lt;code>AbsTol&lt;/code>)&lt;/strong>ã€‚&lt;/p>
&lt;p>å¯¹äºçŠ¶æ€å‘é‡ &lt;code>y&lt;/code> çš„æ¯ä¸€ä¸ªåˆ†é‡ &lt;code>y_i&lt;/code>ï¼Œæˆ‘ä»¬è®¡ç®—ä¸€ä¸ªå®¹å¿åº¦é˜ˆå€¼ &lt;code>Tol_i&lt;/code>ï¼š
&lt;/p>
$$
\text{Tol}_i = \text{RelTol} \times |y_i| + \text{AbsTol}
$$
&lt;p>&lt;strong>è¿™ä¸ªç­–ç•¥çš„ä¼˜ç‚¹åœ¨äº&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>å½“è§£ &lt;code>|y_i|&lt;/code> çš„æ•°å€¼å¾ˆå¤§æ—¶ï¼Œä¸»è¦ç”±ç›¸å¯¹è¯¯å·® &lt;code>RelTol&lt;/code> æ§åˆ¶ï¼Œä¿è¯äº†è¯¯å·®ä¸è§£çš„é‡çº§æˆæ¯”ä¾‹ã€‚&lt;/li>
&lt;li>å½“è§£ &lt;code>|y_i|&lt;/code> çš„æ•°å€¼å¾ˆå°ï¼ˆè¶‹è¿‘äºé›¶ï¼‰æ—¶ï¼Œ&lt;code>RelTol \times |y_i|&lt;/code> é¡¹ä¼šå˜å¾—è¿‡å°ï¼Œæ­¤æ—¶ç”±ç»å¯¹è¯¯å·® &lt;code>AbsTol&lt;/code> æ‰˜åº•ï¼Œé˜²æ­¢äº†å¯¹æ­¥é•¿çš„è¿‡åº¦ä¸¥è‹›è¦æ±‚ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è®¡ç®—å‡ºçš„è¯¯å·® &lt;code>E_{n+1}&lt;/code> ä¸è¿™ä¸ªå®¹å¿åº¦ &lt;code>Tol&lt;/code> è¿›è¡Œæ¯”è¾ƒã€‚ä¸ºäº†å¯¹æ•´ä¸ªå‘é‡çš„è¯¯å·®è¿›è¡Œç»¼åˆè¯„ä¼°ï¼Œæˆ‘ä»¬è®¡ç®—ä¸€ä¸ªæ ‡é‡è¯¯å·®ç‡ &lt;code>err_rate&lt;/code>ï¼š&lt;/p>
$$
\text{err\_rate} = \sqrt{ \frac{1}{N} \sum_{i=1}^{N} \left( \frac{E_{n+1, i}}{\text{Tol}_i} \right)^2 }
$$
&lt;p>
å…¶ä¸­ &lt;code>N&lt;/code> æ˜¯çŠ¶æ€å‘é‡ &lt;code>y&lt;/code> çš„ç»´åº¦ã€‚&lt;/p>
&lt;h3 id="33-æ­¥é•¿è°ƒæ•´å†³ç­–">3.3 æ­¥é•¿è°ƒæ•´å†³ç­–
&lt;/h3>&lt;p>æ ¹æ®è®¡ç®—å‡ºçš„ &lt;code>err_rate&lt;/code>ï¼Œæˆ‘ä»¬åšå‡ºå†³ç­–ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>å¦‚æœ &lt;code>err_rate &amp;lt;= 1.0&lt;/code>&lt;/strong>: &lt;strong>æ¥å—å½“å‰æ­¥&lt;/strong>ã€‚&lt;/p>
&lt;ul>
&lt;li>å½“å‰æ­¥é•¿ &lt;code>h&lt;/code> æ˜¯æœ‰æ•ˆçš„ï¼Œç”šè‡³å¯èƒ½æœ‰ç‚¹è¿‡äºä¿å®ˆã€‚&lt;/li>
&lt;li>æˆ‘ä»¬å°†æ›´é«˜é˜¶çš„è§£ &lt;code>y_{n+1}^{(5)}&lt;/code> ä½œä¸ºæœ¬æ¬¡ç§¯åˆ†çš„æœ€ç»ˆç»“æœã€‚&lt;/li>
&lt;li>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•åœ¨&lt;strong>ä¸‹ä¸€ä¸ª&lt;/strong>æ—¶é—´æ­¥ä½¿ç”¨ä¸€ä¸ªæ›´å¤§çš„æ­¥é•¿ &lt;code>h_new&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å¦‚æœ &lt;code>err_rate &amp;gt; 1.0&lt;/code>&lt;/strong>: &lt;strong>æ‹’ç»å½“å‰æ­¥&lt;/strong>ã€‚&lt;/p>
&lt;ul>
&lt;li>å½“å‰æ­¥é•¿ &lt;code>h&lt;/code> å¤ªå¤§ï¼Œå¯¼è‡´è¯¯å·®è¶…å‡ºäº†å®¹å¿èŒƒå›´ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬&lt;strong>ä¸¢å¼ƒ&lt;/strong>æœ¬æ¬¡è®¡ç®—çš„æ‰€æœ‰ç»“æœï¼ˆ&lt;code>y_{n+1}^{(4)}&lt;/code> å’Œ &lt;code>y_{n+1}^{(5)}&lt;/code>ï¼‰ï¼Œç³»ç»ŸçŠ¶æ€å›é€€åˆ° &lt;code>y_n&lt;/code>ã€‚&lt;/li>
&lt;li>æˆ‘ä»¬éœ€è¦ç”¨ä¸€ä¸ªæ›´å°çš„æ­¥é•¿ &lt;code>h_new&lt;/code> &lt;strong>é‡æ–°è®¡ç®—å½“å‰æ­¥&lt;/strong>ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;p>æ­¥é•¿è°ƒæ•´çš„ç»å…¸å…¬å¼ä¸ºï¼š
&lt;/p>
$$
h_{\text{new}} = h_{\text{old}} \times \text{safe} \times \left( \frac{1.0}{\text{err\_rate}} \right)^{0.2}
$$
&lt;ul>
&lt;li>&lt;code>safe&lt;/code>: ä¸€ä¸ªå®‰å…¨å› å­ï¼Œé€šå¸¸å– 0.8 åˆ° 0.9ï¼Œé˜²æ­¢æ­¥é•¿è°ƒæ•´è¿‡äºæ¿€è¿›ã€‚&lt;/li>
&lt;li>æŒ‡æ•° &lt;code>0.2&lt;/code>: å¯¹äºä¸€ä¸ªäº”é˜¶æ–¹æ³•æ¥è¯´ï¼Œè¿™ä¸ªå€¼æ˜¯ &lt;code>1/(k+1)&lt;/code>ï¼Œå…¶ä¸­ &lt;code>k=4&lt;/code> æ˜¯ä½é˜¶æ–¹æ³•çš„é˜¶æ•°ã€‚åœ¨å®è·µä¸­ï¼Œå¸¸ç”¨çš„æ˜¯ &lt;code>1/k_high&lt;/code>ï¼Œå³ &lt;code>1/5=0.2&lt;/code>ã€‚&lt;/li>
&lt;/ul>
&lt;p>åŒæ—¶ï¼Œä¸ºäº†é˜²æ­¢æ­¥é•¿å˜åŒ–è¿‡å¿«ï¼Œé€šå¸¸ä¼šé™åˆ¶æ­¥é•¿çš„æœ€å¤§/æœ€å°å¢é•¿/ç¼©å‡ç‡ï¼ˆä¾‹å¦‚ï¼Œ&lt;code>h_new&lt;/code> ä¸å¾—è¶…è¿‡ &lt;code>h_old&lt;/code> çš„5å€ï¼Œæˆ–å°äº &lt;code>h_old&lt;/code> çš„0.2å€ï¼‰ã€‚&lt;/p>
&lt;h2 id="4-ç»“åˆsphçš„è®¡ç®—ä¼ªä»£ç ">4. ç»“åˆSPHçš„è®¡ç®—ä¼ªä»£ç 
&lt;/h2>&lt;p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¸Šè¿° RK45 è¯¯å·®æ§åˆ¶é€»è¾‘æ•´åˆåˆ° SPH çš„ä¸»å¾ªç¯ä¸­ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-cpp" data-lang="cpp">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// --- å…¨å±€å‚æ•° ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">RelTol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-6&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ç›¸å¯¹å®¹å¿åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">AbsTol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-9&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// ç»å¯¹å®¹å¿åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">h_min&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-8&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_max&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">1e-2&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// æ­¥é•¿ä¸Šä¸‹é™
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">safe_factor&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.9&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">double&lt;/span> &lt;span class="n">max_increase&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">5.0&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">min_decrease&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.2&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">// --- ä¸»å¾ªç¯ ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>&lt;span class="kt">double&lt;/span> &lt;span class="n">t&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kt">double&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">initial_dt&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// åˆå§‹æ­¥é•¿
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">T_max&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="kt">bool&lt;/span> &lt;span class="n">step_accepted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">false&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">while&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">!&lt;/span>&lt;span class="n">step_accepted&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">h_min&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// æ­¥é•¿è¿‡å°ï¼Œå¯èƒ½å‡ºç°é—®é¢˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">error&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s">&amp;#34;Timestep smaller than h_min&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">break&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 1. SPHåŠ›è®¡ç®—ï¼šæ ¹æ®å½“å‰çŠ¶æ€ y_n è®¡ç®— k1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// y_n åŒ…æ‹¬æ‰€æœ‰ç²’å­çš„ä½ç½® x å’Œé€Ÿåº¦ v
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="n">k1&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">compute_derivatives&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y_n&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 2. RK45 æ ¸å¿ƒè®¡ç®—ï¼šè®¡ç®— k2, k3, ..., k6
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// å¹¶å¾—åˆ° y_next_4 (å››é˜¶è§£) å’Œ y_next_5 (äº”é˜¶è§£)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// (æ­¤å¤„çœç•¥ç¹æ‚çš„ç³»æ•°è®¡ç®—)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">auto&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">y_next_4&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y_next_5&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">perform_rk45_core&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">y_n&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">k1&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 3. è®¡ç®—è¯¯å·®ç‡ err_rate (æ¨¡ä»¿ MATLAB)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">err_rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mf">0.0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="kt">int&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">N_particles&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// å¯¹ä½ç½®å’Œé€Ÿåº¦åˆ†åˆ«è®¡ç®—å®¹å¿åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">vec3&lt;/span> &lt;span class="n">pos_error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y_next_5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">y_next_4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vec3&lt;/span> &lt;span class="n">vel_error&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y_next_5&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">vel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">y_next_4&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">vel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vec3&lt;/span> &lt;span class="n">pos_tol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RelTol&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y_n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">pos&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">AbsTol&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">vec3&lt;/span> &lt;span class="n">vel_tol&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RelTol&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">abs&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">y_n&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="n">vel&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">AbsTol&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// ç´¯åŠ è¯¯å·®çš„å¹³æ–¹/å®¹å¿åº¦çš„å¹³æ–¹
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">err_rate&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">pos_error&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">pos_tol&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">^&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">err_rate&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">sum&lt;/span>&lt;span class="p">(&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">vel_error&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">vel_tol&lt;/span>&lt;span class="p">)&lt;/span>&lt;span class="o">^&lt;/span>&lt;span class="mi">2&lt;/span> &lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">err_rate&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">sqrt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">err_rate&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="mi">6&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">N_particles&lt;/span>&lt;span class="p">));&lt;/span> &lt;span class="c1">// å½’ä¸€åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// 4. å†³ç­–ä¸æ­¥é•¿è°ƒæ•´
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">err_rate&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mf">1.0&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// --- æ¥å—æ­¥é•¿ ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">step_accepted&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">true&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">t&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">y_n&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y_next_5&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="c1">// æ›´æ–°çŠ¶æ€ä¸ºæ›´é«˜é˜¶çš„è§£
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¡ç®—ä¸‹ä¸€ä¸ªå»ºè®®æ­¥é•¿ (é€šå¸¸æ˜¯å¢å¤§çš„)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">h_new&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">safe_factor&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">pow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">err_rate&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">max_increase&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_new&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// é™åˆ¶æœ€å¤§å¢å¹…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">min&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_max&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// ä¸è¶…è¿‡æœ€å¤§æ­¥é•¿é™åˆ¶
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// --- æ‹’ç»æ­¥é•¿ ---
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="c1">// çŠ¶æ€ y_n å’Œ t ä¿æŒä¸å˜
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// è®¡ç®—ä¸‹ä¸€ä¸ªå»ºè®®æ­¥é•¿ (å¿…é¡»æ˜¯å‡å°çš„)
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="kt">double&lt;/span> &lt;span class="n">h_new&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">safe_factor&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">pow&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">err_rate&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mf">0.2&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">h&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">max&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">min_decrease&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">h_new&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="c1">// é™åˆ¶æœ€å¤§é™å¹…
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1">// (å¯é€‰) åœ¨æ¯ä¸ªæˆåŠŸçš„æ—¶é—´æ­¥åï¼Œæ›´æ–°é‚»åŸŸã€è¾“å‡ºæ•°æ®ç­‰
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">&lt;/span> &lt;span class="n">UpdateAndSaveData&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">t&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>// &lt;code>compute_derivatives&lt;/code> å‡½æ•°éœ€è¦è®¡ç®—SPHçš„å¯†åº¦ã€å‹åŠ›ã€åŠ é€Ÿåº¦ç­‰
// å¹¶è¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰ç²’å­ d(pos)/dt (=v) å’Œ d(v)/dt (=a) çš„å¯¼æ•°å‘é‡&lt;/p>
&lt;h1 id="sphæ§åˆ¶æ–¹ç¨‹çš„å³ç«¯é¡¹è®¡ç®—-right-hand-side-rhs">SPHæ§åˆ¶æ–¹ç¨‹çš„å³ç«¯é¡¹è®¡ç®— (Right-Hand Side, RHS)
&lt;/h1>&lt;p>åœ¨SPHï¼ˆå…‰æ»‘ç²’å­æµä½“åŠ¨åŠ›å­¦ï¼‰æ•°å€¼æ¨¡æ‹Ÿä¸­ï¼Œç³»ç»Ÿçš„æ¼”åŒ–ç”±ä¸€ç»„å¸¸å¾®åˆ†æ–¹ç¨‹ï¼ˆODEsï¼‰æè¿°ã€‚ä½¿ç”¨æ˜¾å¼æ—¶é—´ç§¯åˆ†æ–¹æ¡ˆï¼ˆå¦‚Leapfrogæˆ–Runge-Kuttaï¼‰æ±‚è§£è¿™äº›ODEsçš„å…³é”®ï¼Œæ˜¯ç²¾ç¡®è®¡ç®—æ¯ä¸ªæ—¶é—´æ­¥çš„&lt;strong>å³ç«¯é¡¹ï¼ˆRHSï¼‰&lt;/strong>ï¼Œå³å„ä¸ªç‰©ç†é‡çš„æ—¶é—´å¯¼æ•°ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯SPHä¸­éœ€è¦æ±‚è§£çš„æ ¸å¿ƒæ§åˆ¶æ–¹ç¨‹åŠå…¶å³ç«¯é¡¹ï¼Œç‰¹åˆ«è€ƒè™‘äº†åŒ…å«å¼¹å¡‘æ€§å›ºä½“åŠ›å­¦æ¨¡å‹çš„åœºæ™¯ã€‚&lt;/p>
&lt;hr>
&lt;h3 id="1-åŠ¨é‡æ–¹ç¨‹-momentum-equation">1. åŠ¨é‡æ–¹ç¨‹ (Momentum Equation)
&lt;/h3>&lt;p>&lt;strong>æ–¹ç¨‹&lt;/strong>:
&lt;/p>
$$
\frac{d\mathbf{v}_i}{dt} = \mathbf{a}_i
$$
&lt;p>&lt;strong>å³ç«¯é¡¹ (&lt;code>RHS_v&lt;/code>)&lt;/strong>: ç²’å­ $i$ çš„åŠ é€Ÿåº¦ $\mathbf{a}_i$ã€‚å®ƒç”±å¤šç§åŠ›çš„è´¡çŒ®ç»„æˆï¼š
&lt;/p>
$$
\mathbf{a}_i = \mathbf{f}_i^{\text{pressure}} + \mathbf{f}_i^{\text{viscosity}} + \mathbf{f}_i^{\text{deviatoric}} + \mathbf{f}_i^{\text{gravity}} + \dots
$$
&lt;ul>
&lt;li>&lt;strong>å‹åŠ›æ¢¯åº¦åŠ› (&lt;code>f_pressure&lt;/code>)&lt;/strong>:
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">f_pressure = - \sum_j m_j \left( \frac{P_i}{\rho_i^2} + \frac{P_j}{\rho_j^2} \right) \nabla_i W_{ij}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;strong>äººå·¥ç²˜æ€§åŠ› (&lt;code>f_viscosity&lt;/code>)&lt;/strong>: ç”¨äºå¤„ç†å†²å‡»æ³¢ã€‚
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">f_viscosity = - \sum_j m_j \Pi_{ij} \nabla_i W_{ij}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;/li>
&lt;li>&lt;strong>ååº”åŠ›æ¢¯åº¦åŠ› (&lt;code>f_deviatoric&lt;/code>)&lt;/strong>: &lt;strong>æ­¤é¡¹åœ¨å›ºä½“åŠ›å­¦æ¨¡å‹ä¸­è‡³å…³é‡è¦&lt;/strong>ï¼Œä»£è¡¨ç”±å‰ªåˆ‡ç­‰å½¢å˜å¼•èµ·çš„åŠ›ã€‚
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">f_deviatoric = \sum_j m_j \left( \frac{\mathbf{S}_i}{\rho_i^2} + \frac{\mathbf{S}_j}{\rho_j^2} \right) \cdot \nabla_i W_{ij}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>å…¶ä¸­ $\mathbf{S}$ æ˜¯ååº”åŠ›å¼ é‡ã€‚&lt;/li>
&lt;li>&lt;strong>ä½“åŠ› (&lt;code>f_gravity&lt;/code>, etc.)&lt;/strong>: å¦‚è‡ªå¼•åŠ›ã€å¤–åŠ å¼•åŠ›åœºç­‰ã€‚&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="2-è¿ç»­æ€§æ–¹ç¨‹-continuity-equation">2. è¿ç»­æ€§æ–¹ç¨‹ (Continuity Equation)
&lt;/h3>&lt;p>&lt;strong>æ–¹ç¨‹&lt;/strong>:
&lt;/p>
$$
\frac{d\rho_i}{dt} = f(\rho)_i
$$
&lt;p>&lt;strong>å³ç«¯é¡¹ (&lt;code>RHS_rho&lt;/code>)&lt;/strong>: ç²’å­ $i$ çš„å¯†åº¦å˜åŒ–ç‡ã€‚
&lt;/p>
$$
\frac{d\rho_i}{dt} = \rho_i \sum_j \frac{m_j}{\rho_j} (\mathbf{v}_i - \mathbf{v}_j) \cdot \nabla_i W_{ij}
$$
&lt;p>
è¿™ä¹Ÿè¢«ç§°ä¸ºSPHçš„â€œæ±‚å’Œå½¢å¼â€å¯†åº¦ã€‚åœ¨è®¸å¤šç°ä»£å®ç°ä¸­ï¼Œå¯†åº¦é€šå¸¸ä¸é€šè¿‡ç§¯åˆ†æ­¤æ–¹ç¨‹å¾—åˆ°ï¼Œè€Œæ˜¯åœ¨æ¯ä¸ªæ—¶é—´æ­¥é€šè¿‡ç›´æ¥æ±‚å’Œæ¥è®¡ç®—ï¼Œä»¥ä¿è¯è´¨é‡å®ˆæ’å’Œç¨³å®šæ€§ã€‚
&lt;/p>
$$
\rho_i = \sum_j m_j W_{ij}
$$
&lt;hr>
&lt;h3 id="3-èƒ½é‡æ–¹ç¨‹-energy-equation">3. èƒ½é‡æ–¹ç¨‹ (Energy Equation)
&lt;/h3>&lt;p>&lt;strong>æ–¹ç¨‹&lt;/strong>:
&lt;/p>
$$
\frac{du_i}{dt} = f(u)_i
$$
&lt;p>&lt;strong>å³ç«¯é¡¹ (&lt;code>RHS_u&lt;/code>)&lt;/strong>: ç²’å­ $i$ çš„æ¯”å†…èƒ½å˜åŒ–ç‡ã€‚
&lt;/p>
$$
\frac{du_i}{dt} = \frac{1}{2} \sum_j m_j (\mathbf{v}_i - \mathbf{v}_j) \cdot \left( \left( \frac{P_i}{\rho_i^2} + \frac{P_j}{\rho_j^2} \right) \nabla_i W_{ij} - \Pi_{ij} \nabla_i W_{ij} \right) + \frac{\mathbf{S}_i}{\rho_i^2} : \nabla_i \mathbf{v}_i
$$
&lt;ul>
&lt;li>&lt;strong>ç¬¬ä¸€éƒ¨åˆ†&lt;/strong>: å‹åŠ›å’Œäººå·¥ç²˜æ€§æ‰€åšçš„åŠŸã€‚&lt;/li>
&lt;li>&lt;strong>ç¬¬äºŒéƒ¨åˆ†&lt;/strong>: &lt;strong>ååº”åŠ›æ‰€åšçš„åŠŸ&lt;/strong>ï¼Œæ˜¯å¼¹å¡‘æ€§å˜å½¢ä¸­èƒ½é‡è€—æ•£å’Œæ¸©å‡çš„é‡è¦æ¥æºã€‚&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="4-å›ºä½“åŠ›å­¦æœ¬æ„æ–¹ç¨‹-constitutive-equations-for-solids">4. å›ºä½“åŠ›å­¦æœ¬æ„æ–¹ç¨‹ (Constitutive Equations for Solids)
&lt;/h3>&lt;p>å¯¹äºå¼¹å¡‘æ€§å›ºä½“ï¼Œé™¤äº†ä¸Šè¿°æµä½“åŠ›å­¦å˜é‡ï¼Œè¿˜å¿…é¡»è¿½è¸ªåº”åŠ›å¼ é‡çš„æ¼”åŒ–ã€‚è¿™å¼•å…¥äº†æ–°çš„ODEã€‚&lt;/p>
&lt;p>&lt;strong>æ–¹ç¨‹&lt;/strong>:
&lt;/p>
$$
\frac{d\mathbf{S}_i}{dt} = f(\mathbf{S})_i
$$
&lt;p>&lt;strong>å³ç«¯é¡¹ (&lt;code>RHS_S&lt;/code>)&lt;/strong>: ç²’å­ $i$ çš„&lt;strong>ååº”åŠ›å¼ é‡æ—¶é—´å¯¼æ•° (Rate of Deviatoric Stress Tensor)&lt;/strong>ã€‚
ä¸ºäº†ä¿è¯åæ ‡ç³»æ—‹è½¬ä¸‹çš„å®¢è§‚æ€§ï¼Œå¿…é¡»ä½¿ç”¨å®¢è§‚åº”åŠ›ç‡ï¼Œå¦‚Jaumannç‡ï¼š
&lt;/p>
$$
\frac{d\mathbf{S}_i}{dt} = 2G \left( \dot{\boldsymbol{\epsilon}}_i - \frac{1}{3}\text{tr}(\dot{\boldsymbol{\epsilon}}_i)\mathbf{I} \right) + \mathbf{S}_i \cdot \boldsymbol{\Omega}_i - \boldsymbol{\Omega}_i \cdot \mathbf{S}_i
$$
&lt;ul>
&lt;li>$\dot{\boldsymbol{\epsilon}}_i$: åº”å˜ç‡å¼ é‡ï¼Œç”±é€Ÿåº¦æ¢¯åº¦è®¡ç®—å¾—åˆ°ã€‚&lt;/li>
&lt;li>$\boldsymbol{\Omega}_i$: è‡ªæ—‹å¼ é‡ï¼ˆé€Ÿåº¦åœºçš„åå¯¹ç§°éƒ¨åˆ†ï¼‰ï¼Œç”¨äºå¤„ç†æ—‹è½¬ã€‚&lt;/li>
&lt;li>&lt;strong>æ³¨æ„&lt;/strong>: åœ¨å®é™…çš„å¼¹å¡‘æ€§è¿”å›æ˜ å°„ç®—æ³•ä¸­ï¼Œè¿™ä¸€æ­¥é€šå¸¸ä¸å¡‘æ€§æ ¡æ­£éšå¼åœ°ç»“åˆåœ¨ä¸€èµ·ï¼Œè€Œä¸æ˜¯ç›´æ¥ç§¯åˆ†ä¸€ä¸ªæ˜¾å¼çš„å¯¼æ•°ã€‚&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="5-æŸä¼¤æ¼”åŒ–æ–¹ç¨‹-damage-evolution-equation">5. æŸä¼¤æ¼”åŒ–æ–¹ç¨‹ (Damage Evolution Equation)
&lt;/h3>&lt;p>&lt;strong>æ–¹ç¨‹&lt;/strong>:
&lt;/p>
$$
\frac{dD_i}{dt} = f(D)_i
$$
&lt;p>&lt;strong>å³ç«¯é¡¹ (&lt;code>RHS_D&lt;/code>)&lt;/strong>: ç²’å­ $i$ çš„&lt;strong>æŸä¼¤å˜é‡æ—¶é—´å¯¼æ•° (Rate of Damage Variable)&lt;/strong>ã€‚
è¯¥æ–¹ç¨‹çš„å½¢å¼å®Œå…¨å–å†³äºæ‰€é€‰çš„æŸä¼¤æ¨¡å‹ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªåŸºäºå¡‘æ€§åº”å˜ç´¯ç§¯çš„ç®€å•æ¨¡å‹ï¼š
&lt;/p>
$$
\frac{dD_i}{dt} = \frac{1}{\epsilon_f} \frac{d\epsilon_p}{dt}
$$
&lt;ul>
&lt;li>$\epsilon_p$: ç­‰æ•ˆå¡‘æ€§åº”å˜ã€‚&lt;/li>
&lt;li>$\epsilon_f$: ææ–™çš„æ–­è£‚åº”å˜ã€‚&lt;/li>
&lt;li>åœ¨Grady-Kippæ¨¡å‹ä¸­ï¼Œè¿™ä¸ªå¯¼æ•°çš„å½¢å¼ä¼šæ›´å¤æ‚ï¼ˆå¦‚ &lt;code>d(D^(1/3))/dt = ...&lt;/code>ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;hr>
&lt;h3 id="è®¡ç®—æµç¨‹æ¦‚è¿°">è®¡ç®—æµç¨‹æ¦‚è¿°
&lt;/h3>&lt;p>åœ¨ä¸€ä¸ªå…¸å‹çš„RHSå‡½æ•°ä¸­ï¼Œè®¡ç®—é¡ºåºè‡³å…³é‡è¦ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å‹åŠ›è®¡ç®—&lt;/strong>: æ ¹æ®å¯†åº¦ &lt;code>Ï&lt;/code> å’Œå†…èƒ½ &lt;code>u&lt;/code>ï¼Œé€šè¿‡çŠ¶æ€æ–¹ç¨‹ï¼ˆEoSï¼‰è®¡ç®—å‹åŠ› &lt;code>P&lt;/code>ã€‚&lt;/li>
&lt;li>&lt;strong>å±ˆæœæ¨¡å‹&lt;/strong>ï¼šåŒºåˆ«äºå¸¸å±ˆæœå¼ºåº¦ï¼Œè„†æ€§ææ–™å¦‚å²©çŸ³ï¼Œå…¶å±ˆæœå¼ºåº¦æ˜¯å‹åŠ›&lt;code>P&lt;/code>çš„å‡½æ•°ã€‚&lt;/li>
&lt;li>&lt;strong>æ€»åº”åŠ›&lt;/strong>ï¼šåº”åŠ›é€šè¿‡é™æ°´å‹åŠ›ï¼ˆ&lt;code>P&lt;/code>ï¼‰å’Œåˆ‡åº”åŠ›å¾—åˆ°ã€‚æ³¨æ„éœ€è¦åˆ¤æ–­å¼¹æ€§è¿˜æ˜¯å±ˆæœï¼Œè‹¥å±ˆæœéœ€ä½¿ç”¨å¾„å‘è¿”å›ç®—æ³•å¾—åˆ°ä¿®æ­£åˆ‡åº”åŠ›ã€‚&lt;/li>
&lt;li>&lt;strong>ç²’å­å¾ªç¯&lt;/strong>ï¼šå¾ªç¯ï¼Œç´¯è®¡æ±‚å’Œï¼Œè®¡ç®—å†…èƒ½ï¼Œå¯†åº¦ï¼Œé€Ÿåº¦ï¼Œåˆ‡åº”åŠ›ç­‰å¯¼æ•°&lt;/li>
&lt;/ol>
&lt;p>ä¸Šè¿°è¿‡ç¨‹ä¸­ï¼Œæ­¥éª¤1ï¼Œ2ï¼Œ3ä¸ºå•ç²’å­è®¡ç®—ï¼Œ4ä¸ºé‚»å±…ç²’å­å¾ªç¯ç´¯åŠ ã€‚&lt;/p></description></item></channel></rss>
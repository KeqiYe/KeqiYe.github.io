<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>ç¢°æ’æ£€æµ‹ on Keqiçš„åšå®¢</title><link>https://keqiye.github.io/zh-cn/categories/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/</link><description>Recent content in ç¢°æ’æ£€æµ‹ on Keqiçš„åšå®¢</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><managingEditor>plloningye@gmail.com (Keqi Ye)</managingEditor><webMaster>plloningye@gmail.com (Keqi Ye)</webMaster><copyright>Example Person</copyright><lastBuildDate>Fri, 09 May 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://keqiye.github.io/zh-cn/categories/%E7%A2%B0%E6%92%9E%E6%A3%80%E6%B5%8B/index.xml" rel="self" type="application/rss+xml"/><item><title>SPH ç²’å­é¢†åŸŸæœç´¢</title><link>https://keqiye.github.io/zh-cn/posts/blog-post-2/</link><pubDate>Fri, 09 May 2025 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/blog-post-2/</guid><description>&lt;h1 id="sph-ç²’å­é¢†åŸŸæœç´¢">SPH ç²’å­é¢†åŸŸæœç´¢
&lt;/h1>&lt;h2 id="é—®é¢˜æè¿°">é—®é¢˜æè¿°
&lt;/h2>&lt;p>åœ¨å…‰æ»‘ç²’å­æµä½“åŠ¨åŠ›å­¦ï¼ˆSmoothed Particle Hydrodynamicsï¼Œç®€ç§° SPHï¼‰æ–¹æ³•ä¸­ï¼Œâ€œé‚»å±…æœç´¢â€ï¼ˆNeighbor Searchï¼‰æ˜¯ä¸€ä¸ªè‡³å…³é‡è¦çš„è®¡ç®—ä»»åŠ¡ã€‚å®ƒç›´æ¥å½±å“åˆ°æ¨¡æ‹Ÿçš„æ•ˆç‡ä¸ç²¾åº¦ï¼Œå°¤å…¶åœ¨æ¶‰åŠä¸Šç™¾ä¸‡ç²’å­çš„ä¸‰ç»´é—®é¢˜ä¸­ï¼Œè®¡ç®—ç“¶é¢ˆå¾€å¾€å‡ºç°åœ¨å¦‚ä½•é«˜æ•ˆæŸ¥æ‰¾æ¯ä¸ªç²’å­å‘¨å›´çš„é‚»å±…ä¸Šã€‚&lt;/p>
&lt;p>ç”±äº SPH æ˜¯ä¸€ç§æ— ç½‘æ ¼æ–¹æ³•ï¼Œå¤©ç„¶é€‚åˆå¤„ç†è‡ªç”±è¡¨é¢ã€å¤§å˜å½¢å’Œæ–­è£‚ç­‰å¤æ‚ç‰©ç†ç°è±¡ï¼Œå› æ­¤è¢«å¹¿æ³›åº”ç”¨äºå¤©ä½“ç‰©ç†ã€æµä½“åŠ›å­¦ã€å›ºä½“åŠ›å­¦ç­‰é¢†åŸŸã€‚æˆ‘ä¸»è¦ä»äº‹å°è¡Œæ˜Ÿæ’å‡»é—®é¢˜çš„æ•°å€¼æ¨¡æ‹Ÿç ”ç©¶ï¼Œå¹¶å¼€å‘äº†ä¸€å¥—é’ˆå¯¹è¯¥é—®é¢˜çš„ SPH ä»£ç ã€‚è™½ç„¶ä¸åŒé¢†åŸŸåœ¨å®ç°ç»†èŠ‚ä¸Šå­˜åœ¨å·®å¼‚ï¼Œä½†â€œé‚»å±…æœç´¢â€ä½œä¸ºæ ¸å¿ƒæ¨¡å—ï¼Œå…¶æ•°å­¦æ¨¡å‹ç›¸å¯¹ç®€å•ï¼Œå´å‡ ä¹åœ¨æ‰€æœ‰ SPH å®ç°ä¸­éƒ½ä¸å¯æˆ–ç¼ºã€‚&lt;/p>
&lt;p>æœ¬æ–‡æ—¨åœ¨ç³»ç»Ÿä»‹ç» SPH ä¸­é‚»å±…æœç´¢çš„å¸¸è§ç®—æ³•ã€æ€§èƒ½ä¼˜åŒ–æ–¹æ³•ï¼Œä»¥åŠåœ¨ CUDA ç­‰å¹¶è¡Œè®¡ç®—å¹³å°ä¸Šçš„å®ç°ï¼Œä½œä¸ºæˆ‘ä¸ªäººå­¦ä¹ ä¸ç ”ç©¶çš„è®°å½•ï¼ŒåŒæ—¶å¸Œæœ›å¯¹åŒé¢†åŸŸçš„ç ”ç©¶è€…æä¾›å‚è€ƒã€‚&lt;/p>
&lt;p>é¦–å…ˆç»™å‡º SPH ç²’å­é‚»å±…æœç´¢çš„æŠ½è±¡æ•°å­¦é—®é¢˜ï¼šè®¾åœ¨ä¸‰ç»´ç©ºé—´ä¸­å­˜åœ¨ \( N \) ä¸ªç²’å­ï¼Œæ¯ä¸ªç²’å­çš„ä½ç½®å·²çŸ¥ï¼Œè®°ä¸º \( \mathbf{x}_i \)ï¼Œæ¯ä¸ªç²’å­æœ‰ä¸€ä¸ªæ ¸é•¿åº¦ï¼ˆsmoothing lengthï¼‰\( h_i \)ã€‚æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ¯ä¸ªç²’å­ \( i \) çš„é‚»å±…ç²’å­é›†åˆ \( j \)ï¼Œä½¿å¾—æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š&lt;/p>
\[
\|\mathbf{x}_i - \mathbf{x}_j\| &lt; f(h_i, h_j)
\]
&lt;p>å…¶ä¸­ï¼Œå‡½æ•° \( f(h_i, h_j) \) ç”¨äºå®šä¹‰ç²’å­é—´çš„äº¤äº’è·ç¦»ï¼Œå…¶å¸¸è§å®šä¹‰åŒ…æ‹¬ï¼š&lt;/p>
&lt;ul>
&lt;li>\( f(h_i, h_j) = \eta \cdot \frac{1}{2}(h_i + h_j) \)&lt;/li>
&lt;li>\( f(h_i, h_j) = \eta \cdot \min(h_i, h_j) \)&lt;/li>
&lt;li>\( f(h_i, h_j) = \eta \cdot \max(h_i, h_j) \)&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œï¼Œ\( \eta \) æ˜¯ä¸€ä¸ªæ— é‡çº²ç³»æ•°ï¼Œç§°ä¸º&lt;strong>æ ¸æ”¯æŒåŠå¾„å› å­ï¼ˆkernel support radius factorï¼‰&lt;/strong>ï¼Œé€šå¸¸å–å€¼åœ¨ \( [1.2, 2.5] \) ä¹‹é—´ï¼Œç”¨äºæ§åˆ¶ç²’å­çš„å½±å“èŒƒå›´ï¼ˆæœ¬æ–‡å–2ï¼‰ã€‚&lt;/p>
&lt;p>åœ¨é‚»å±…æœç´¢ä¸­ï¼Œå¸¸è§çš„æ–¹æ³•åŒ…æ‹¬ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>æš´åŠ›æœç´¢ï¼ˆBrute Forceï¼‰&lt;/strong>ï¼šç®€å•å¯é ï¼Œä½†æ—¶é—´å¤æ‚åº¦é«˜ï¼ˆ$O(N^2)$ï¼‰ï¼Œåœ¨å¤§è§„æ¨¡é—®é¢˜ä¸­æ•ˆç‡ä½ä¸‹ï¼›&lt;/li>
&lt;li>&lt;strong>é“¾è¡¨æœç´¢ï¼ˆLinked-Cell/Grid-basedï¼‰&lt;/strong>ï¼šé€šè¿‡ç©ºé—´åˆ’åˆ†æ˜¾è‘—å‡å°‘æœç´¢ç²’å­æ•°ï¼Œæ˜¯å®é™…ä¸­å¸¸ç”¨çš„é«˜æ•ˆæ–¹æ³•ï¼›&lt;/li>
&lt;li>&lt;strong>æ ‘æœç´¢ï¼ˆå¦‚ Octree æˆ– KD-treeï¼‰&lt;/strong>ï¼šé€‚åˆä¸å‡åŒ€ç²’å­åˆ†å¸ƒï¼Œå°¤å…¶é€‚ç”¨äºå¤©ä½“ç‰©ç†æ¨¡æ‹Ÿä¸­çš„è‡ªé€‚åº”ç²¾åº¦é—®é¢˜ï¼Œè‰¯å¥½çš„æ ‘ä»£ç å…·æœ‰éå¸¸é«˜çš„é²æ£’æ€§ã€‚å¦‚æœè¦è€ƒè™‘è‡ªå¼•åŠ›ï¼Œé‚£ä¹ˆæ ‘æœç´¢æ˜¯æ•ˆç‡å’Œç²¾åº¦éƒ½ä¸é”™çš„é€‰æ‹©ã€‚&lt;/li>
&lt;/ol>
&lt;p>æœ¬æ–‡å°†ä»¥æš´åŠ›æœç´¢ä½œä¸ºç»“æœåŸºçº¿ï¼Œé‡ç‚¹ä»‹ç»å¦‚ä½•é«˜æ•ˆå®ç°é“¾è¡¨æœç´¢å’Œæ ‘æœç´¢ï¼Œå¹¶æ¯”è¾ƒå®ƒä»¬åœ¨å®é™… SPH æ¨¡æ‹Ÿä¸­çš„æ€§èƒ½è¡¨ç°ã€‚&lt;/p>
&lt;h2 id="1-é“¾è¡¨æœç´¢linked-cellgrid-based">1. é“¾è¡¨æœç´¢ï¼ˆLinked-Cell/Grid-basedï¼‰
&lt;/h2>&lt;p>åœ¨å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå³æ‰€æœ‰ç²’å­çš„\( h_i \)éƒ½ç›¸ç­‰ï¼Œåº”ç”¨é“¾è¡¨æœç´¢æ³•éå¸¸æœ‰æ•ˆã€‚Monaghan å’Œ Gingold(1983)æå‡ºï¼Œå¯ä»¥é€šè¿‡å¯¹ç²’å­çš„ç©ºé—´åŒºåŸŸåˆ’åˆ†ç½‘æ ¼ï¼Œè®°å½•æ¯ä¸ªç½‘æ ¼å†…çš„ç²’å­ç¼–å·ã€‚è¿™æ ·åœ¨æœç´¢ç²’å­çš„é‚»å±…æ—¶ï¼Œåªéœ€è¦éå†å½“å‰ç²’å­ç½‘æ ¼çš„é‚»å±…ç½‘æ ¼å†…çš„ç²’å­å³å¯ã€‚æ­¤æ–¹æ³•åœ¨ä¼ ç»ŸSPHä»£ç ä¸­ä½¿ç”¨éå¸¸å¤šï¼Œå¦‚Monaghan(1985)ï¼ŒRhoades(1992)ï¼ŒSimpson(1995)ç­‰ã€‚&lt;/p>
&lt;p>åœ¨å®ç°é“¾è¡¨ç®—æ³•æ—¶ï¼Œè¦åœ¨é—®é¢˜åŸŸä¸Šé“ºè®¾ä¸€ä¸´æ—¶ç½‘æ ¼ã€‚ç½‘æ ¼å•å…ƒçš„ç©ºé—´å¤§å°åº”é€‰å–ä¸æ”¯æŒåŸŸçš„ç©ºé—´å¤§å°ä¸€è‡´ã€‚è‹¥å…‰æ»‘å‡½æ•°æ”¯æŒåŸŸçš„è®¡é‡å°ºåº¦ä¸º \( \eta h \)ï¼Œåˆ™ç½‘æ ¼å•å…ƒçš„å°ºåº¦ä¹Ÿå¿…é¡»è®¾ç½®ä¸º \( \eta h \)ã€‚é‚£ä¹ˆï¼Œå¯¹äºç»™å®šçš„ç²’å­iï¼Œå…¶ç›¸é‚»ç²’å­åªèƒ½åœ¨åŒä¸€ç½‘æ ¼å•å…ƒå†…ï¼Œæˆ–è€…åœ¨ç´§å¯†ç›¸é‚»çš„å•å…ƒå†…ã€‚æ‰€ä»¥ï¼Œå½“ \( \eta = 2 \) æ—¶ï¼Œåœ¨ä¸€ç»´ã€äºŒç»´å’Œä¸‰ç»´ç©ºé—´é‡Œçš„æœç´¢èŒƒå›´åˆ†åˆ«æ˜¯åœ¨ 3,9,27 ä¸ªå•å…ƒå†…ã€‚é“¾è¡¨æœç´¢æ³•å°†æ¯ä¸ªç²’å­éƒ½åˆ†å¸ƒåœ¨ç½‘æ ¼å•å…ƒå†…ï¼Œå¹¶é€šè¿‡ç®€å•çš„å­˜å‚¨è§„åˆ™å°†æ¯ä¸ªç½‘æ ¼å†…çš„æ‰€æœ‰ç²’å­è¿æ¥èµ·æ¥ã€‚è‹¥æ¯ä¸ªå•å…ƒå†…çš„å¹³å‡ç²’å­æ•°é‡è¶³å¤Ÿå°ï¼Œåˆ™é“¾è¡¨æœç´¢æ³•çš„å¤æ‚åº¦é˜¶æ•°ä¸º \( O(N) \)ã€‚&lt;/p>
&lt;p>é“¾è¡¨æœç´¢æ³•å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå½“å…‰æ»‘é•¿åº¦å¯å˜æ—¶ï¼Œå°¤å…¶æ˜¯æ¨¡æ‹Ÿåˆ†è¾¨ç‡å˜åŒ–çš„é—®é¢˜æ—¶ï¼Œç½‘æ ¼ç©ºé—´å°±ä¸èƒ½é€‚åº”æ¯ä¸€ä¸ªç²’å­ï¼Œæ­¤æ—¶è‹¥å†åº”ç”¨é“¾è¡¨æœç´¢æ³•ï¼Œåˆ™æœç´¢æ•ˆç‡ä¼šå¾ˆä½ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¯¥æ–¹æ³•åœ¨CUDAä¸Šå®ç°æ—¶ï¼Œéœ€è¦å¯¹æ˜¾å­˜åˆ†é…è¿›è¡Œå°å¿ƒå¤„ç†ï¼Œä¸ç„¶å¾ˆå®¹æ˜“å ç”¨è¶…å¤§æ˜¾å­˜ï¼ˆä¸»è¦åœ¨å­˜å‚¨ç½‘æ ¼ç²’å­ç¼–å·æ—¶ï¼‰ã€‚ä¸‹é¢é¦–å…ˆå°±å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„æƒ…å†µä¸‹è¿›è¡Œä»£ç è¯´æ˜ã€‚&lt;/p>
&lt;h3 id="å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„é“¾è¡¨æœç´¢">å…‰æ»‘é•¿åº¦ä¸ºç©ºé—´å¸¸é‡çš„é“¾è¡¨æœç´¢
&lt;/h3>&lt;p>æˆ‘ä»¬å…ˆæ¥çœ‹é“¾è¡¨æœç´¢ç®—æ³•çš„åŸºç¡€ç‰ˆæœ¬ã€‚å®ç°è¯¥ç®—æ³•éœ€è¦ä¸¤ä¸ªæ­¥éª¤ï¼š&lt;/p>
&lt;ol>
&lt;li>è®°å½•æ¯ä¸ªç½‘æ ¼å•å…ƒä¸­åŒ…å«å“ªäº›ç²’å­ï¼Œå¹¶è®°å½•æ¯ä¸ªç²’å­æ‰€å±çš„å•å…ƒï¼›&lt;/li>
&lt;li>éå†æ‰€æœ‰ç²’å­ï¼Œå¯¹æ¯ä¸ªç²’å­çš„å•å…ƒåŠå…¶é‚»æ¥å•å…ƒè¿›è¡Œæ‰«æï¼ŒæŸ¥æ‰¾å¯èƒ½çš„é‚»å±…ç²’å­ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œæœ¬æ–‡åªå±•ç¤ºæ ¸å‡½æ•°çš„ç¼–å†™ï¼Œä¸”ä¸åœ¨æ¯æ¬¡è°ƒç”¨ä¸­åå¤ç”³è¯·æˆ–é‡Šæ”¾å†…å­˜ã€‚&lt;/p>
&lt;p>ç¬¬ä¸€ä¸ªæ ¸å‡½æ•°è¾ƒä¸ºç®€å•ï¼Œå…¶ç”¨äºæ„å»ºç²’å­ä¸ç½‘æ ¼å•å…ƒä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚&lt;/p>
&lt;h4 id="æ ¸å‡½æ•°å£°æ˜ä¸ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—">æ ¸å‡½æ•°å£°æ˜ä¸ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—
&lt;/h4>&lt;p>ä¸‹é¢æ˜¯ç”¨äºå»ºç«‹ç²’å­ä¸ç½‘æ ¼å•å…ƒä¹‹é—´æ˜ å°„å…³ç³»çš„ CUDA æ ¸å‡½æ•° &lt;code>particleLoop&lt;/code>ï¼Œä»¥åŠé…å¥—çš„ç²’å­ç½‘æ ¼ç´¢å¼•è®¡ç®—å‡½æ•° &lt;code>particleGridIndex&lt;/code>ã€‚æœ¬ç‰ˆæœ¬å‡è®¾æ‰€æœ‰ç²’å­çš„æ ¸é•¿åº¦ $h$ æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œè®°ä¸º &lt;code>h[0]&lt;/code>ã€‚&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define DIM 3 // ç©ºé—´ç»´åº¦ï¼šå¯è®¾ä¸º 1, 2 æˆ– 3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define MAX_PARTICLES_PER_GRID 200 // æ¯ä¸ªç½‘æ ¼å•å…ƒæœ€å¤šå¯å®¹çº³çš„ç²’å­æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define eta 2 // æ ¸é•¿åº¦æ¯”ä¾‹å› å­&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">//&lt;/span> &lt;span class="n">CUDA&lt;/span> &lt;span class="err">æ ¸å‡½æ•°ï¼šæ„å»ºæ¯ä¸ªç²’å­æ‰€å±ç½‘æ ¼ï¼Œä»¥åŠæ¯ä¸ªç½‘æ ¼ä¸­çš„ç²’å­åˆ—è¡¨&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__global__&lt;/span> &lt;span class="n">void&lt;/span> &lt;span class="n">particleLoop&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">åæ ‡ï¼Œé•¿åº¦ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">æ–¹å‘æœ€å°åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="err">æ–¹å‘ç½‘æ ¼æ•°&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">ceil&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">maxx&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="err">Î·&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">y&lt;/span> &lt;span class="err">åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 2 &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­&lt;/span> &lt;span class="n">z&lt;/span> &lt;span class="err">åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­çš„æ ¸é•¿åº¦ï¼ˆæ­¤ç‰ˆæœ¬ä¸ºå¸¸é‡ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼ä¸­ç²’å­ç´¢å¼•åˆ—è¡¨ï¼Œå¤§å°ä¸º&lt;/span> &lt;span class="n">numGrids&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="err">æ— é¡»åˆå§‹åŒ–&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ä¸ºé¿å…æ•°æ®ç«äº‰ï¼Œä½¿ç”¨ä¸€ä¸ª&lt;/span>&lt;span class="n">gridWritingPointeræ¥è®°å½•å†™å…¥ä½ç½®&lt;/span>&lt;span class="err">ï¼Œé•¿åº¦ä¸º&lt;/span>&lt;span class="n">numGrids&lt;/span>&lt;span class="err">ï¼Œéœ€è¦åˆå§‹åŒ–ä¸º&lt;/span>&lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">particleGridList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­æ‰€å±ç½‘æ ¼ç´¢å¼•ï¼Œé•¿åº¦ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç²’å­æ€»æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numGrids&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼æ€»æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">tid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è®¡ç®—ç²’å­åœ¨ç½‘æ ¼ä¸­çš„ç´¢å¼•åæ ‡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">Î·&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM &amp;gt; 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="ne">int&lt;/span>&lt;span class="p">((&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">eta&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è·å–ç²’å­æ‰€åœ¨ç½‘æ ¼çš„çº¿æ€§ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">gridIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#if DIM == 1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#elif DIM == 2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#else // DIM == 3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#endif&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">particleGridList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è·å–å½“å‰ç½‘æ ¼çš„&lt;/span>&lt;span class="n">gridWritingPointerä½ç½®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">writingPointer&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">atomicAdd&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="o">&amp;amp;&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">gridIndex&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">);&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="n">atomicAddè¿”å›å†™å…¥ä½ç½®&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">gridIndex&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">writingPointer&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">tid&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä½¿ç”¨ä¸Šè¿°å‡½æ•°æ—¶è¦æ³¨æ„ï¼Œå½“ç½‘æ ¼ä¸ªæ•°å¾ˆå¤šæ—¶ï¼Œå®¹æ˜“è¶…è¿‡intçš„è¡¨è¾¾èŒƒå›´ã€‚æ­¤å¤–ï¼Œå‰ç½®æ¡ä»¶æ˜¯éœ€è¦çŸ¥é“æœ€å°å’Œæœ€å¤§çš„ç²’å­åæ ‡ï¼Œé•¿æ•°ç»„æ±‚æœ€å¤§æœ€å°å€¼å¯ä»¥ä½¿ç”¨scanç®—æ³•ï¼Œä»¥åæœ‰ç©ºä¹Ÿä¼šä»‹ç»æ­¤ç±»ç®—æ³•ã€‚&lt;/p>
&lt;p>è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å»ºç«‹äº†ç©ºé—´ç²’å­ä¸ç½‘æ ¼ä¹‹é—´çš„è”ç³»ï¼Œç°åœ¨å¯ä»¥éå†ç²’å­ï¼Œè·å–ä»–ä»¬çš„é‚»å±…ç²’å­ã€‚æˆ‘ç›®å‰æƒ³åˆ°ä¸¤ç§éå†æ–¹æ³•ï¼Œ1. æŒ‰ç²’å­é¡ºåºéå†ï¼ˆä¸‹é¢ç§°A1ï¼‰ 2. æŒ‰ç½‘æ ¼é¡ºåºéå†ï¼ˆä¸‹é¢ç§°A1ï¼‰ã€‚&lt;/p>
&lt;h4 id="æœç´¢">æœç´¢
&lt;/h4>&lt;h5 id="æŒ‰ç²’å­é¡ºåºéå†a1">æŒ‰ç²’å­é¡ºåºéå†(A1)
&lt;/h5>&lt;p>é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªéå†æ–¹æ³•ï¼šæŒ‰ç²’å­é¡ºåºéå†(A1)ã€‚äº‹å®ä¸Š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#define MAX_NEIGHBORS 200 // æ¯ä¸ªç²’å­æœ€å¤šçš„é‚»å±…æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">__global__&lt;/span> &lt;span class="n">void&lt;/span> &lt;span class="n">neighborSearchByParticles&lt;/span>&lt;span class="p">(&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">y&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">z&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">h&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">ç½‘æ ¼ä¸­ç²’å­ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç½‘æ ¼ä¸­çš„ç²’å­æ•°é‡ï¼ˆå·²ç”±&lt;/span>&lt;span class="n">atomicAddæ›´æ–°&lt;/span>&lt;span class="err">ï¼‰&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">particleGridList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">æ¯ä¸ªç²’å­æ‰€åœ¨ç½‘æ ¼ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">miny&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="n">double&lt;/span> &lt;span class="n">minz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="k">const&lt;/span> &lt;span class="ne">int&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">neighborList&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">è¾“å‡ºï¼šæ¯ä¸ªç²’å­çš„é‚»å±…åˆ—è¡¨ï¼Œå¤§å°ä¸º&lt;/span> &lt;span class="n">numParticles&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="n">neighborCount&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="o">//&lt;/span> &lt;span class="err">è¾“å‡ºï¼šæ¯ä¸ªç²’å­çš„é‚»å±…æ•°&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">numParticles&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">tid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">threadIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">blockIdx&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">blockDim&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">numParticles&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">return&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">xi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">yi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">zi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">hi&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">h&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">hi2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">hi&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">hi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">particleGridList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">è®¡ç®—è¯¥ç²’å­æ‰€åœ¨ç½‘æ ¼çš„åæ ‡ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">gridIndex&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridIndex&lt;/span> &lt;span class="o">/&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">);&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">éå†è¯¥ç²’å­æ‰€åœ¨ç½‘æ ¼åŠå…¶å‘¨å›´&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="n">x3x3&lt;/span> &lt;span class="err">ç½‘æ ¼&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">ix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dx&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">nix&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">nx&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dy&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iy&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dy&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">niy&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">&amp;lt;=&lt;/span> &lt;span class="mi">1&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">dz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">iz&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dz&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">niz&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">&amp;gt;=&lt;/span> &lt;span class="n">nz&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="o">//&lt;/span> &lt;span class="err">ç›¸é‚»ç½‘æ ¼ç´¢å¼•&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">neighborGrid&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">nix&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">niy&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">niz&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">nx&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">ny&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">npg&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridWritingPointer&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">neighborGrid&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="ne">int&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">k&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">npg&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="o">++&lt;/span>&lt;span class="n">k&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="ne">int&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gridParticlesList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">neighborGrid&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_PARTICLES_PER_GRID&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">k&lt;/span>&lt;span class="p">];&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">j&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">tid&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">continue&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dx&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">x&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">xi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dy&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">y&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">yi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dz&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">z&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">zi&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">double&lt;/span> &lt;span class="n">dist2&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">dx&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dx&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dy&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dy&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">dz&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">dz&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">dist2&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">hi2&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="n">count&lt;/span> &lt;span class="o">&amp;lt;&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighborList&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">MAX_NEIGHBORS&lt;/span> &lt;span class="o">+&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">j&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">count&lt;/span>&lt;span class="o">++&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">neighborCount&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">tid&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">count&lt;/span>&lt;span class="p">;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>äº‹å®ä¸Šï¼Œ&lt;code>particleGridList&lt;/code> æ•°ç»„æ˜¯ä¸“é—¨ä¸º &lt;strong>A1 æ–¹æ¡ˆ&lt;/strong> è®¾è®¡çš„ï¼›è€Œè‹¥é‡‡ç”¨ &lt;strong>A2 æ–¹æ¡ˆ&lt;/strong>ï¼Œåˆ™æ— éœ€è¯¥æ•°ç»„ã€‚&lt;/p>
&lt;p>A1 çš„ç¼ºç‚¹åœ¨äºï¼šå½“ç²’å­åœ¨æ•°ç»„ä¸­å‘ˆéšæœºæ’å¸ƒæ—¶ï¼Œçº¿ç¨‹æŸï¼ˆwarpï¼‰ä¹‹é—´å¯¹ç²’å­å±æ€§å’Œç½‘æ ¼æ•°æ®çš„è®¿é—®ä¹Ÿå°†æ˜¯éšæœºçš„ã€‚åœ¨ CUDA ç¼–ç¨‹ä¸­ï¼Œè®¿å­˜æ¨¡å¼å¯¹æ€§èƒ½å½±å“æå¤§ï¼Œå› æ­¤å¯ä»¥é¢„æœŸ A1 çš„æ•ˆç‡ä¸ä¼šéå¸¸ç†æƒ³ã€‚&lt;/p>
&lt;p>åœ¨ä¸€ä¸ªå¤±çœ çš„æ·±å¤œï¼Œæˆ‘æ€è€ƒäº†ä¸¤ä¸ªé—®é¢˜ï¼š&lt;/p>
&lt;ol>
&lt;li>&lt;strong>å¦‚ä½•ä¼˜åŒ– A1 çš„è®¿å­˜æ¨¡å¼ï¼Ÿ&lt;/strong>&lt;/li>
&lt;li>&lt;strong>å½“ç²’å­çš„æ ¸å°ºåº¦ \( h \) ç›¸å·®æ‚¬æ®Šï¼ˆä¾‹å¦‚åœ¨æ¨¡æ‹Ÿæœˆçƒé­å—å°è¡Œæ˜Ÿæ’å‡»æ—¶ï¼Œ\(h_{min} â‰ˆ 1\)ï¼Œ\(h_{max} â‰ˆ 500\)ï¼‰ï¼Œå¦‚ä½•åœ¨é“¾è¡¨ç»“æ„ä¸­é«˜æ•ˆæ”¯æŒå¦‚æ­¤å¤§çš„è·¨åº¦ï¼Ÿ&lt;/strong>&lt;/li>
&lt;/ol>
&lt;p>å…³äºè¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘å„è‡ªæœ‰ä¸€äº›è®¾æƒ³å’Œåˆæ­¥å®ç°ï¼Œæ¥ä¸‹æ¥å°†é€ä¸€ä»‹ç»ï¼Œå¹¶è¿›è¡Œæµ‹è¯•å’Œåˆ†æã€‚&lt;/p>
&lt;hr>
&lt;h4 id="a2æŒ‰ç½‘æ ¼é¡ºåºéå†ç²’å­">A2ï¼šæŒ‰ç½‘æ ¼é¡ºåºéå†ç²’å­
&lt;/h4>&lt;p>ï¼ˆæ­¤å¤„è¡¥å…… A2 çš„å®ç°ç®€ä»‹å’Œæ€§èƒ½ç‰¹ç‚¹ã€‚ï¼‰
æ›´å¤šå…³äºæ ‘æœç´¢çš„å†…å®¹å¯ä»¥å‚è§[æ ‘æœç´¢]æ›´å¤šå…³äºæ ‘æœç´¢çš„å†…å®¹å¯ä»¥å‚è§&lt;a class="link" href="https://keqiye.github.io/posts/SPH_neighbor_search/tree_search/" >æ ‘æœç´¢&lt;/a>.&lt;/p></description></item><item><title>åŸºäºæ ‘ç»“æ„çš„ SPH ç²’å­é¢†åŸŸæœç´¢</title><link>https://keqiye.github.io/zh-cn/posts/cudatreecode/blog-post-treecode/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><author>plloningye@gmail.com (Keqi Ye)</author><guid>https://keqiye.github.io/zh-cn/posts/cudatreecode/blog-post-treecode/</guid><description>&lt;h1 id="æ ‘ç»“æ„åŸºäºæ ¹æ®-burtscher-å’Œ-pingali-çš„ç ”ç©¶">æ ‘ç»“æ„ï¼ˆåŸºäºæ ¹æ® Burtscher å’Œ Pingali çš„ç ”ç©¶ï¼‰
&lt;/h1>&lt;p>æœ¬æ–‡å°†ä»‹ç»å¹¿æ³›ç”¨äº SPH ä»£ç å’Œ N ä½“æ¨¡æ‹Ÿä¸­çš„æ ‘ç»“æ„ï¼ˆTree Structureï¼‰ã€‚è¿™ç§æ•°æ®ç»“æ„ä¸»è¦åº”ç”¨äºä»¥ä¸‹ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š&lt;/p>
&lt;h3 id="1-ç²’å­é¢†åŸŸæœç´¢neighbor-search">1. ç²’å­é¢†åŸŸæœç´¢ï¼ˆNeighbor Searchï¼‰
&lt;/h3>&lt;p>åœ¨ SPHï¼ˆå…‰æ»‘ç²’å­æµä½“åŠ›å­¦ï¼‰æ¨¡æ‹Ÿä¸­ï¼Œæ¯ä¸ªç²’å­éœ€è¦åœ¨æ ¸å°ºåº¦ \( h \) èŒƒå›´å†…æŸ¥æ‰¾é‚»å±…ç²’å­ï¼Œä»¥ä¾¿è®¡ç®—å¯†åº¦ã€å‹å¼ºæ¢¯åº¦ã€ç²˜æ€§ç­‰ç‰©ç†é‡ã€‚æ ‘ç»“æ„èƒ½å¤ŸåŠ é€Ÿé‚»åŸŸæœç´¢ï¼Œå°¤å…¶é€‚ç”¨äºç²’å­åˆ†å¸ƒé«˜åº¦éå‡åŒ€çš„æƒ…å½¢ã€‚&lt;/p>
&lt;h3 id="2-è‡ªå¼•åŠ›è®¡ç®—self-gravity-computation">2. è‡ªå¼•åŠ›è®¡ç®—ï¼ˆSelf-Gravity Computationï¼‰
&lt;/h3>&lt;p>åœ¨å¼•åŠ›ä¸»å¯¼çš„ç²’å­ç³»ç»Ÿï¼ˆå¦‚æ˜Ÿç³»æ¨¡æ‹Ÿã€æ˜Ÿä½“ç¢°æ’ï¼‰ä¸­ï¼Œç²’å­é—´å­˜åœ¨ä¸‡æœ‰å¼•åŠ›ä½œç”¨ã€‚ç›´æ¥è®¡ç®—æ‰€æœ‰ç²’å­å¯¹çš„å¼•åŠ›å¼€é”€ä¸º \( \mathcal{O}(N^2) \)ï¼Œä¸å¯æ¥å—ã€‚åŸºäºæ ‘çš„è¿‘ä¼¼æ–¹æ³•ï¼ˆå¦‚ Barnes-Hut ç®—æ³•ï¼‰å¯å°†è®¡ç®—å¤æ‚åº¦é™è‡³ \( \mathcal{O}(N \log N) \)ï¼ŒåŒæ—¶ä¿æŒè¾ƒé«˜ç²¾åº¦ã€‚&lt;/p>
&lt;hr>
&lt;p>æ¥ä¸‹æ¥çš„ç« èŠ‚å°†åˆ†åˆ«ä»‹ç»æ ‘ç»“æ„åœ¨ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜ä¸­çš„æ„å»ºæ–¹æ³•ã€æœç´¢ç­–ç•¥å’Œæ€§èƒ½ä¼˜åŒ–ã€‚&lt;/p>
&lt;p>å…³äºä¼ ç»Ÿçš„ &lt;strong>é“¾è¡¨æ³•ï¼ˆLinked-Listï¼‰&lt;/strong> ç²’å­é¢†åŸŸæœç´¢ï¼Œè¯·å‚è€ƒæˆ‘å¦ä¸€ç¯‡åšæ–‡ï¼š ğŸ‘‰ &lt;a class="link" href="https://keqiye.github.io/posts/SPH_neighbor_search/" >ä½¿ç”¨é“¾è¡¨è¿›è¡Œ SPH é‚»åŸŸæœç´¢&lt;/a>&lt;/p>
&lt;h1 id="å®ç°æ­¥éª¤">å®ç°æ­¥éª¤
&lt;/h1>&lt;p>æ ¹æ®ç›¸å…³æ–‡çŒ®ï¼Œæ¯æ¬¡æ‰§è¡Œè‡ªå¼•åŠ›è®¡ç®—æˆ–ç²’å­é‚»åŸŸæœç´¢æ—¶ï¼Œé€šå¸¸éœ€è¦ä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>ç¡®å®šç²’å­ç©ºé—´èŒƒå›´&lt;/strong>&lt;br>
ç»Ÿè®¡æ‰€æœ‰ç²’å­çš„ç©ºé—´è¾¹ç•Œï¼Œè·å– \( x_{\min}, x_{\max}, y_{\min}, y_{\max}, z_{\min}, z_{\max} \)ï¼Œç”¨äºåˆå§‹åŒ–æ ‘ç»“æ„çš„æ ¹èŠ‚ç‚¹æˆ–ç©ºé—´åˆ’åˆ†èŒƒå›´ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ„å»ºæ ‘ç»“æ„&lt;/strong>&lt;br>
å°†ç²’å­é€’å½’åˆ’åˆ†åˆ°ç©ºé—´æ ‘èŠ‚ç‚¹ä¸­ï¼Œå¸¸ç”¨çš„æ•°æ®ç»“æ„åŒ…æ‹¬å…«å‰æ ‘ï¼ˆOctreeï¼‰æˆ– KD æ ‘ã€‚æ¯ä¸ªå¶å­èŠ‚ç‚¹åŒ…å«è‹¥å¹²ç²’å­æˆ–è¾¾åˆ°æœ€å°åˆ’åˆ†æ¡ä»¶ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>ç²’å­ç©ºé—´æ’åº&lt;/strong>&lt;br>
å¯¹ç²’å­è¿›è¡Œ Morton ç¼–ç ï¼ˆZ-order curveï¼‰æˆ– Hilbert æ›²çº¿ç¼–ç ï¼Œå¹¶æŒ‰ç…§ç©ºé—´ä½ç½®æ’åºï¼Œä¾¿äºç¼“å­˜ä¸€è‡´æ€§å’Œåç»­å¹¶è¡Œå¤„ç†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æ ‘éå†è®¡ç®—&lt;/strong>&lt;br>
éå†æ ‘ç»“æ„ï¼š&lt;/p>
&lt;ul>
&lt;li>è‹¥æ‰§è¡Œ &lt;strong>è‡ªå¼•åŠ›è®¡ç®—&lt;/strong>ï¼Œä½¿ç”¨ Barnes-Hut è¿‘ä¼¼è§„åˆ™åˆ¤æ–­æ˜¯å¦èšåˆèŠ‚ç‚¹è´¨é‡ï¼›&lt;/li>
&lt;li>è‹¥æ‰§è¡Œ &lt;strong>é‚»åŸŸæœç´¢&lt;/strong>ï¼Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸­åˆ¤æ–­ä¸æŸ¥è¯¢ç²’å­çš„è·ç¦»æ˜¯å¦å°äºæ ¸å°ºåº¦ \( h \)ï¼Œä»è€Œç­›é€‰å¯èƒ½é‚»å±…ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;h2 id="ç¡®å®šç²’å­ç©ºé—´èŒƒå›´">ç¡®å®šç²’å­ç©ºé—´èŒƒå›´
&lt;/h2>&lt;p>ç›´æ¥ä½¿ç”¨è§„çº¦ç®—æ³•æ±‚æœ€å¤§æœ€å°å€¼&lt;/p>
&lt;h2 id="æ„å»ºæ ‘ç»“æ„">æ„å»ºæ ‘ç»“æ„
&lt;/h2>&lt;p>ç”±äº GPU ä¸Šæ— æ³•é«˜æ•ˆå®ç°æŒ‡é’ˆå¼é“¾è¡¨ç»“æ„ï¼Œæˆ‘ä»¬ä½¿ç”¨æ•°ç»„æ¥æ¨¡æ‹Ÿæ ‘çš„é“¾æ¥å…³ç³»ï¼ˆä¾‹å¦‚å­èŠ‚ç‚¹æŒ‡é’ˆï¼‰ã€‚å‡è®¾æœ‰ä¸€ä¸ªæ•´å‹æ•°ç»„ &lt;code>child&lt;/code>ï¼Œå…¶é•¿åº¦è¿œå¤§äºç²’å­æ€»æ•° &lt;code>numParticles&lt;/code>ï¼Œå¹¶åˆå§‹åŒ–ä¸º &lt;code>-1&lt;/code>ï¼Œè¡¨ç¤ºæ‰€æœ‰èŠ‚ç‚¹å°šæœªä½¿ç”¨ã€‚&lt;/p>
&lt;h3 id="åŒºåˆ†å¶å­èŠ‚ç‚¹ä¸æ ¹èŠ‚ç‚¹">åŒºåˆ†å¶å­èŠ‚ç‚¹ä¸æ ¹èŠ‚ç‚¹
&lt;/h3>&lt;p>åœ¨æ ‘ç»“æ„ä¸­ï¼Œå¦‚ä½•åŒºåˆ†æ•´å‹æ•°ç»„ &lt;code>child&lt;/code> çš„æŸä¸€ä¸ªä½ç½®å­˜å‚¨çš„æ˜¯ &lt;strong>å¶å­èŠ‚ç‚¹ï¼ˆç²’å­ï¼‰&lt;/strong> è¿˜æ˜¯ &lt;strong>æ ¹èŠ‚ç‚¹&lt;/strong> æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚&lt;/p>
&lt;h4 id="æ ‡è¯†æ–¹æ³•">æ ‡è¯†æ–¹æ³•ï¼š
&lt;/h4>&lt;ul>
&lt;li>&lt;strong>&lt;code>-1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®ä¸ºç©ºï¼Œæœªè¢«å ç”¨ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>-2&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®å·²è¢«é”å®šï¼Œå½“å‰çº¿ç¨‹æ­£åœ¨ä½¿ç”¨è¯¥ä½ç½®ï¼ˆé€šå¸¸ç”¨äºè¿›è¡ŒåŸå­æ“ä½œï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>-3&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥ä½ç½®æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä¸€å®šä¼šæœ‰å­æ ‘ï¼ˆå¯èƒ½æ˜¯å­èŠ‚ç‚¹ï¼Œä¹Ÿå¯èƒ½æ˜¯ç²’å­ï¼Œç²’å­çš„å­èŠ‚ç‚¹ä¸€å®šä¸ºç©ºï¼š-1ï¼‰ã€‚&lt;/li>
&lt;li>&lt;strong>&lt;code>0&lt;/code> åˆ° &lt;code>numParticles - 1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤º &lt;strong>ç²’å­&lt;/strong>ï¼Œæ¯ä¸ªä½ç½®å¯¹åº”ä¸€ä¸ªç²’å­ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ˜¾ç„¶ï¼Œå¦‚æœç¬¬ &lt;code>i&lt;/code> ä¸ªä½ç½®è¢«é”å®šï¼Œé‚£ä¹ˆï¼š&lt;/p>
&lt;ul>
&lt;li>åœ¨ &lt;strong>ä¸‰ç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>8*i+1+0&lt;/code> åˆ° &lt;code>7&lt;/code>ï¼ˆå³ä¸€ä¸ªå…«å²”æ ‘åŠå…¶å­æ ‘ç­‰ï¼‰éƒ½è¢«é”å®šï¼›&lt;/li>
&lt;li>åœ¨ &lt;strong>äºŒç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>4*i+1+0&lt;/code> åˆ° &lt;code>3&lt;/code>ï¼ˆå³ä¸€ä¸ªå››å²”æ ‘åŠå…¶å­æ ‘ç­‰ï¼‰éƒ½è¢«é”å®šï¼›&lt;/li>
&lt;li>åœ¨ &lt;strong>ä¸€ç»´&lt;/strong> æƒ…å†µä¸‹ï¼Œ&lt;code>i&lt;/code> åŠå…¶ç›¸é‚»éƒ¨åˆ†ä¹Ÿä¼šè¢«é”å®šã€‚&lt;/li>
&lt;/ul>
&lt;p>æ³¨æ„ï¼Œä»»æ„ç´¢å¼•&lt;code>i&lt;/code>çš„å­èŠ‚ç‚¹è®¡ç®—æ–¹æ³•ä¸ºï¼š&lt;code>8*i+1+0&lt;/code>ï¼Œä¸ä¼ ç»Ÿçš„å…«å‰æ ‘è®¡ç®—æ–¹æ³•ä¸åŒï¼Œè¿™æ˜¯å› ä¸ºæˆ‘çš„ä»£ç ä¸­ï¼Œ0èŠ‚ç‚¹ä¿å­˜çš„æ˜¯æœ€å¤§çš„æ ¹èŠ‚ç‚¹ä¿¡æ¯ã€‚&lt;/p>
&lt;p>&amp;ndash; è¿™æ„å‘³ç€ï¼Œå¦‚æœä¸€ä¸ªä½ç½®è¢«é”å®šï¼Œ&lt;strong>å…¶ä»–çº¿ç¨‹å°†æ— æ³•è®¿é—®è¯¥ä½ç½®çš„å­æ ‘æˆ–å…¶å­æ ‘çš„å­æ ‘&lt;/strong>ï¼Œç¡®ä¿äº†å¹¶è¡Œè®¡ç®—ä¸­èŠ‚ç‚¹åŠå…¶ç›¸å…³å­èŠ‚ç‚¹çš„å®‰å…¨ã€‚&lt;/p>
&lt;h3 id="ä½¿ç”¨åŸå­æ“ä½œåŒæ­¥çº¿ç¨‹">ä½¿ç”¨åŸå­æ“ä½œåŒæ­¥çº¿ç¨‹
&lt;/h3>&lt;p>å½“å¤šä¸ªçº¿ç¨‹å¹¶å‘åœ°å°è¯•è®¿é—®åŒä¸€ä¸ªå­èŠ‚ç‚¹æ§½ä½æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ CUDA æä¾›çš„åŸå­æ“ä½œ &lt;code>atomicCAS&lt;/code>ï¼ˆCompare And Swapï¼‰æ¥è¿›è¡Œçº¿ç¨‹é—´åŒæ­¥ã€‚&lt;/p>
&lt;p>ä»¥ä¸‹æ˜¯åŸå­æ“ä½œçš„ä»£ç ç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">int re = atomicCAS(&amp;amp;child[p], -1, -2); // å°è¯•å ç”¨ child[p]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>è¯¥æ“ä½œçš„å«ä¹‰æ˜¯ï¼š&lt;/p>
&lt;ul>
&lt;li>&lt;strong>è‹¥ &lt;code>child[p] == -1&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºè¯¥æ§½ä½å°šæœªè¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹æˆåŠŸå°†å…¶åŸå­åœ°è®¾ç½®ä¸º &lt;code>-2&lt;/code>ï¼Œè¡¨ç¤ºâ€œé”å®šä¸­â€æˆ–â€œå‡†å¤‡æ’å…¥â€ï¼›&lt;/li>
&lt;li>&lt;strong>è‹¥ &lt;code>child[p] != -1&lt;/code>&lt;/strong>ï¼šè¯´æ˜è¯¥æ§½ä½å·²è¢«å…¶ä»–çº¿ç¨‹å ç”¨æˆ–å·²è¢«æ’å…¥ï¼Œå½“å‰çº¿ç¨‹éœ€é€€å‡ºæˆ–é‡è¯•ï¼›&lt;/li>
&lt;li>&lt;strong>è¿”å›å€¼ &lt;code>re&lt;/code>&lt;/strong>ï¼šè¡¨ç¤ºæ“ä½œå‰çš„æ—§å€¼ã€‚å¦‚æœ &lt;code>re == -1&lt;/code>ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹æˆåŠŸé”å®šäº†è¯¥èŠ‚ç‚¹ã€‚å¦‚æœ &lt;code>re != -1&lt;/code> ï¼Œåˆ™ &lt;code>atomicCAS&lt;/code> å‡½æ•°å‘ç°æ¯”è¾ƒä¸æˆç«‹ï¼Œç›´æ¥è¿”å›äº†æ—§å€¼ï¼Œä¹Ÿä¸ä¼šæ›¿æ¢&lt;code>-2&lt;/code>è€Œæ‰“ä¹±&lt;code>child&lt;/code>æ•°ç»„å†…å®¹ã€‚&lt;/li>
&lt;/ul>
&lt;p>å†™åˆ°è¿™é‡Œï¼Œæ ‘ç»“æ„æ•°ç»„&lt;code>child&lt;/code>çš„æ„å»ºå°±å¾ˆå®¹æ˜“äº†ã€‚ä¸‹é¢æ˜¯ä¼ªä»£ç &lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;span class="lnt">123
&lt;/span>&lt;span class="lnt">124
&lt;/span>&lt;span class="lnt">125
&lt;/span>&lt;span class="lnt">126
&lt;/span>&lt;span class="lnt">127
&lt;/span>&lt;span class="lnt">128
&lt;/span>&lt;span class="lnt">129
&lt;/span>&lt;span class="lnt">130
&lt;/span>&lt;span class="lnt">131
&lt;/span>&lt;span class="lnt">132
&lt;/span>&lt;span class="lnt">133
&lt;/span>&lt;span class="lnt">134
&lt;/span>&lt;span class="lnt">135
&lt;/span>&lt;span class="lnt">136
&lt;/span>&lt;span class="lnt">137
&lt;/span>&lt;span class="lnt">138
&lt;/span>&lt;span class="lnt">139
&lt;/span>&lt;span class="lnt">140
&lt;/span>&lt;span class="lnt">141
&lt;/span>&lt;span class="lnt">142
&lt;/span>&lt;span class="lnt">143
&lt;/span>&lt;span class="lnt">144
&lt;/span>&lt;span class="lnt">145
&lt;/span>&lt;span class="lnt">146
&lt;/span>&lt;span class="lnt">147
&lt;/span>&lt;span class="lnt">148
&lt;/span>&lt;span class="lnt">149
&lt;/span>&lt;span class="lnt">150
&lt;/span>&lt;span class="lnt">151
&lt;/span>&lt;span class="lnt">152
&lt;/span>&lt;span class="lnt">153
&lt;/span>&lt;span class="lnt">154
&lt;/span>&lt;span class="lnt">155
&lt;/span>&lt;span class="lnt">156
&lt;/span>&lt;span class="lnt">157
&lt;/span>&lt;span class="lnt">158
&lt;/span>&lt;span class="lnt">159
&lt;/span>&lt;span class="lnt">160
&lt;/span>&lt;span class="lnt">161
&lt;/span>&lt;span class="lnt">162
&lt;/span>&lt;span class="lnt">163
&lt;/span>&lt;span class="lnt">164
&lt;/span>&lt;span class="lnt">165
&lt;/span>&lt;span class="lnt">166
&lt;/span>&lt;span class="lnt">167
&lt;/span>&lt;span class="lnt">168
&lt;/span>&lt;span class="lnt">169
&lt;/span>&lt;span class="lnt">170
&lt;/span>&lt;span class="lnt">171
&lt;/span>&lt;span class="lnt">172
&lt;/span>&lt;span class="lnt">173
&lt;/span>&lt;span class="lnt">174
&lt;/span>&lt;span class="lnt">175
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">#define childListIndex(nodeIdx, childNum) ((nodeIdx) * TREETYPE + 1 + (childNum))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define EMPTY -1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define LOCKED -2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define TRUE 1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define FALSE 0
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">#define NODE -3
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//RealType4 æ˜¯ float4 æˆ– double4 çš„åˆ«åï¼Œæˆ‘è¿™æ ·å†™æ˜¯ä¸ºäº†åŒºåˆ†å•åŒç²¾åº¦è®¡ç®—ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼Œæ¶ˆè´¹çº§æ˜¾å¡çš„åŒç²¾åº¦è®¡ç®—èƒ½åŠ›æ¯”è¾ƒå·®ã€‚ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//ç²’å­çš„wåˆ†é‡å­˜æ”¾äº†è´¨é‡ï¼ŒèŠ‚ç‚¹çš„wåˆ†é‡å­˜æ”¾äº†èŠ‚ç‚¹åŠå¾„ï¼ˆæ­£æ–¹ä½“çš„è¾¹é•¿çš„ä¸€åŠï¼‰ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//ç›®å‰è¿˜æ²¡æœ‰æ·»åŠ èŠ‚ç‚¹è´¨å¿ƒçš„è®¡ç®—é€»è¾‘ï¼Œåç»­ä¼šåŠ ï¼Œç”¨äºè®¡ç®—ç²’å­çš„å¼•åŠ›ï¼Œå‚è€ƒï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">//A hierarchical O(N log N) force-calculation algorithm æœ¬æ–‡å‘è¡¨åœ¨natureä¸Šï¼Œé¡¶ç¤¼è†œæ‹œ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">__global__ void buildTreeKernel(SPHState *deviceP, treeData *tree)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä¸ºé¿å…æ··æ·†ï¼Œæ˜ç¡®åŒºåˆ†ç²’å­å’ŒèŠ‚ç‚¹çš„ä½ç½®æ•°ç»„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 *particlePositions = deviceP-&amp;gt;positions;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volatile RealType4 *nodePositions = tree-&amp;gt;positions;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 *nodeRoot = tree-&amp;gt;nodeRoot;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> volatile int *childList = tree-&amp;gt;childList;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childListLength = tree-&amp;gt;childListLength;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int numParticles = tree-&amp;gt;numParticles;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int inc = blockDim.x * gridDim.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int i = threadIdx.x + blockIdx.x * blockDim.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int k;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childIndex, child;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int lockedIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType x, y, z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootRadius = nodeRoot-&amp;gt;w;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootX = nodeRoot-&amp;gt;x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootY = nodeRoot-&amp;gt;y;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType rootZ = nodeRoot-&amp;gt;z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ·»åŠ è·Ÿè¸ªå½“å‰èŠ‚ç‚¹ä½ç½®çš„å˜é‡
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType currentX, currentY, currentZ, currentR;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int depth = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int isNewParticle = TRUE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int currentNodeIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> bool isInsert;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (i &amp;lt; numParticles)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = false;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (!isInsert)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> RealType4 pos = particlePositions[i];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> x = pos.x;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> y = pos.y;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> z = pos.z;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // å¼€å§‹äºæ ¹èŠ‚ç‚¹ï¼ˆç´¢å¼•0ï¼‰
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX = rootX;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY = rootY;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ = rootZ;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR = rootRadius;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // è·Ÿéšè·¯å¾„åˆ°å¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = childListIndex(currentNodeIndex, childIndex);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR *= 0.5;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX += ((childIndex &amp;amp; 1) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY += ((childIndex &amp;amp; 2) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ += ((childIndex &amp;amp; 4) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> child = childList[currentNodeIndex];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth++;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //ä¸‹é¢è¿™ä¸ªwhileå¾ªç¯æ˜¯ä¸ºäº†å¯»æ‰¾å¶å­èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> while (child == NODE)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šåœ¨æ–°èŠ‚ç‚¹ä¸­çš„å­èŠ‚ç‚¹ç´¢å¼•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // è·Ÿéšè·¯å¾„åˆ°å¶èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNodeIndex = childListIndex(currentNodeIndex, childIndex);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentR *= 0.5;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentX += ((childIndex &amp;amp; 1) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentY += ((childIndex &amp;amp; 2) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentZ += ((childIndex &amp;amp; 4) ? currentR : -currentR);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> child = childList[currentNodeIndex];
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> depth++;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ’å…¥ç²’å­åˆ°å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //ä¸‰ç§æƒ…å†µï¼š
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //1.å½“å‰å¶å­èŠ‚ç‚¹è¢«å ç”¨ï¼Œé‚£ä¹ˆé‡è¯•
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //2.å½“å‰å¶å­èŠ‚ç‚¹ä¸ºç©ºï¼Œè¿™æ˜¯æœ€ç®€å•çš„æƒ…å†µï¼Œç›´æ¥æ’å…¥å³å¯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //3.å½“å‰å¶å­èŠ‚ç‚¹è¢«ç²’å­å ç”¨ï¼Œæœ¬çº¿ç¨‹è¯»å–oldèŠ‚ç‚¹ä¿¡æ¯ï¼Œå¯¹ä»–ä»¬ä¸¤ä¸ªèŠ‚ç‚¹è¿›è¡Œç»†åˆ†ï¼Œç›´åˆ°ä»–ä»¬è¢«åˆ†å±åˆ°ä¸åŒçš„è±¡é™
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child != LOCKED)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> lockedIndex = currentNodeIndex;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child == atomicCAS((int *)&amp;amp;childList[lockedIndex], child, LOCKED))
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (child == EMPTY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç›´æ¥æ’å…¥ç²’å­
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[lockedIndex] = i;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //æ­¤å¤„å¤„ç†ä¸¤ä¸ªèŠ‚ç‚¹ç»†åˆ†çš„æƒ…å½¢
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //è¿™ä¸ªå¾ªç¯å°è¯•ç»†åˆ†ï¼Œç›´åˆ°ä»–ä»¬ä¿©è¢«åˆ†å¼€åˆ°ä¸åŒçš„è±¡é™
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> do
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šå·²å­˜åœ¨ç²’å­åœ¨æ–°èŠ‚ç‚¹ä¸­çš„ä½ç½®
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int childNewIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (oldParPos.z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childNewIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®å®šå½“å‰ç²’å­åœ¨æ–°èŠ‚ç‚¹ä¸­çš„ä½ç½®
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> int currentNewIndex = 0;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (x &amp;gt; currentX)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex = 1;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (y &amp;gt; currentY)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex += 2;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (z &amp;gt; currentZ)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> currentNewIndex += 4;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> if (childNewIndex != currentNewIndex)
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä¸¤ä¸ªç²’å­åœ¨ä¸åŒå­èŠ‚ç‚¹ï¼Œå¯ä»¥æ’å…¥
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[childListIndex(currentNodeIndex, childNewIndex)] = child;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[childListIndex(currentNodeIndex, currentNewIndex)] = i;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> isInsert = true;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> break; // é€€å‡ºå¾ªç¯
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> else
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> {
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ä»åœ¨åŒä¸€å­èŠ‚ç‚¹ï¼Œéœ€è¦ç»§ç»­ç»†åˆ†
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // æ³¨æ„æ¯æ¬¡ç»†åˆ†éƒ½ä¼šåˆ›å»ºæ–°èŠ‚ç‚¹ï¼Œéœ€è¦ä¿å­˜èŠ‚ç‚¹çš„åŒ…å›´ç›’ä¿¡æ¯ ç”¨äºé¢†åŸŸæœç´¢
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // // å†™å…¥æ–°èŠ‚ç‚¹çš„ä¸­å¿ƒå’ŒåŠå¾„
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].x = currentX;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].y = currentY;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].z = currentZ;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> nodePositions[currentNodeIndex].w = currentR;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[currentNodeIndex] = NODE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // å†…å­˜åŒæ­¥ï¼Œä¿è¯æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥çœ‹åˆ°æœ‰æ–°çš„èŠ‚ç‚¹è¢«å†™å…¥äº†
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __threadfence();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> } while (true);
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> // ç¡®ä¿æ‰€æœ‰å­æ ‘çš„å†™å…¥å®Œæˆ
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> __threadfence();
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> //é‡Šæ”¾é”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> childList[lockedIndex] = NODE;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> i += inc;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> }
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>[1] Burtscher, Martin, and Keshav Pingali. &amp;ldquo;An efficient CUDA implementation of the tree-based barnes hut n-body algorithm.&amp;rdquo; &lt;em>GPU computing Gems Emerald edition&lt;/em>. Morgan Kaufmann, 2011. 75-92.&lt;/p></description></item></channel></rss>